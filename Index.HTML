<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fade Out - Screenplay Editor</title>
  <style>
    /* Dark Theme & Typography */
    body {
      background-color: #1c0f2e;
      color: white;
      font-family: Courier, monospace;
      margin: 0;
      padding: 0;
    }
    
    body.light {
      background-color: #f8f8f8;
      color: #000000;
    }

    /* App Header */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #1c0f2e;
      color: white;
      text-align: center;
      padding: 10px 0;
      z-index: 1000;
      border-bottom: 1px solid #472e63;
      direction: ltr; /* Force LTR for header */
    }
    
    .app-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .tagline {
      font-size: 14px;
      opacity: 0.8;
    }

    /* Toolbar */
    .toolbar {
      position: fixed;
      top: 70px; /* Below header */
      left: 0;
      right: 0;
      background-color: #2a1240;
      border-bottom: 2px solid #472e63;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      z-index: 999;
      gap: 5px;
    }

    /* Toolbar Groups */
    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    /* Editor */
    #editor {
      padding: 130px 20px 20px 20px;
      outline: none;
      white-space: pre-wrap;
      min-height: 80vh;
    }

    /* RTL Fixes */
    body[dir="rtl"] .toolbar {
      direction: rtl;
    }
    
    body[dir="rtl"] .toolbar button {
      float: right;
    }
    
    .rtl {
      direction: rtl;
    }

    /* Element Styles */
    .element { margin: 0; padding: 2px 0; }
    .scene-heading { text-transform: uppercase; margin: 12px 0; text-align: left; font-weight: bold; }
    .action { text-align: left; margin: 12px 0; }
    .character { text-align: center; margin: 30px auto 10px auto; width: 60%; font-weight: bold; text-transform: uppercase; }
    .dialogue { text-align: left; margin: 0 auto 15px auto; width: 70%; }
    .parenthetical { font-style: italic; margin: 0 auto 10px auto; width: 50%; text-align: center; }
    .transition { text-align: right; margin-right: 10%; font-weight: bold; text-transform: uppercase; }
    .active-line { background-color: rgba(255, 215, 0, 0.1); }

    body.light .toolbar {
      background-color: #e3e3e3;
      border-bottom: 2px solid #cccccc;
    }

    .toolbar button {
      background-color: #472e63;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 3px;
      min-width: 100px;
    }

    body.light .toolbar button {
      background-color: #dddddd;
      color: #000000;
    }

    .toolbar button.active {
      background-color: #6b458e;
    }

    /* Character suggestions */
    #character-suggestions {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }

    body.light #character-suggestions {
      background-color: #e3e3e3;
      border: 1px solid #000000;
    }

    .character-suggestion-item {
      padding: 5px 10px;
      cursor: pointer;
    }

    .character-suggestion-item:hover {
      background-color: #472e63;
    }

    body.light .character-suggestion-item:hover {
      background-color: #cccccc;
    }

    /* Notification */
    #notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: gold;
      color: #1c0f2e;
      padding: 10px 20px;
      border-radius: 3px;
      display: none;
      z-index: 100;
    }

    /* Modals */
    .modal-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .modal {
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 5px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
    }

    body.light .modal {
      background-color: #f8f8f8;
      border: 1px solid #000000;
    }

    .modal h2 {
      margin-top: 0;
      color: gold;
    }

    body.light .modal h2 {
      color: #000000;
    }

    .modal input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    body.light .modal input {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .cancel-btn {
      background: none;
      border: 1px solid gold;
      color: gold;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    .confirm-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    body.light .cancel-btn {
      border: 1px solid #000000;
      color: #000000;
    }

    body.light .confirm-btn {
      background-color: #000000;
      color: white;
    }

    /* Feedback box */
    #feedback-box {
      display: none;
      margin: 10px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    #feedback-text {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    body.light #feedback-text {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    #send-feedback-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 3px;
    }

    body.light #send-feedback-btn {
      background-color: #000000;
      color: white;
    }
    
    /* Transition dropdown */
    #transition-dropdown {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 250px;
      width: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .transition-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .transition-item:hover {
      background-color: #472e63;
    }
    
    body.light #transition-dropdown {
      background-color: #f8f8f8;
      border: 1px solid #000;
    }
    
    body.light .transition-item:hover {
      background-color: #ddd;
    }
  </style>
</head>
<body class="dark-mode">
  <!-- Header -->
  <div class="app-header">
    <div class="app-name">Fade Out</div>
    <div class="tagline">Write. Rewrite. Fade Out.</div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div>
      <button id="title-page-btn">TITLE PAGE</button>
      <button id="scene-heading-btn" class="element-button active" data-type="scene-heading">SCENE HEADING</button>
      <button id="action-btn" class="element-button" data-type="action">ACTION</button>
      <button id="character-btn" class="element-button" data-type="character">CHARACTER</button>
      <button id="dialogue-btn" class="element-button" data-type="dialogue">DIALOGUE</button>
      <button id="parenthetical-btn" class="element-button" data-type="parenthetical">PARENTHETICAL</button>
      <button id="transition-btn" class="element-button" data-type="transition">TRANSITION</button>
    </div>
    <div>
      <button id="save-btn">SAVE</button>
      <button id="load-btn">LOAD</button>
      <button id="export-btn">EXPORT</button>
      <button id="theme-toggle">LIGHT</button>
      <button id="rtl-toggle">ARABIC</button>
      <button id="feedback-btn">FEEDBACK</button>
    </div>
  </div>

  <!-- Title Page -->
  <div id="title-page" style="display: none; padding: 180px 20px 20px 20px; text-align: center;">
    <div style="max-width: 800px; margin: 0 auto;">
      <div style="font-size: 28px; font-weight: bold; margin-bottom: 40px;">
        <input type="text" id="script-title" placeholder="TITLE OF SCRIPT" style="width: 100%; text-align: center; background: transparent; border: none; border-bottom: 1px solid gold; color: inherit; font-family: inherit; font-size: inherit;">
      </div>
      <div style="font-size: 20px; margin-bottom: 60px;">
        <input type="text" id="written-by" placeholder="Written by" style="width: 100%; text-align: center; background: transparent; border: none; border-bottom: 1px solid gold; color: inherit; font-family: inherit; font-size: inherit;">
      </div>
      <div style="font-size: 16px; margin-top: 100px;">
        <input type="text" id="contact-email" placeholder="Email" style="width: 100%; text-align: center; background: transparent; border: none; border-bottom: 1px solid gold; color: inherit; font-family: inherit; font-size: inherit;">
        <input type="text" id="contact-phone" placeholder="Phone" style="width: 100%; text-align: center; background: transparent; border: none; border-bottom: 1px solid gold; color: inherit; font-family: inherit; font-size: inherit;">
      </div>
      <div style="margin-top: 20px;">
        <textarea id="awards" placeholder="Accolades/Awards" rows="3" style="width: 100%; text-align: center; background: transparent; border: none; border-bottom: 1px solid gold; color: inherit; font-family: inherit; font-size: inherit;"></textarea>
      </div>
      <div style="font-size: 12px; margin-top: 120px;">
        All copyrights reserved
      </div>
      <button id="start-writing-btn" style="margin-top: 20px; background-color: #472e63; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 3px;">START WRITING</button>
    </div>
  </div>

  <!-- Editor -->
  <div id="editor" class="ltr" contenteditable="true" spellcheck="true" style="display: none;"></div>

  <!-- Character suggestions -->
  <div id="character-suggestions"></div>
  
  <!-- Transition dropdown -->
  <div id="transition-dropdown">
    <div class="transition-item" data-text="CUT TO:">CUT TO:</div>
    <div class="transition-item" data-text="FADE IN:">FADE IN:</div>
    <div class="transition-item" data-text="FADE OUT:">FADE OUT:</div>
    <div class="transition-item" data-text="FADE TO BLACK">FADE TO BLACK</div>
    <div class="transition-item" data-text="DISSOLVE TO:">DISSOLVE TO:</div>
    <div class="transition-item" data-text="SMASH CUT TO:">SMASH CUT TO:</div>
    <div class="transition-item" data-text="MATCH CUT TO:">MATCH CUT TO:</div>
    <div class="transition-item" data-text="INTERCUT WITH:">INTERCUT WITH:</div>
    <div class="transition-item" data-text="BACK TO:">BACK TO:</div>
    <div class="transition-item" data-text="THE END">THE END</div>
  </div>
  
  <!-- Notification -->
  <div id="notification">Notification Message</div>
  
  <!-- Feedback box -->
  <div id="feedback-box">
    <textarea id="feedback-text" placeholder="Enter your feedback here..."></textarea>
    <button id="send-feedback-btn">Send Feedback</button>
  </div>
  
  <!-- Save Modal -->
  <div class="modal-container" id="save-modal-container">
    <div class="modal">
      <h2>Save Script</h2>
      <input type="text" id="save-script-title" placeholder="Script Title">
      <div class="modal-buttons">
        <button class="cancel-btn" id="save-cancel">Cancel</button>
        <button class="confirm-btn" id="save-confirm">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Load Modal -->
  <div class="modal-container" id="load-modal-container">
    <div class="modal">
      <h2>Load Script</h2>
      <div id="saved-scripts-list" style="max-height: 200px; overflow-y: auto; margin: 10px 0;"></div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="load-cancel">Cancel</button>
        <button class="confirm-btn" id="load-confirm">Load</button>
      </div>
    </div>
  </div>
  
  <!-- Export Modal -->
  <div class="modal-container" id="export-modal-container">
    <div class="modal">
      <h2>Export Script</h2>
      <select id="export-format" style="width: 100%; padding: 8px; margin: 10px 0; border-radius: 3px; border: 1px solid gold; background-color: rgba(255, 255, 255, 0.1); color: white;">
        <option value="pdf">PDF</option>
        <option value="fdx">Final Draft (FDX)</option>
        <option value="html">HTML</option>
      </select>
      <div class="modal-buttons">
        <button class="cancel-btn" id="export-cancel">Cancel</button>
        <button class="confirm-btn" id="export-confirm">Export</button>
      </div>
    </div>
  </div>

  <script>
    // Arabic translations
    const arabicLabels = {
      'SCENE HEADING': 'العنوان الرئيسي',
      'ACTION': 'الفعل',
      'CHARACTER': 'الشخصية',
      'DIALOGUE': 'الحوار',
      'PARENTHETICAL': 'توضيح',
      'TRANSITION': 'الانتقال',
      'TITLE PAGE': 'صفحة العنوان',
      'SAVE': 'حفظ',
      'LOAD': 'تحميل',
      'EXPORT': 'تصدير',
      'FEEDBACK': 'تعليق',
      'ARABIC': 'English',
      'ENGLISH': 'عربي',
      'LIGHT': 'مضيء',
      'DARK': 'مظلم'
    };

    // Global state
    let currentElement = 'scene-heading';
    let isRtlMode = false;
    let scriptCharacters = new Set();
    let undoStack = [];
    let redoStack = [];
    let isUndoing = false;

    // Initialize the editor
    document.addEventListener('DOMContentLoaded', function() {
      // Show title page first
      document.getElementById('title-page').style.display = 'block';
      document.getElementById('script-title').focus();
      
      // Set up event listeners
      setupListeners();
    });

    function setupListeners() {
      const editor = document.getElementById('editor');
      const notification = document.getElementById('notification');
      
      // Start writing button
      document.getElementById('start-writing-btn').addEventListener('click', function() {
        document.getElementById('title-page').style.display = 'none';
        document.getElementById('editor').style.display = 'block';
        addNewElement('scene-heading');
      });
      
      // Title page button
      document.getElementById('title-page-btn').addEventListener('click', function() {
        document.getElementById('title-page').style.display = 'block';
        document.getElementById('editor').style.display = 'none';
      });

      // Element type buttons
      document.querySelectorAll('.element-button').forEach(btn => {
        btn.addEventListener('click', function() {
          currentElement = this.dataset.type;
          document.querySelectorAll('.element-button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          addNewElement(currentElement);
        });
      });
      
      // Action buttons
      document.getElementById('save-btn').addEventListener('click', saveScript);
      document.getElementById('load-btn').addEventListener('click', loadScript);
      document.getElementById('export-btn').addEventListener('click', showExportModal);
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      document.getElementById('rtl-toggle').addEventListener('click', toggleDirection);
      document.getElementById('feedback-btn').addEventListener('click', toggleFeedback);
      
      // Modal buttons
      document.getElementById('save-cancel').addEventListener('click', () => {
        document.getElementById('save-modal-container').style.display = 'none';
      });
      
      document.getElementById('save-confirm').addEventListener('click', () => {
        const title = document.getElementById('save-script-title').value.trim() || 'Untitled Script';
        const content = editor.innerHTML;
        
        // Save to localStorage
        const scripts = JSON.parse(localStorage.getItem('scripts') || '{}');
        scripts[title] = {
          content,
          characters: Array.from(scriptCharacters),
          timestamp: Date.now()
        };
        localStorage.setItem('scripts', JSON.stringify(scripts));
        
        document.getElementById('save-modal-container').style.display = 'none';
        showNotification(`Script "${title}" saved successfully`);
      });
      
      document.getElementById('load-cancel').addEventListener('click', () => {
        document.getElementById('load-modal-container').style.display = 'none';
      });
      
      document.getElementById('load-confirm').addEventListener('click', () => {
        const selected = document.querySelector('.saved-script-item.selected');
        if (!selected) {
          showNotification('Please select a script to load');
          return;
        }
        
        const scriptName = selected.getAttribute('data-name');
        const scripts = JSON.parse(localStorage.getItem('scripts') || '{}');
        
        if (scripts[scriptName]) {
          editor.innerHTML = scripts[scriptName].content;
          if (scripts[scriptName].characters) {
            scriptCharacters = new Set(scripts[scriptName].characters);
          }
          
          document.getElementById('load-modal-container').style.display = 'none';
          showNotification(`Script "${scriptName}" loaded successfully`);
        }
      });
      
      document.getElementById('export-cancel').addEventListener('click', () => {
        document.getElementById('export-modal-container').style.display = 'none';
      });
      
      document.getElementById('export-confirm').addEventListener('click', () => {
        const format = document.getElementById('export-format').value;
        exportScript(format);
      });
      
      document.getElementById('send-feedback-btn').addEventListener('click', () => {
        const feedbackText = document.getElementById('feedback-text').value.trim();
        if (!feedbackText) {
          showNotification('Please enter your feedback');
          return;
        }
        
        const mailtoLink = `mailto:Adam.st@yahoo.com?subject=Fade%20Out%20Feedback&body=${encodeURIComponent(feedbackText)}`;
        window.location.href = mailtoLink;
        showNotification('Feedback sent!');
        document.getElementById('feedback-text').value = '';
        document.getElementById('feedback-box').style.display = 'none';
      });
      
      // Editor events
      editor.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          handleEnterKey();
        } else if (e.key === 'Tab') {
          e.preventDefault();
          cycleElementType();
        } else if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          undo();
        } else if (e.ctrlKey && e.key === 'y') {
          e.preventDefault();
          redo();
        }
      });
      
      editor.addEventListener('click', function(e) {
        const target = e.target;
        if (target === editor) return;
        
        let element = target;
        while (element && element !== editor && !element.classList.contains('element')) {
          element = element.parentNode;
        }
        
        if (element && element !== editor) {
          document.querySelectorAll('#editor .element').forEach(el => el.classList.remove('active-line'));
          element.classList.add('active-line');
          
          const elementClasses = element.className.split(' ');
          for (const cls of elementClasses) {
            if (['scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition'].includes(cls)) {
              currentElement = cls;
              break;
            }
          }
          
          updateActiveButton();
        }
      });

      editor.addEventListener('input', function(e) {
        const activeElement = document.querySelector('.active-line');
        if (!activeElement) return;
        
        const type = activeElement.classList.contains('character') ? 'character' :
                    activeElement.classList.contains('scene-heading') ? 'scene-heading' :
                    activeElement.classList.contains('transition') ? 'transition' : null;
        
        if (type === 'scene-heading' || type === 'character' || type === 'transition') {
          const selection = window.getSelection();
          if (!selection || selection.rangeCount === 0) return;
          
          const range = selection.getRangeAt(0);
          const cursorPosition = range.startOffset;
          const originalText = activeElement.textContent || '';
          activeElement.textContent = originalText.toUpperCase();
          
          const newRange = document.createRange();
          if (activeElement.firstChild) {
            newRange.setStart(activeElement.firstChild, Math.min(cursorPosition, activeElement.textContent.length));
          } else {
            newRange.setStart(activeElement, 0);
          }
          newRange.collapse(true);
          selection.removeAllRanges();
          selection.addRange(newRange);
        }
        
        if (type === 'character') {
          const text = activeElement.textContent?.trim().toUpperCase() || '';
          if (text.length > 0) {
            showCharacterSuggestions(text, activeElement);
          } else {
            hideCharacterSuggestions();
          }
        }
        
        saveState();
      });
      
      // Transition dropdown items
      document.querySelectorAll('.transition-item').forEach(item => {
        item.addEventListener('click', function() {
          const activeElement = document.querySelector('.active-line');
          if (activeElement && activeElement.classList.contains('transition')) {
            activeElement.textContent = this.dataset.text;
            hideTransitionDropdown();
            setCaretToEnd(activeElement);
            saveState();
          }
        });
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#character-suggestions') && !e.target.closest('.character')) {
          hideCharacterSuggestions();
        }
        
        if (!e.target.closest('#transition-dropdown') && !e.target.closest('.transition')) {
          hideTransitionDropdown();
        }
      });
    }

    // Add a new screenplay element
    function addNewElement(type, text = '') {
      const editor = document.getElementById('editor');
      const div = document.createElement('div');
      div.className = `element ${type}`;
      div.id = `element-${Date.now()}`;
      
      if (isRtlMode) {
        div.setAttribute('dir', 'rtl');
        div.setAttribute('lang', 'ar');
        
        if (type === 'scene-heading' || type === 'action') {
          div.style.textAlign = 'right';
        } else if (type === 'transition') {
          div.style.textAlign = 'left';
        }
      } else {
        if (type === 'transition') {
          div.style.textAlign = 'right';
        }
      }
      
      if (type === 'scene-heading' && !text) {
        div.textContent = isRtlMode ? '.INT ' : 'INT. ';
      } else if (type === 'parenthetical' && !text) {
        div.textContent = '()';
      } else if (text) {
        div.textContent = text;
      } else {
        div.innerHTML = '&nbsp;';
      }
      
      const activeElement = document.querySelector('.active-line');
      if (activeElement) {
        activeElement.classList.remove('active-line');
        activeElement.after(div);
      } else {
        editor.appendChild(div);
      }
      
      div.classList.add('active-line');
      setCaretToEnd(div);
      
      if (type === 'character') {
        div.addEventListener('input', function() {
          const text = this.textContent?.trim().toUpperCase() || '';
          if (text.length > 0) {
            showCharacterSuggestions(text, this);
          } else {
            hideCharacterSuggestions();
          }
        });
      }
      
      if (type === 'transition') {
        div.addEventListener('click', function(e) {
          showTransitionDropdown(this);
        });
      }
      
      saveState();
    }

    // Handle Enter key presses
    function handleEnterKey() {
      const activeElement = document.querySelector('.active-line');
      if (!activeElement) return;
      
      let type = null;
      const classes = activeElement.className.split(' ');
      for (const cls of classes) {
        if (['scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition'].includes(cls)) {
          type = cls;
          break;
        }
      }
      
      if (!type) return;
      
      let nextType = 'action';
      
      if (type === 'scene-heading') nextType = 'action';
      else if (type === 'action') nextType = 'action';
      else if (type === 'character') {
        const text = activeElement.textContent.trim();
        if (text) {
          nextType = 'dialogue';
          scriptCharacters.add(text);
        } else {
          nextType = 'character';
        }
      }
      else if (type === 'dialogue') nextType = 'character';
      else if (type === 'parenthetical') nextType = 'dialogue';
      else if (type === 'transition') nextType = 'scene-heading';
      
      addNewElement(nextType);
      currentElement = nextType;
      updateActiveButton();
    }

    // Cycle through element types with Tab key
    function cycleElementType() {
      const activeElement = document.querySelector('.active-line');
      if (!activeElement) return;
      
      let type = null;
      const classes = activeElement.className.split(' ');
      for (const cls of classes) {
        if (['scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition'].includes(cls)) {
          type = cls;
          break;
        }
      }
      
      if (!type) return;
      
      let nextType = 'action';
      
      if (type === 'scene-heading') nextType = 'action';
      else if (type === 'action') nextType = 'character';
      else if (type === 'character') nextType = 'parenthetical';
      else if (type === 'parenthetical') nextType = 'dialogue';
      else if (type === 'dialogue') nextType = 'character';
      else if (type === 'transition') nextType = 'scene-heading';
      
      activeElement.classList.remove(type);
      activeElement.classList.add(nextType);
      
      if (nextType === 'scene-heading' && (activeElement.textContent.trim() === '' || activeElement.textContent === '\u00A0')) {
        activeElement.textContent = isRtlMode ? '.INT ' : 'INT. ';
      } else if (nextType === 'parenthetical' && (activeElement.textContent.trim() === '' || activeElement.textContent === '\u00A0')) {
        activeElement.textContent = '()';
      }
      
      if (isRtlMode) {
        if (nextType === 'scene-heading' || nextType === 'action') {
          activeElement.style.textAlign = 'right';
        } else if (nextType === 'transition') {
          activeElement.style.textAlign = 'left';
        } else {
          activeElement.style.textAlign = '';
        }
      } else {
        if (nextType === 'transition') {
          activeElement.style.textAlign = 'right';
        } else {
          activeElement.style.textAlign = '';
        }
      }
      
      currentElement = nextType;
      updateActiveButton();
    }

    // Update active button in toolbar
    function updateActiveButton() {
      document.querySelectorAll('.element-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const activeButton = document.querySelector(`.element-button[data-type="${currentElement}"]`);
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }

    // Place cursor at the end of an element
    function setCaretToEnd(el) {
      if (!el) return;
      
      el.focus();
      const range = document.createRange();
      if (el.firstChild) {
        range.setStart(el.firstChild, el.firstChild.textContent.length);
      } else {
        range.setStart(el, 0);
      }
      range.collapse(true);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
    }

    // Show character suggestions dropdown
    function showCharacterSuggestions(text, element) {
      if (!text) return;
      
      const characterSuggestions = document.getElementById('character-suggestions');
      if (!characterSuggestions) return;
      
      const matches = Array.from(scriptCharacters).filter(char => 
        char.includes(text) && char !== text
      );
      
      if (matches.length > 0) {
        characterSuggestions.innerHTML = '';
        const rect = element.getBoundingClientRect();
        characterSuggestions.style.top = `${rect.bottom + window.scrollY}px`;
        characterSuggestions.style.left = `${rect.left + window.scrollX}px`;
        characterSuggestions.style.display = 'block';
        
        matches.forEach(char => {
          const item = document.createElement('div');
          item.className = 'character-suggestion-item';
          item.textContent = char;
          item.addEventListener('click', () => {
            element.textContent = char;
            hideCharacterSuggestions();
            addNewElement('dialogue');
          });
          characterSuggestions.appendChild(item);
        });
      } else {
        hideCharacterSuggestions();
      }
    }

    // Hide character suggestions
    function hideCharacterSuggestions() {
      const characterSuggestions = document.getElementById('character-suggestions');
      if (characterSuggestions) {
        characterSuggestions.style.display = 'none';
      }
    }

    // Show transition dropdown
    function showTransitionDropdown(element) {
      const dropdown = document.getElementById('transition-dropdown');
      if (!dropdown) return;
      
      const rect = element.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.display = 'block';
      
      setTimeout(() => {
        document.addEventListener('click', hideTransitionDropdownOnClickOutside);
      }, 10);
    }

    // Hide transition dropdown
    function hideTransitionDropdown() {
      const dropdown = document.getElementById('transition-dropdown');
      if (dropdown) {
        dropdown.style.display = 'none';
      }
      document.removeEventListener('click', hideTransitionDropdownOnClickOutside);
    }

    // Hide dropdown when clicking outside
    function hideTransitionDropdownOnClickOutside(e) {
      const dropdown = document.getElementById('transition-dropdown');
      if (!dropdown.contains(e.target)) {
        hideTransitionDropdown();
      }
    }

    // Save script
    function saveScript() {
      const saveModal = document.getElementById('save-modal-container');
      if (saveModal) {
        saveModal.style.display = 'flex';
        document.getElementById('save-script-title').value = '';
        document.getElementById('save-script-title').focus();
      }
    }

    // Load script
    function loadScript() {
      const loadModal = document.getElementById('load-modal-container');
      const scriptsList = document.getElementById('saved-scripts-list');
      
      if (loadModal && scriptsList) {
        scriptsList.innerHTML = '';
        const scripts = JSON.parse(localStorage.getItem('scripts') || '{}');
        
        if (Object.keys(scripts).length === 0) {
          scriptsList.innerHTML = '<div style="padding: 10px;">No saved scripts found</div>';
        } else {
          const sortedScripts = Object.entries(scripts).sort((a, b) => b[1].timestamp - a[1].timestamp);
          
          sortedScripts.forEach(([name, data]) => {
            const item = document.createElement('div');
            item.className = 'saved-script-item';
            item.setAttribute('data-name', name);
            
            const nameElement = document.createElement('strong');
            nameElement.textContent = name;
            
            const dateElement = document.createElement('small');
            dateElement.textContent = new Date(data.timestamp).toLocaleString();
            
            item.appendChild(nameElement);
            item.appendChild(document.createElement('br'));
            item.appendChild(dateElement);
            item.style.padding = '8px';
            item.style.margin = '5px 0';
            item.style.cursor = 'pointer';
            item.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
            
            item.addEventListener('click', function() {
              document.querySelectorAll('.saved-script-item').forEach(el => {
                el.classList.remove('selected');
                el.style.backgroundColor = '';
              });
              this.classList.add('selected');
              this.style.backgroundColor = 'rgba(255, 215, 0, 0.2)';
            });
            
            scriptsList.appendChild(item);
          });
        }
        
        loadModal.style.display = 'flex';
      }
    }

    // Show export modal
    function showExportModal() {
      document.getElementById('export-modal-container').style.display = 'flex';
    }

    // Export script
    function exportScript(format) {
      const title = document.getElementById('script-title').value.trim() || 'Untitled Script';
      const content = document.getElementById('editor').innerHTML;
      
      document.getElementById('export-modal-container').style.display = 'none';
      
      if (format === 'html') {
        const exportHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title><style>body{font-family:Courier,monospace;line-height:1.5;margin:40px}.scene-heading{text-transform:uppercase;font-weight:bold;margin-top:2em}.action{margin:1em 0}.character{text-transform:uppercase;margin-left:200px;margin-bottom:0}.parenthetical{margin-left:160px;margin-bottom:0}.dialogue{margin-left:100px;margin-right:100px;margin-bottom:1em}.transition{text-align:right;text-transform:uppercase;margin:2em 0}</style></head><body><h1>${title}</h1><div id="screenplay">${content}</div></body></html>`;
        
        const blob = new Blob([exportHtml], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } else {
        showNotification(`${format.toUpperCase()} export would be implemented in a full version`);
      }
      
      showNotification(`Script exported as ${format.toUpperCase()} successfully!`);
    }

    // Toggle theme
    function toggleTheme() {
      document.body.classList.toggle('light');
      const themeToggle = document.getElementById('theme-toggle');
      themeToggle.textContent = document.body.classList.contains('light') ? 
        (isRtlMode ? arabicLabels['DARK'] : 'DARK') : 
        (isRtlMode ? arabicLabels['LIGHT'] : 'LIGHT');
    }

    // Toggle direction (RTL for Arabic)
    function toggleDirection() {
      const dirToggle = document.getElementById('rtl-toggle');
      const elements = document.querySelectorAll('#editor .element');
      
      isRtlMode = !isRtlMode;
      
      if (isRtlMode) {
        editor.classList.add('rtl');
        editor.classList.remove('ltr');
        dirToggle.textContent = arabicLabels['ARABIC'];
        
        elements.forEach(el => {
          el.setAttribute('dir', 'rtl');
          el.setAttribute('lang', 'ar');
        });
        
        updateToolbarLabels(true);
      } else {
        editor.classList.remove('rtl');
        editor.classList.add('ltr');
        dirToggle.textContent = 'ARABIC';
        
        elements.forEach(el => {
          el.removeAttribute('dir');
          el.removeAttribute('lang');
        });
        
        updateToolbarLabels(false);
      }
    }

    // Update toolbar labels based on language
    function updateToolbarLabels(useArabic) {
      document.querySelectorAll('.element-button').forEach(btn => {
        const type = btn.dataset.type;
        btn.textContent = useArabic ? arabicLabels[type.replace('-', ' ').toUpperCase()] : type.replace('-', ' ').toUpperCase();
      });
      
      document.getElementById('title-page-btn').textContent = useArabic ? arabicLabels['TITLE PAGE'] : 'TITLE PAGE';
      document.getElementById('save-btn').textContent = useArabic ? arabicLabels['SAVE'] : 'SAVE';
      document.getElementById('load-btn').textContent = useArabic ? arabicLabels['LOAD'] : 'LOAD';
      document.getElementById('export-btn').textContent = useArabic ? arabicLabels['EXPORT'] : 'EXPORT';
      document.getElementById('feedback-btn').textContent = useArabic ? arabicLabels['FEEDBACK'] : 'FEEDBACK';
      
      const themeToggle = document.getElementById('theme-toggle');
      themeToggle.textContent = document.body.classList.contains('light') ? 
        (useArabic ? arabicLabels['DARK'] : 'DARK') : 
        (useArabic ? arabicLabels['LIGHT'] : 'LIGHT');
    }

    // Toggle feedback box
    function toggleFeedback() {
      const feedbackBox = document.getElementById('feedback-box');
      feedbackBox.style.display = feedbackBox.style.display === 'none' || !feedbackBox.style.display ? 'block' : 'none';
      if (feedbackBox.style.display === 'block') {
        document.getElementById('feedback-text').focus();
      }
    }

    // Show notification
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 2000);
    }

    // Undo/redo functionality
    function saveState() {
      if (!isUndoing) {
        undoStack.push(document.getElementById('editor').innerHTML);
        if (undoStack.length > 50) undoStack.shift();
        redoStack = [];
      }
    }

    function undo() {
      const editor = document.getElementById('editor');
      if (undoStack.length > 0) {
        isUndoing = true;
        redoStack.push(editor.innerHTML);
        editor.innerHTML = undoStack.pop();
        isUndoing = false;
      }
    }

    function redo() {
      const editor = document.getElementById('editor');
      if (redoStack.length > 0) {
        isUndoing = true;
        undoStack.push(editor.innerHTML);
        editor.innerHTML = redoStack.pop();
        isUndoing = false;
      }
    }
  </script>
</body>
</html>
