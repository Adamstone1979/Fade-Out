<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fade Out - Professional Screenplay Editor</title>
  <style>
    /* Dark Theme & Typography */
    body {
      background-color: #1c0f2e;
      color: white;
      font-family: Courier, monospace;
      margin: 0;
      padding: 0;
    }
    
    body.light {
      background-color: #f8f8f8;
      color: #000000;
    }

    /* App Header */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #1c0f2e;
      color: white;
      text-align: center;
      padding: 10px 0;
      z-index: 1000;
      border-bottom: 1px solid #472e63;
      direction: ltr;
    }
    
    .app-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .tagline {
      font-size: 14px;
      opacity: 0.8;
    }

    /* Toolbar */
    .toolbar {
      position: fixed;
      top: 70px;
      left: 0;
      right: 0;
      background-color: #2a1240;
      border-bottom: 2px solid #472e63;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      z-index: 999;
      gap: 5px;
    }

    /* Toolbar Groups */
    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    /* Editor */
    #editor {
      padding: 130px 20px 20px 20px;
      outline: none;
      white-space: pre-wrap;
      min-height: 80vh;
    }

    /* Title Page Styles (Final Draft format) */
    .title-page {
      display: none;
      padding: 180px 20px 20px 20px; /* Extra top padding to avoid toolbar overlap */
      text-align: center;
    }
    
    .title-page-content {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .title-page input, .title-page textarea {
      background: transparent;
      border: none;
      border-bottom: 1px solid gold;
      color: inherit;
      font-family: inherit;
      font-size: inherit;
      text-align: center;
      width: 100%;
      margin: 15px auto;
      padding: 5px;
    }
    
    .title-page .title {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 40px;
    }
    
    .title-page .author {
      font-size: 20px;
      margin-bottom: 60px;
    }
    
    .title-page .contact {
      font-size: 16px;
      margin-top: 100px;
    }
    
    .title-page .copyright {
      font-size: 12px;
      margin-top: 120px;
    }

    /* RTL Fixes */
    body[dir="rtl"] .toolbar {
      direction: rtl;
    }
    
    body[dir="rtl"] .toolbar button {
      float: right;
    }
    
    .rtl {
      direction: rtl;
    }

    /* Element Styles */
    .element { margin: 0; padding: 2px 0; }
    .scene-heading { text-transform: uppercase; margin: 12px 0; text-align: left; font-weight: bold; }
    .action { text-align: left; margin: 12px 0; }
    .character { text-align: center; margin: 30px auto 10px auto; width: 60%; font-weight: bold; text-transform: uppercase; }
    .dialogue { text-align: left; margin: 0 auto 15px auto; width: 70%; }
    .parenthetical { font-style: italic; margin: 0 auto 10px auto; width: 50%; text-align: center; }
    .transition { text-align: right; margin-right: 10%; font-weight: bold; text-transform: uppercase; }
    .active-line { background-color: rgba(255, 215, 0, 0.1); }

    /* Light Mode */
    body.light .toolbar {
      background-color: #e3e3e3;
      border-bottom: 2px solid #cccccc;
    }

    .toolbar button {
      background-color: #472e63;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 3px;
      min-width: 100px;
    }

    body.light .toolbar button {
      background-color: #dddddd;
      color: #000000;
    }

    .toolbar button.active {
      background-color: #6b458e;
    }

    /* Character suggestions */
    #character-suggestions {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }

    body.light #character-suggestions {
      background-color: #e3e3e3;
      border: 1px solid #000000;
    }

    .character-suggestion-item {
      padding: 5px 10px;
      cursor: pointer;
    }

    .character-suggestion-item:hover {
      background-color: #472e63;
    }

    body.light .character-suggestion-item:hover {
      background-color: #cccccc;
    }

    /* Notification */
    #notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: gold;
      color: #1c0f2e;
      padding: 10px 20px;
      border-radius: 3px;
      display: none;
      z-index: 100;
    }

    /* Modals */
    .modal-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .modal {
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 5px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
    }

    body.light .modal {
      background-color: #f8f8f8;
      border: 1px solid #000000;
    }

    .modal h2 {
      margin-top: 0;
      color: gold;
    }

    body.light .modal h2 {
      color: #000000;
    }

    .modal input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    body.light .modal input {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .cancel-btn {
      background: none;
      border: 1px solid gold;
      color: gold;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    .confirm-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    body.light .cancel-btn {
      border: 1px solid #000000;
      color: #000000;
    }

    body.light .confirm-btn {
      background-color: #000000;
      color: white;
    }

    /* Feedback box */
    #feedback-box {
      display: none;
      margin: 10px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    #feedback-text {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    body.light #feedback-text {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    #send-feedback-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 3px;
    }

    body.light #send-feedback-btn {
      background-color: #000000;
      color: white;
    }
    
    /* Transition dropdown */
    #transition-dropdown {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 250px;
      width: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .transition-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .transition-item:hover {
      background-color: #472e63;
    }
    
    body.light #transition-dropdown {
      background-color: #f8f8f8;
      border: 1px solid #000;
    }
    
    body.light .transition-item:hover {
      background-color: #ddd;
    }

    /* Spellcheck Underline */
    .spell-error {
      text-decoration: underline wavy red;
    }

    .grammar-error {
      text-decoration: underline wavy orange;
    }
    
    /* Thesaurus/Dictionary Results */
    .word-result {
      margin-bottom: 15px;
    }
    
    .word-type {
      font-style: italic;
      color: gold;
    }
    
    body.light .word-type {
      color: #000000;
    }
  </style>
</head>
<body class="dark-mode">
  <!-- Header -->
  <div class="app-header">
    <div class="app-name">Fade Out</div>
    <div class="tagline">Write. Rewrite. Fade Out.</div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div>
      <button id="title-page-btn">TITLE PAGE</button>
      <button id="scene-heading-btn" class="element-button" data-type="scene-heading">SCENE HEADING</button>
      <button id="action-btn" class="element-button" data-type="action">ACTION</button>
      <button id="character-btn" class="element-button" data-type="character">CHARACTER</button>
      <button id="dialogue-btn" class="element-button" data-type="dialogue">DIALOGUE</button>
      <button id="parenthetical-btn" class="element-button" data-type="parenthetical">PARENTHETICAL</button>
      <button id="transition-btn" class="element-button" data-type="transition">TRANSITION</button>
    </div>
    <div>
      <button id="undo-btn">UNDO</button>
      <button id="redo-btn">REDO</button>
      <button id="thesaurus-btn">THESAURUS</button>
      <button id="dictionary-btn">DICTIONARY</button>
      <button id="save-btn">SAVE</button>
      <button id="load-btn">LOAD</button>
      <button id="export-btn">EXPORT</button>
      <button id="theme-toggle">LIGHT</button>
      <button id="rtl-toggle">ARABIC</button>
      <button id="feedback-btn">FEEDBACK</button>
    </div>
  </div>

  <!-- Title Page (Final Draft format) -->
  <div id="title-page" class="title-page">
    <div class="title-page-content">
      <div class="title">
        <input type="text" id="script-title" placeholder="TITLE OF SCRIPT">
      </div>
      <div class="author">
        <input type="text" id="written-by" placeholder="Written by">
      </div>
      <div class="contact">
        <input type="text" id="contact-email" placeholder="Email">
        <input type="text" id="contact-phone" placeholder="Phone">
      </div>
      <div>
        <textarea id="awards" placeholder="Accolades/Awards" rows="3"></textarea>
      </div>
      <div class="copyright">
        All copyrights reserved
      </div>
      <button id="start-writing-btn">START WRITING</button>
    </div>
  </div>

  <!-- Editor (Starts blank) -->
  <div id="editor" class="ltr" contenteditable="true" spellcheck="false"></div>

  <!-- Character suggestions -->
  <div id="character-suggestions"></div>
  
  <!-- Transition dropdown -->
  <div id="transition-dropdown">
    <div class="transition-item" data-text="CUT TO:">CUT TO:</div>
    <div class="transition-item" data-text="FADE IN:">FADE IN:</div>
    <div class="transition-item" data-text="FADE OUT:">FADE OUT:</div>
    <div class="transition-item" data-text="FADE TO BLACK">FADE TO BLACK</div>
    <div class="transition-item" data-text="DISSOLVE TO:">DISSOLVE TO:</div>
    <div class="transition-item" data-text="SMASH CUT TO:">SMASH CUT TO:</div>
    <div class="transition-item" data-text="MATCH CUT TO:">MATCH CUT TO:</div>
    <div class="transition-item" data-text="INTERCUT WITH:">INTERCUT WITH:</div>
    <div class="transition-item" data-text="BACK TO:">BACK TO:</div>
    <div class="transition-item" data-text="THE END">THE END</div>
  </div>
  
  <!-- Notification -->
  <div id="notification">Notification Message</div>
  
  <!-- Feedback box -->
  <div id="feedback-box">
    <textarea id="feedback-text" placeholder="Enter your feedback here..."></textarea>
    <button id="send-feedback-btn">Send Feedback</button>
  </div>
  
  <!-- Thesaurus Modal -->
  <div class="modal-container" id="thesaurus-modal-container">
    <div class="modal">
      <h2>Thesaurus</h2>
      <div id="thesaurus-results"></div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="thesaurus-cancel">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Dictionary Modal -->
  <div class="modal-container" id="dictionary-modal-container">
    <div class="modal">
      <h2>Dictionary</h2>
      <div id="dictionary-results"></div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="dictionary-cancel">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ========================
    // INITIALIZATION
    // ========================
    document.addEventListener('DOMContentLoaded', function() {
      // Start with title page
      showTitlePage();
      
      // Initialize editor
      initEditor();
    });

    // ========================
    // CORE EDITOR FUNCTIONALITY
    // ========================
    function initEditor() {
      // Arabic translations
      const arabicLabels = {
        'SCENE HEADING': 'العنوان الرئيسي',
        'ACTION': 'الفعل',
        'CHARACTER': 'الشخصية',
        'DIALOGUE': 'الحوار',
        'PARENTHETICAL': 'توضيح',
        'TRANSITION': 'الانتقال',
        'TITLE PAGE': 'صفحة العنوان',
        'UNDO': 'تراجع',
        'REDO': 'إعادة',
        'THESAURUS': 'المعجم',
        'DICTIONARY': 'القاموس',
        'SAVE': 'حفظ',
        'LOAD': 'تحميل',
        'EXPORT': 'تصدير',
        'FEEDBACK': 'تعليق',
        'ARABIC': 'English',
        'ENGLISH': 'عربي',
        'LIGHT': 'مضيء',
        'DARK': 'مظلم'
      };

      // Global state
      let currentElement = 'scene-heading';
      let isRtlMode = false;
      let scriptCharacters = new Set();
      let undoStack = [];
      let redoStack = [];
      let isUndoing = false;

      // DOM elements
      const editor = document.getElementById('editor');
      const notification = document.getElementById('notification');
      const titlePageBtn = document.getElementById('title-page-btn');

      // Start with blank editor
      editor.innerHTML = '';

      // ========================
      // TITLE PAGE FUNCTIONALITY
      // ========================
      function showTitlePage() {
        document.getElementById('title-page').style.display = 'block';
        document.getElementById('editor').style.display = 'none';
        document.getElementById('script-title').focus();
      }

      function hideTitlePage() {
        document.getElementById('title-page').style.display = 'none';
        document.getElementById('editor').style.display = 'block';
        addNewElement('scene-heading');
      }

      titlePageBtn.addEventListener('click', function() {
        showTitlePage();
      });

      document.getElementById('start-writing-btn').addEventListener('click', function() {
        hideTitlePage();
      });

      // ========================
      // ARABIC/ENGLISH TOGGLE
      // ========================
      document.getElementById('rtl-toggle').addEventListener('click', function() {
        isRtlMode = !isRtlMode;
        
        if (isRtlMode) {
          // Switch to Arabic
          document.body.setAttribute('dir', 'rtl');
          editor.classList.add('rtl');
          editor.classList.remove('ltr');
          this.textContent = arabicLabels['ARABIC'];
          updateToolbarLabels(true);
        } else {
          // Switch to English
          document.body.removeAttribute('dir');
          editor.classList.remove('rtl');
          editor.classList.add('ltr');
          this.textContent = 'ARABIC';
          updateToolbarLabels(false);
        }
      });

      function updateToolbarLabels(useArabic) {
        document.querySelectorAll('.element-button').forEach(btn => {
          const type = btn.dataset.type;
          btn.textContent = useArabic ? arabicLabels[type.replace('-', ' ').toUpperCase()] : type.replace('-', ' ').toUpperCase();
        });
        
        document.getElementById('title-page-btn').textContent = useArabic ? arabicLabels['TITLE PAGE'] : 'TITLE PAGE';
        document.getElementById('undo-btn').textContent = useArabic ? arabicLabels['UNDO'] : 'UNDO';
        document.getElementById('redo-btn').textContent = useArabic ? arabicLabels['REDO'] : 'REDO';
        document.getElementById('thesaurus-btn').textContent = useArabic ? arabicLabels['THESAURUS'] : 'THESAURUS';
        document.getElementById('dictionary-btn').textContent = useArabic ? arabicLabels['DICTIONARY'] : 'DICTIONARY';
        document.getElementById('save-btn').textContent = useArabic ? arabicLabels['SAVE'] : 'SAVE';
        document.getElementById('load-btn').textContent = useArabic ? arabicLabels['LOAD'] : 'LOAD';
        document.getElementById('export-btn').textContent = useArabic ? arabicLabels['EXPORT'] : 'EXPORT';
        document.getElementById('feedback-btn').textContent = useArabic ? arabicLabels['FEEDBACK'] : 'FEEDBACK';
        
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.textContent = document.body.classList.contains('light') ? 
          (useArabic ? arabicLabels['DARK'] : 'DARK') : 
          (useArabic ? arabicLabels['LIGHT'] : 'LIGHT');
      }

      // ========================
      // EDITOR FUNCTIONALITY
      // ========================
      function addNewElement(type, text = '') {
        const div = document.createElement('div');
        div.className = `element ${type}`;
        div.id = `element-${Date.now()}`;
        
        if (isRtlMode) {
          div.setAttribute('dir', 'rtl');
          div.setAttribute('lang', 'ar');
          if (type === 'scene-heading' || type === 'action') {
            div.style.textAlign = 'right';
          } else if (type === 'transition') {
            div.style.textAlign = 'left';
          }
        } else {
          if (type === 'transition') {
            div.style.textAlign = 'right';
          }
        }
        
        if (type === 'scene-heading' && !text) {
          div.textContent = isRtlMode ? '.INT ' : 'INT. ';
        } else if (type === 'parenthetical' && !text) {
          div.textContent = '()';
        } else if (text) {
          div.textContent = text;
        } else {
          div.innerHTML = '&nbsp;';
        }
        
        const activeElement = document.querySelector('.active-line');
        if (activeElement) {
          activeElement.classList.remove('active-line');
          activeElement.after(div);
        } else {
          editor.appendChild(div);
        }
        
        div.classList.add('active-line');
        setCaretToEnd(div);
        
        if (type === 'character') {
          div.addEventListener('input', function() {
            const text = this.textContent?.trim().toUpperCase() || '';
            if (text.length > 0) {
              showCharacterSuggestions(text, this);
            } else {
              hideCharacterSuggestions();
            }
          });
        }
        
        if (type === 'transition') {
          div.addEventListener('click', function(e) {
            showTransitionDropdown(this);
          });
        }
        
        saveState();
      }

      // ========================
      // TRANSITION DROPDOWN
      // ========================
      function showTransitionDropdown(element) {
        const dropdown = document.getElementById('transition-dropdown');
        const rect = element.getBoundingClientRect();
        dropdown.style.top = `${rect.bottom + window.scrollY}px`;
        dropdown.style.left = `${rect.left + window.scrollX}px`;
        dropdown.style.display = 'block';
        
        setTimeout(() => {
          document.addEventListener('click', closeTransitionDropdown);
        }, 10);
      }

      function closeTransitionDropdown(e) {
        const dropdown = document.getElementById('transition-dropdown');
        if (!dropdown.contains(e.target)) {
          dropdown.style.display = 'none';
          document.removeEventListener('click', closeTransitionDropdown);
        }
      }

      document.querySelectorAll('.transition-item').forEach(item => {
        item.addEventListener('click', function() {
          const activeElement = document.querySelector('.active-line');
          if (activeElement && activeElement.classList.contains('transition')) {
            activeElement.textContent = this.dataset.text;
            hideTransitionDropdown();
            setCaretToEnd(activeElement);
            saveState();
          }
        });
      });

      function hideTransitionDropdown() {
        document.getElementById('transition-dropdown').style.display = 'none';
        document.removeEventListener('click', closeTransitionDropdown);
      }

      // ========================
      // UNDO/REDO FUNCTIONALITY
      // ========================
      function saveState() {
        if (!isUndoing) {
          undoStack.push(editor.innerHTML);
          if (undoStack.length > 50) undoStack.shift();
          redoStack = [];
        }
      }

      function undo() {
        if (undoStack.length > 0) {
          isUndoing = true;
          redoStack.push(editor.innerHTML);
          editor.innerHTML = undoStack.pop();
          isUndoing = false;
        }
      }

      function redo() {
        if (redoStack.length > 0) {
          isUndoing = true;
          undoStack.push(editor.innerHTML);
          editor.innerHTML = redoStack.pop();
          isUndoing = false;
        }
      }

      document.getElementById('undo-btn').addEventListener('click', undo);
      document.getElementById('redo-btn').addEventListener('click', redo);

      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          undo();
        } else if (e.ctrlKey && e.key === 'y') {
          e.preventDefault();
          redo();
        }
      });

      // ========================
      // THESAURUS & DICTIONARY
      // ========================
      document.getElementById('thesaurus-btn').addEventListener('click', function() {
        const selection = window.getSelection();
        const word = selection.toString().trim();
        
        if (word) {
          showThesaurus(word);
        } else {
          showNotification(isRtlMode ? 'حدد كلمة أولاً' : 'Select a word first');
        }
      });

      document.getElementById('dictionary-btn').addEventListener('click', function() {
        const selection = window.getSelection();
        const word = selection.toString().trim();
        
        if (word) {
          showDictionary(word);
        } else {
          showNotification(isRtlMode ? 'حدد كلمة أولاً' : 'Select a word first');
        }
      });

      function showThesaurus(word) {
        const modal = document.getElementById('thesaurus-modal-container');
        const results = document.getElementById('thesaurus-results');
        
        // Simulate API call
        setTimeout(() => {
          if (isRtlMode) {
            results.innerHTML = `
              <div class="word-result">
                <h3>مرادفات "${word}"</h3>
                <ul>
                  <li>مرادف</li>
                  <li>بديل</li>
                  <li>مكافئ</li>
                </ul>
                <h3>أضداد</h3>
                <ul>
                  <li>عكس</li>
                  <li>نقيض</li>
                </ul>
              </div>
            `;
          } else {
            results.innerHTML = `
              <div class="word-result">
                <h3>Synonyms for "${word}"</h3>
                <ul>
                  <li>alternative</li>
                  <li>replacement</li>
                  <li>equivalent</li>
                </ul>
                <h3>Antonyms</h3>
                <ul>
                  <li>opposite</li>
                  <li>contrary</li>
                </ul>
              </div>
            `;
          }
          modal.style.display = 'flex';
        }, 300);
      }

      function showDictionary(word) {
        const modal = document.getElementById('dictionary-modal-container');
        const results = document.getElementById('dictionary-results');
        
        // Simulate API call
        setTimeout(() => {
          if (isRtlMode) {
            results.innerHTML = `
              <div class="word-result">
                <h3>تعريف "${word}"</h3>
                <p>كلمة تصف شيئاً ما.</p>
                <h3>أمثلة</h3>
                <p>"استخدمت الكلمة ${word} في جملة."</p>
              </div>
            `;
          } else {
            results.innerHTML = `
              <div class="word-result">
                <h3>Definition of "${word}"</h3>
                <p>A word that represents something.</p>
                <h3>Examples</h3>
                <p>"She used the ${word} in a sentence."</p>
              </div>
            `;
          }
          modal.style.display = 'flex';
        }, 300);
      }

      // Close modals
      document.getElementById('thesaurus-cancel').addEventListener('click', function() {
        document.getElementById('thesaurus-modal-container').style.display = 'none';
      });

      document.getElementById('dictionary-cancel').addEventListener('click', function() {
        document.getElementById('dictionary-modal-container').style.display = 'none';
      });

      // ========================
      // FEEDBACK FUNCTIONALITY
      // ========================
      document.getElementById('feedback-btn').addEventListener('click', function() {
        document.getElementById('feedback-box').style.display = 'block';
        document.getElementById('feedback-text').focus();
      });

      document.getElementById('send-feedback-btn').addEventListener('click', function() {
        const feedbackText = document.getElementById('feedback-text').value.trim();
        
        if (feedbackText) {
          const mailtoLink = `mailto:Adam.st@yahoo.com?subject=Fade%20Out%20Feedback&body=${encodeURIComponent(feedbackText)}`;
          window.location.href = mailtoLink;
          
          showNotification(isRtlMode ? 'تم إرسال التعليقات!' : 'Feedback sent!');
          document.getElementById('feedback-text').value = '';
          document.getElementById('feedback-box').style.display = 'none';
        } else {
          showNotification(isRtlMode ? 'الرجاء إدخال تعليقات' : 'Please enter feedback');
        }
      });

      // ========================
      // UTILITY FUNCTIONS
      // ========================
      function setCaretToEnd(el) {
        el.focus();
        const range = document.createRange();
        if (el.firstChild) {
          range.setStart(el.firstChild, el.firstChild.textContent.length);
        } else {
          range.setStart(el, 0);
        }
        range.collapse(true);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      }

      function showNotification(message) {
        notification.textContent = message;
        notification.style.display = 'block';
        setTimeout(() => {
          notification.style.display = 'none';
        }, 2000);
      }

      // ========================
      // ELEMENT BUTTONS
      // ========================
      document.querySelectorAll('.element-button').forEach(btn => {
        btn.addEventListener('click', function() {
          currentElement = this.dataset.type;
          document.querySelectorAll('.element-button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          addNewElement(currentElement);
        });
      });

      // Theme toggle
      document.getElementById('theme-toggle').addEventListener('click', function() {
        document.body.classList.toggle('light');
        this.textContent = document.body.classList.contains('light') ? 
          (isRtlMode ? arabicLabels['DARK'] : 'DARK') : 
          (isRtlMode ? arabicLabels['LIGHT'] : 'LIGHT');
      });

      // Initialize with blank scene heading
      function startNewScript() {
        editor.innerHTML = '';
        addNewElement('scene-heading');
      }

      // Start writing button
      document.getElementById('start-writing-btn').addEventListener('click', startNewScript);

      // Initialize
      startNewScript();
    }
  </script>
</body>
</html>
