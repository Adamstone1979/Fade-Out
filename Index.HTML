<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screenplay App</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Courier New', Courier, monospace;
            background-color: #f5f5f5;
            overflow: hidden;
        }
        
        #toolbar {
            background-color: #333;
            color: white;
            padding: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 40px;
            box-sizing: border-box;
        }
        
        #toolbar button, #toolbar select {
            padding: 5px 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            cursor: pointer;
        }
        
        #document-container {
            margin-top: 56px;
            padding: 20px;
            height: calc(100vh - 76px);
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        #screenplay-content {
            width: 90%;
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .element {
            margin-bottom: 20px;
            position: relative;
        }
        
        .scene-heading, .action, .character, .dialogue, .parenthetical, .transition {
            min-height: 20px;
            outline: none;
            padding: 2px;
        }
        
        .scene-heading {
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 15%;
            width: 70%;
        }
        
        .action {
            margin-left: 10%;
            width: 80%;
        }
        
        .character {
            margin-left: 40%;
            width: 20%;
            text-transform: uppercase;
        }
        
        .dialogue {
            margin-left: 25%;
            width: 50%;
        }
        
        .parenthetical {
            margin-left: 32%;
            width: 20%;
            font-style: italic;
        }
        
        .transition {
            margin-left: 60%;
            width: 20%;
            text-transform: uppercase;
            text-align: right;
        }
        
        .element-menu {
            position: absolute;
            left: -100px;
            top: 0;
            background: white;
            border: 1px solid #ccc;
            padding: 5px;
            display: none;
            z-index: 100;
        }
        
        .element:hover .element-menu {
            display: block;
        }
        
        .element-menu button {
            display: block;
            width: 100%;
            margin: 2px 0;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            z-index: 1001;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content {
            margin-bottom: 15px;
        }
        
        .modal-buttons {
            text-align: right;
        }
        
        .modal-buttons button {
            margin-left: 10px;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            background: #f0f0f0;
        }
        
        .tab.active {
            background: white;
            border-color: #ccc;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .word-result {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #eee;
        }
        
        #thesaurus-search, #dictionary-search {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        
        #thesaurus-results, #dictionary-results {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .rtl-text {
            direction: rtl;
            text-align: right;
            font-family: 'Arial', sans-serif;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .error {
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <button id="new-btn">New</button>
        <button id="open-btn">Open</button>
        <button id="save-btn">Save</button>
        <button id="print-btn">Print</button>
        <select id="element-select">
            <option value="action">Action</option>
            <option value="scene-heading">Scene Heading</option>
            <option value="character">Character</option>
            <option value="dialogue">Dialogue</option>
            <option value="parenthetical">Parenthetical</option>
            <option value="transition">Transition</option>
        </select>
        <button id="add-element-btn">Add Element</button>
        <button id="thesaurus-btn">Thesaurus</button>
        <button id="dictionary-btn">Dictionary</button>
        <select id="language-select">
            <option value="en">English</option>
            <option value="ar">العربية</option>
        </select>
    </div>
    
    <div id="document-container">
        <div id="screenplay-content" contenteditable="false">
            <!-- Elements will be added here -->
        </div>
    </div>
    
    <!-- Thesaurus Modal -->
    <div id="thesaurus-modal" class="modal">
        <div class="modal-content">
            <div class="tab-container">
                <div class="tab active" data-tab="thesaurus">Thesaurus</div>
                <div class="tab" data-tab="dictionary">Dictionary</div>
            </div>
            
            <div id="thesaurus-tab" class="tab-content active">
                <input type="text" id="thesaurus-search" placeholder="Search for a word..." autocomplete="off">
                <div id="thesaurus-results"></div>
            </div>
            
            <div id="dictionary-tab" class="tab-content">
                <input type="text" id="dictionary-search" placeholder="Search for a word..." autocomplete="off">
                <div id="dictionary-results"></div>
            </div>
        </div>
        <div class="modal-buttons">
            <button id="cancel-thesaurus-btn">Cancel</button>
        </div>
    </div>

    <script>
        // DOM Elements
        const screenplayContent = document.getElementById('screenplay-content');
        const elementSelect = document.getElementById('element-select');
        const addElementBtn = document.getElementById('add-element-btn');
        const thesaurusBtn = document.getElementById('thesaurus-btn');
        const dictionaryBtn = document.getElementById('dictionary-btn');
        const thesaurusModal = document.getElementById('thesaurus-modal');
        const cancelThesaurusBtn = document.getElementById('cancel-thesaurus-btn');
        const thesaurusSearch = document.getElementById('thesaurus-search');
        const dictionarySearch = document.getElementById('dictionary-search');
        const thesaurusResults = document.getElementById('thesaurus-results');
        const dictionaryResults = document.getElementById('dictionary-results');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const languageSelect = document.getElementById('language-select');
        const newBtn = document.getElementById('new-btn');
        const openBtn = document.getElementById('open-btn');
        const saveBtn = document.getElementById('save-btn');
        const printBtn = document.getElementById('print-btn');

        // Current language
        let currentLanguage = 'en';

        // Add New Element
        addElementBtn.addEventListener('click', () => {
            addNewElement(elementSelect.value);
        });

        function addNewElement(elementType, content = '') {
            const element = document.createElement('div');
            element.className = `element ${elementType}`;
            element.contentEditable = 'true';
            
            // Add element menu
            const menu = document.createElement('div');
            menu.className = 'element-menu';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                element.remove();
            });
            
            menu.appendChild(deleteBtn);
            element.appendChild(menu);
            
            // Set placeholder text based on element type
            if (!content) {
                switch(elementType) {
                    case 'scene-heading':
                        element.textContent = 'INT. LOCATION - DAY';
                        break;
                    case 'action':
                        element.textContent = 'Action description goes here...';
                        break;
                    case 'character':
                        element.textContent = 'CHARACTER NAME';
                        break;
                    case 'dialogue':
                        element.textContent = 'Dialogue text goes here...';
                        break;
                    case 'parenthetical':
                        element.textContent = '(parenthetical)';
                        break;
                    case 'transition':
                        element.textContent = 'CUT TO:';
                        break;
                }
            } else {
                element.textContent = content;
            }
            
            screenplayContent.appendChild(element);
            element.focus();
            
            // Place cursor at start
            const range = document.createRange();
            range.selectNodeContents(element);
            range.collapse(true);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // Add Enter key functionality
            element.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newElement = document.createElement('div');
                    newElement.className = `element ${elementType}`;
                    newElement.contentEditable = 'true';
                    
                    // Add menu to new element
                    const newMenu = document.createElement('div');
                    newMenu.className = 'element-menu';
                    const newDeleteBtn = document.createElement('button');
                    newDeleteBtn.textContent = 'Delete';
                    newDeleteBtn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        newElement.remove();
                    });
                    newMenu.appendChild(newDeleteBtn);
                    newElement.appendChild(newMenu);
                    
                    screenplayContent.insertBefore(newElement, element.nextSibling);
                    newElement.focus();
                }
            });
        }

        // Thesaurus Button
        thesaurusBtn.addEventListener('click', () => {
            thesaurusModal.style.display = 'block';
            thesaurusSearch.focus();
        });

        // Dictionary Button
        dictionaryBtn.addEventListener('click', () => {
            thesaurusModal.style.display = 'block';
            // Switch to dictionary tab
            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            document.querySelector('.tab[data-tab="dictionary"]').classList.add('active');
            document.getElementById('dictionary-tab').classList.add('active');
            dictionarySearch.focus();
        });

        // Cancel Thesaurus Modal
        cancelThesaurusBtn.addEventListener('click', () => {
            thesaurusModal.style.display = 'none';
            thesaurusResults.innerHTML = '';
            dictionaryResults.innerHTML = '';
            thesaurusSearch.value = '';
            dictionarySearch.value = '';
        });

        // Tab Switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                if (tabName === 'thesaurus') {
                    thesaurusSearch.focus();
                } else {
                    dictionarySearch.focus();
                }
            });
        });

        // Search Thesaurus
        thesaurusSearch.addEventListener('input', (e) => {
            const word = e.target.value.trim();
            if (word) {
                searchThesaurus(word);
            } else {
                thesaurusResults.innerHTML = '';
            }
        });

        // Search Dictionary
        dictionarySearch.addEventListener('input', (e) => {
            const word = e.target.value.trim();
            if (word) {
                searchDictionary(word);
            } else {
                dictionaryResults.innerHTML = '';
            }
        });

        // Enter key functionality for search
        thesaurusSearch.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const word = e.target.value.trim();
                if (word) {
                    searchThesaurus(word);
                }
            }
        });

        dictionarySearch.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const word = e.target.value.trim();
                if (word) {
                    searchDictionary(word);
                }
            }
        });

        // Search Thesaurus Function with API
        async function searchThesaurus(word) {
            thesaurusResults.innerHTML = '<div class="loading">Searching...</div>';
            
            try {
                let apiUrl;
                if (currentLanguage === 'en') {
                    apiUrl = `https://api.datamuse.com/words?rel_syn=${encodeURIComponent(word)}&max=10`;
                } else {
                    apiUrl = `https://api.alqamoos.org/synonyms?word=${encodeURIComponent(word)}&lang=ar`;
                }
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                let html;
                if (currentLanguage === 'en') {
                    if (data.length > 0) {
                        const synonyms = data.map(item => item.word);
                        html = `<div class="word-result">
                            <h3>${word.charAt(0).toUpperCase() + word.slice(1)}</h3>
                            <div><strong>Synonyms:</strong> ${synonyms.join(', ')}</div>
                        </div>`;
                    } else {
                        html = `<div class="word-result">No thesaurus results found for "${word}"</div>`;
                    }
                } else {
                    if (data.synonyms && data.synonyms.length > 0) {
                        html = `<div class="word-result rtl-text">
                            <h3>${word}</h3>
                            <div><strong>مرادفات:</strong> ${data.synonyms.join('، ')}</div>
                        </div>`;
                    } else {
                        html = `<div class="word-result rtl-text">لا توجد نتائج للكلمة "${word}"</div>`;
                    }
                }
                
                thesaurusResults.innerHTML = html;
            } catch (error) {
                console.error('Thesaurus search error:', error);
                thesaurusResults.innerHTML = `<div class="error">Error searching thesaurus. Please try again.</div>`;
            }
        }

        // Search Dictionary Function with API
        async function searchDictionary(word) {
            dictionaryResults.innerHTML = '<div class="loading">Searching...</div>';
            
            try {
                let apiUrl;
                if (currentLanguage === 'en') {
                    apiUrl = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
                } else {
                    apiUrl = `https://api.alqamoos.org/definitions?word=${encodeURIComponent(word)}&lang=ar`;
                }
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                let html;
                if (currentLanguage === 'en') {
                    if (Array.isArray(data) && data.length > 0) {
                        const entry = data[0];
                        html = `<div class="word-result">
                            <h3>${word.charAt(0).toUpperCase() + word.slice(1)}</h3>`;
                        
                        entry.meanings.forEach(meaning => {
                            html += `<div><em>${meaning.partOfSpeech}</em></div>`;
                            meaning.definitions.slice(0, 3).forEach((def, i) => {
                                html += `<div><strong>Definition ${i+1}:</strong> ${def.definition}</div>`;
                                if (def.example) {
                                    html += `<div><strong>Example:</strong> "${def.example}"</div>`;
                                }
                            });
                        });
                        
                        html += `</div>`;
                    } else {
                        html = `<div class="word-result">No dictionary results found for "${word}"</div>`;
                    }
                } else {
                    if (data.definitions && data.definitions.length > 0) {
                        html = `<div class="word-result rtl-text">
                            <h3>${word}</h3>`;
                        
                        data.definitions.slice(0, 3).forEach((def, i) => {
                            html += `<div><strong>تعريف ${i+1}:</strong> ${def.definition}</div>`;
                            if (def.example) {
                                html += `<div><strong>مثال:</strong> "${def.example}"</div>`;
                            }
                        });
                        
                        html += `</div>`;
                    } else {
                        html = `<div class="word-result rtl-text">لا توجد نتائج للكلمة "${word}"</div>`;
                    }
                }
                
                dictionaryResults.innerHTML = html;
            } catch (error) {
                console.error('Dictionary search error:', error);
                dictionaryResults.innerHTML = `<div class="error">Error searching dictionary. Please try again.</div>`;
            }
        }

        // Language change
        languageSelect.addEventListener('change', (e) => {
            currentLanguage = e.target.value;
            if (currentLanguage === 'ar') {
                document.body.classList.add('rtl');
            } else {
                document.body.classList.remove('rtl');
            }
        });

        // New document
        newBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to create a new document? Any unsaved changes will be lost.')) {
                screenplayContent.innerHTML = '';
                addNewElement('action');
            }
        });

        // Save document
        saveBtn.addEventListener('click', () => {
            const elements = Array.from(screenplayContent.querySelectorAll('.element'));
            const documentData = elements.map(el => {
                return {
                    type: Array.from(el.classList).find(c => c !== 'element'),
                    content: el.textContent.replace('Delete', '').trim()
                };
            });
            
            const blob = new Blob([JSON.stringify(documentData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'screenplay.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Open document
        openBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        screenplayContent.innerHTML = '';
                        
                        data.forEach(item => {
                            addNewElement(item.type, item.content);
                        });
                    } catch (error) {
                        alert('Error loading file: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        });

        // Print document
        printBtn.addEventListener('click', () => {
            window.print();
        });

        // Initialize with one action element
        window.addEventListener('DOMContentLoaded', () => {
            addNewElement('action');
            
            // Adjust document container margin to account for toolbar
            document.getElementById('document-container').style.marginTop = '56px';
        });
    </script>
</body>
</html>
