<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fade Out - Professional Screenplay Editor</title>
  <style>
    /* Dark Theme & Typography */
    html {
      scroll-behavior: smooth;
    }
    
    body {
      background-color: #1c0f2e;
      color: white;
      font-family: Courier, monospace;
      margin: 0;
      padding: 0;
      line-height: 1.2;
      height: 100vh;
      overflow-y: auto;
    }
    
    body.light {
      background-color: #f8f8f8;
      color: #000000;
    }

    /* App Header */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #1c0f2e;
      color: white;
      text-align: center;
      padding: 10px 0;
      z-index: 1000;
      border-bottom: 1px solid #472e63;
      direction: ltr;
      height: 50px;
    }
    
    body.light .app-header {
      background-color: #f8f8f8;
      color: #000000;
      border-bottom: 1px solid #cccccc;
    }
    
    .app-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .tagline {
      font-size: 14px;
      opacity: 0.8;
    }

    /* Toolbar */
    .toolbar {
      position: fixed;
      top: 70px;
      left: 0;
      right: 0;
      background-color: #2a1240;
      border-bottom: 2px solid #472e63;
      padding: 8px;
      display: flex;
      flex-direction: column;
      z-index: 999;
      gap: 3px;
      height: auto;
      min-height: 50px;
    }

    body.light .toolbar {
      background-color: #e3e3e3;
      border-bottom: 2px solid #cccccc;
    }

    /* Toolbar Rows */
    .toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: center;
      align-items: center;
    }

    /* Page Counter */
    .page-counter {
      position: fixed;
      right: 20px;
      bottom: 60px;
      background-color: #2a1240;
      padding: 8px 12px;
      border-radius: 3px;
      z-index: 999;
      font-size: 14px;
      border: 1px solid #472e63;
    }

    body.light .page-counter {
      background-color: #e3e3e3;
    }

    /* Editor */
    #editor {
      padding: 160px 0 20px 0;
      margin: 0 auto 0 250px;
      outline: none;
      white-space: pre-wrap;
      min-height: 80vh;
      font-size: 12pt;
      width: 8.5in;
      max-width: 8.5in;
      font-family: 'Courier New', Courier, monospace;
      line-height: 24px;
      padding-left: 1.5in;
      padding-right: 1in;
      box-sizing: border-box;
    }

    /* Title Page Styles */
    .title-page {
      display: none;
      padding: 160px 20px 20px 20px;
      text-align: center;
    }
    
    .title-page-content {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .title-page input, .title-page textarea {
      background: transparent;
      border: none;
      border-bottom: 1px solid gold;
      color: inherit;
      font-family: inherit;
      font-size: inherit;
      text-align: center;
      width: 100%;
      margin: 15px auto;
      padding: 5px;
    }
    
    .title-page .title {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 40px;
    }
    
    .title-page .author {
      font-size: 20px;
      margin-bottom: 60px;
    }
    
    .title-page .contact {
      font-size: 16px;
      margin-top: 100px;
    }
    
    .title-page .copyright {
      font-size: 12px;
      margin-top: 120px;
    }

    /* RTL Fixes */
    body[dir="rtl"] {
      direction: rtl;
    }
    
    body[dir="rtl"] .toolbar {
      direction: rtl;
    }
    
    .rtl-element {
      direction: rtl;
      unicode-bidi: embed;
    }
    
    /* Final Draft International Screenplay Formatting */
    .element { 
      margin: 0; 
      padding: 0; 
      position: relative;
      outline: none;
      border: none;
      min-height: 24px;
      box-sizing: border-box;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12pt;
      line-height: 24px;
    }
    
    .element.scene-heading { 
      text-transform: uppercase; 
      margin: 24px 0 12px 0; 
      padding-left: 0;
      padding-right: 1in;
      text-align: left;
      font-weight: bold;
      font-size: 12pt;
      line-height: 24px;
    }
    
    .element.action { 
      margin: 12px 0; 
      padding-left: 0;
      padding-right: 0;
      text-align: left;
      font-size: 12pt;
      line-height: 24px;
      text-indent: 0;
    }
    
    .element.character { 
      margin: 24px 0 0 0; 
      padding-left: 2.2in;
      padding-right: 0;
      font-weight: bold; 
      text-transform: uppercase; 
      text-align: left;
      font-size: 12pt;
      line-height: 24px;
    }
    
    .element.dialogue { 
      margin: 0 0 12px 0; 
      padding-left: 1in;
      padding-right: 1in;
      text-align: left;
      font-size: 12pt;
      line-height: 24px;
    }
    
    .element.parenthetical { 
      font-style: italic; 
      margin: 0 0 0 0; 
      padding-left: 1.5in;
      padding-right: 1.5in;
      text-align: left;
      font-size: 12pt;
      line-height: 24px;
    }
    
    .element.transition { 
      margin: 24px 0; 
      padding-left: 0;
      padding-right: 0;
      font-weight: bold; 
      text-transform: uppercase; 
      text-align: right;
      font-size: 12pt;
      line-height: 24px;
    }
    
    .active-line { background-color: rgba(255, 215, 0, 0.1); }

    /* RTL Formatting Adjustments - Final Draft Standard */
    body[dir="rtl"] .element.scene-heading {
      text-align: right !important;
      padding-left: 0 !important;
      padding-right: 20px !important;
      margin-left: 0 !important;
      margin-right: -1.5in !important;
      direction: rtl;
      margin-top: 24px;
      margin-bottom: 12px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12pt;
      line-height: 24px;
      font-weight: bold;
      text-transform: uppercase;
      width: calc(100% + 1.5in);
      display: block;
      position: relative;
    }
    
    body[dir="rtl"] .element.action {
      text-align: right;
      padding-left: 0 !important;
      padding-right: 0 !important;
      direction: rtl;
      margin: 12px 0;
      margin-right: -1.5in !important;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12pt;
      line-height: 24px;
      text-indent: 0;
      width: calc(100% + 1.5in) !important;
      box-sizing: border-box;
      position: relative;
      right: 0 !important;
    }
    
    body[dir="rtl"] .element.character {
      text-align: right;
      padding-left: 0;
      padding-right: 2.2in;
      direction: rtl;
      margin: 24px 0 0 0;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12pt;
      line-height: 24px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    body[dir="rtl"] .element.dialogue {
      text-align: right;
      padding-left: 1in;
      padding-right: 1in;
      direction: rtl;
      margin: 0 0 12px 0;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12pt;
      line-height: 24px;
    }
    
    body[dir="rtl"] .element.parenthetical {
      text-align: right;
      padding-left: 1.5in;
      padding-right: 1.5in;
      direction: rtl;
      margin: 0;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12pt;
      line-height: 24px;
      font-style: italic;
    }
    
    body[dir="rtl"] .element.transition {
      text-align: left;
      padding-left: 0;
      padding-right: 0;
      direction: ltr;
      margin: 24px 0;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12pt;
      line-height: 24px;
      font-weight: bold;
      text-transform: uppercase;
    }

    body[dir="rtl"] .sidebar {
      text-align: right;
      direction: rtl;
    }

    body[dir="rtl"] .sidebar-element-btn {
      text-align: right;
      direction: rtl;
    }

    body[dir="rtl"] .sidebar h3,
    body[dir="rtl"] .sidebar h4 {
      text-align: right;
      direction: rtl;
    }

    /* Toolbar buttons */
    .toolbar button {
      background-color: #472e63;
      color: white;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 3px;
      min-width: 90px;
      font-family: Courier, monospace;
      font-size: 11px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    body.light .toolbar button {
      background-color: #dddddd;
      color: #000000;
    }

    .toolbar button.active {
      background-color: #6b458e;
    }

    /* Character suggestions */
    #character-suggestions {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }

    body.light #character-suggestions {
      background-color: #e3e3e3;
      border: 1px solid #000000;
    }

    .character-suggestion-item {
      padding: 5px 10px;
      cursor: pointer;
    }

    .character-suggestion-item:hover {
      background-color: #472e63;
    }

    body.light .character-suggestion-item:hover {
      background-color: #cccccc;
    }

    /* Notification */
    #notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: gold;
      color: #1c0f2e;
      padding: 10px 20px;
      border-radius: 3px;
      display: none;
      z-index: 100;
    }

    /* Feedback box */
    #feedback-box {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 5px;
      padding: 15px;
      z-index: 1000;
      display: none;
    }

    #feedback-text {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    body.light #feedback-text {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    .feedback-buttons {
      display: flex;
      justify-content: space-between;
    }

    #send-feedback-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 3px;
    }

    #cancel-feedback-btn {
      background: none;
      border: 1px solid gold;
      color: gold;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 3px;
    }

    body.light #send-feedback-btn {
      background-color: #000000;
      color: white;
    }

    body.light #cancel-feedback-btn {
      border: 1px solid #000000;
      color: #000000;
    }
    
    /* Transition dropdown */
    #transition-dropdown {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 400px;
      width: 250px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .transition-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
      pointer-events: auto;
      user-select: none;
      display: block;
      width: 100%;
    }
    
    .transition-item:hover {
      background-color: #472e63;
    }
    
    body.light #transition-dropdown {
      background-color: #f8f8f8;
      border: 1px solid #000;
    }
    
    body.light .transition-item:hover {
      background-color: #ddd;
    }

    /* Add Arabic web features styles */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading {
      padding: 20px;
      text-align: center;
      color: gold;
      font-style: italic;
    }
    
    .error {
      padding: 20px;
      text-align: center;
      color: #ff6b6b;
      font-style: italic;
    }

    .part-of-speech {
      font-weight: bold;
      color: #ffd700;
      margin-top: 10px;
      font-size: 0.9em;
    }

    .word-tag {
      background: #472e63;
      color: white;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 3px;
      cursor: pointer;
      display: inline-block;
      font-size: 0.85em;
    }

    .word-tag:hover {
      background: #5a3a7a;
    }

    /* Sidebar title styles */
    #sidebar-title {
      font-size: 16px;
      font-weight: bold;
      color: #ffd700;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    body.light #sidebar-title {
      color: #000;
    }
    
    .translation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .translation-progress {
      background: #2a1240;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid gold;
      max-width: 300px;
    }
    
    .translation-progress .spinner {
      border: 4px solid rgba(255, 215, 0, 0.3);
      border-radius: 50%;
      border-top: 4px solid gold;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .word-tag {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .word-tag:hover {
      background: rgba(255, 215, 0, 0.3);
    }
    
    .part-of-speech {
      font-weight: bold;
      margin: 15px 0 5px;
      color: gold;
    }
    
    .example {
      font-style: italic;
      margin: 5px 0 0 15px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    body.light .example {
      color: rgba(0, 0, 0, 0.6);
    }
    
    /* Arabic-specific styling */
    .arabic-text {
      font-family: 'Courier New', Courier, 'Traditional Arabic', Arial, sans-serif;
      letter-spacing: 0;
    }

    /* Sidebars */
    .sidebar {
      position: fixed;
      top: 180px;
      width: 250px;
      height: calc(100vh - 210px);
      background-color: #2a1240;
      border: 1px solid #472e63;
      overflow-y: auto;
      z-index: 998;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    /* Arabic mode sidebar positioning */
    body[dir="rtl"] .left-sidebar {
      left: auto;
      right: 0;
      transform: translateX(100%);
    }

    body[dir="rtl"] .left-sidebar.open {
      transform: translateX(0);
    }

    body[dir="rtl"] .right-panel {
      right: auto;
      left: 0;
      transform: translateX(-100%);
    }

    body[dir="rtl"] .right-panel.open {
      transform: translateX(0);
    }

    body.light .sidebar {
      background-color: #f0f0f0;
      border: 1px solid #cccccc;
    }

    .left-sidebar {
      left: 0;
      transform: translateX(-100%);
      display: flex;
      flex-direction: column;
    }

    .left-sidebar.open {
      transform: translateX(0);
    }

    /* Sidebar Page Counter */
    .sidebar-page-counter {
      margin-top: auto;
      padding: 15px;
      border-top: 1px solid #472e63;
      font-size: 14px;
      text-align: center;
      color: white;
      background-color: #2a1240;
      display: none; /* Hidden by default, shown in English mode */
      flex-shrink: 0;
      position: sticky;
      bottom: 0;
    }

    body.light .sidebar-page-counter {
      border-top: 1px solid #cccccc;
      color: #000000;
      background-color: #e3e3e3;
    }

    .right-panel {
      right: 0;
      transform: translateX(100%);
    }

    .right-panel.open {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #472e63;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    body.light .sidebar-header {
      border-bottom: 1px solid #cccccc;
    }

    .sidebar-section {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex: 1;
      overflow-y: auto;
    }

    body.light .sidebar-section {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .sidebar h3, .sidebar h4 {
      margin: 0 0 10px 0;
      color: white;
    }

    body.light .sidebar h3, body.light .sidebar h4 {
      color: #000000;
    }

    .panel-tabs {
      display: flex;
      border-bottom: 1px solid #472e63;
    }

    body.light .panel-tabs {
      border-bottom: 1px solid #cccccc;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }

    body.light .tab-btn {
      color: #000000;
    }

    .tab-btn.active {
      background-color: #472e63;
      color: gold;
    }

    body.light .tab-btn.active {
      background-color: #dddddd;
      color: #000000;
    }

    .tab-content {
      padding: 15px;
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .tab-content input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #472e63;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      border-radius: 3px;
    }

    body.light .tab-content input {
      border: 1px solid #cccccc;
      background-color: white;
      color: #000000;
    }

    /* Status Bar */
    .status-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30px;
      background-color: #2a1240;
      border-top: 1px solid #472e63;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      font-size: 12px;
      z-index: 999;
    }

    body.light .status-bar {
      background-color: #e3e3e3;
      border-top: 1px solid #cccccc;
    }

    .status-bar span {
      margin-right: 20px;
    }

    /* Modals */
    .modal-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .modal {
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 5px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }

    body.light .modal {
      background-color: #f8f8f8;
      border: 1px solid #000000;
    }

    .modal h2 {
      margin-top: 0;
      color: gold;
    }

    body.light .modal h2 {
      color: #000000;
    }

    .modal input, .modal select, .modal textarea {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      box-sizing: border-box;
    }

    body.light .modal input,
    body.light .modal select,
    body.light .modal textarea {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .cancel-btn {
      background: none;
      border: 1px solid gold;
      color: gold;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    .confirm-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    body.light .cancel-btn {
      border: 1px solid #000000;
      color: #000000;
    }

    body.light .confirm-btn {
      background-color: #000000;
      color: white;
    }

    /* Formatting buttons */
    .toolbar button.format-active {
      background-color: gold;
      color: #1c0f2e;
    }

    body.light .toolbar button.format-active {
      background-color: #000000;
      color: white;
    }

    /* Spell check highlights */
    .spell-error {
      border-bottom: 2px wavy red;
    }

    .spell-suggestion {
      background-color: rgba(255, 215, 0, 0.2);
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 2px;
    }

    /* Scene and character items */
    .scene-item, .character-item, .note-item, .recent-file-item {
      padding: 8px;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 3px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .scene-item:hover, .character-item:hover, .note-item:hover, .recent-file-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    body.light .scene-item, body.light .character-item, body.light .note-item, body.light .recent-file-item {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    body.light .scene-item:hover, body.light .character-item:hover, body.light .note-item:hover, body.light .recent-file-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .scene-item.active {
      background-color: rgba(255, 215, 0, 0.2);
    }

    body.light .scene-item.active {
      background-color: rgba(0, 0, 0, 0.1);
    }

    /* Element buttons in sidebar */
    .element-buttons {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .sidebar-element-btn {
      width: 100%;
      padding: 8px 12px;
      background-color: #472e63;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-family: Courier, monospace;
      font-size: 11px;
      text-align: left;
    }

    body.light .sidebar-element-btn {
      background-color: #dddddd;
      color: #000000;
    }

    .sidebar-element-btn:hover {
      background-color: #5a3a7a;
    }

    body.light .sidebar-element-btn:hover {
      background-color: #cccccc;
    }

    .sidebar-element-btn.active {
      background-color: #6b458e;
      color: gold;
    }

    body.light .sidebar-element-btn.active {
      background-color: #000000;
      color: white;
    }

    /* Editor with sidebars */
    #editor.with-left-sidebar {
      margin-left: 250px;
      padding-left: 20px;
    }

    #editor.with-right-panel {
      margin-right: 250px;
      padding-right: 20px;
    }

    /* Arabic mode editor margins */
    body[dir="rtl"] #editor {
      padding-left: 1in;
      padding-right: 1.5in;
      direction: rtl;
      text-align: right;
    }

    body[dir="rtl"] #editor.with-left-sidebar {
      margin-left: 0;
      margin-right: 250px;
      padding-left: 1in;
      padding-right: 1.5in;
      width: 8.5in;
      max-width: 8.5in;
      box-sizing: border-box;
      direction: rtl;
      text-align: right;
    }

    body[dir="rtl"] #editor.with-right-panel {
      margin-right: 0;
      margin-left: 250px;
      padding-left: 1in;
      padding-right: 1.5in;
      width: 8.5in;
      max-width: 8.5in;
      box-sizing: border-box;
      direction: rtl;
      text-align: right;
    }

    /* Dictionary and Thesaurus Results Styling */
    .word-result {
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }

    body.light .word-result {
      background-color: rgba(0, 0, 0, 0.02);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .word-result h3 {
      margin: 0 0 10px 0;
      color: gold;
      font-size: 18px;
      font-weight: bold;
    }

    body.light .word-result h3 {
      color: #000000;
    }

    .definition {
      margin: 8px 0;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.light .definition {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .definition:last-child {
      border-bottom: none;
    }

    .definition strong {
      color: #9d7bea;
      font-size: 12px;
      text-transform: uppercase;
    }

    body.light .definition strong {
      color: #6b46c1;
    }

    .definition em {
      color: rgba(255, 255, 255, 0.7);
      font-style: italic;
      font-size: 14px;
    }

    body.light .definition em {
      color: rgba(0, 0, 0, 0.6);
    }

    .synonyms, .antonyms {
      margin: 15px 0;
    }

    .word-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .word-tag {
      background-color: rgba(157, 123, 234, 0.2);
      color: #9d7bea;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid rgba(157, 123, 234, 0.3);
    }

    .word-tag:hover {
      background-color: rgba(157, 123, 234, 0.4);
      transform: translateY(-1px);
    }

    .word-tag.antonym {
      background-color: rgba(255, 99, 99, 0.2);
      color: #ff6363;
      border: 1px solid rgba(255, 99, 99, 0.3);
    }

    .word-tag.antonym:hover {
      background-color: rgba(255, 99, 99, 0.4);
    }

    body.light .word-tag {
      background-color: rgba(107, 70, 193, 0.1);
      color: #6b46c1;
      border: 1px solid rgba(107, 70, 193, 0.2);
    }

    body.light .word-tag:hover {
      background-color: rgba(107, 70, 193, 0.2);
    }

    body.light .word-tag.antonym {
      background-color: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    body.light .word-tag.antonym:hover {
      background-color: rgba(239, 68, 68, 0.2);
    }

    .suggestion {
      background-color: rgba(255, 215, 0, 0.1);
      color: gold;
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      border: 1px solid rgba(255, 215, 0, 0.2);
    }

    .suggestion:hover {
      background-color: rgba(255, 215, 0, 0.2);
    }

    body.light .suggestion {
      background-color: rgba(0, 0, 0, 0.05);
      color: #000000;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    body.light .suggestion:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .toolbar {
        padding: 5px;
      }
      
      .toolbar-row {
        justify-content: flex-start;
      }
      
      .toolbar button {
        min-width: 80px;
        font-size: 10px;
        padding: 6px 8px;
      }
      
      #editor {
        padding: 140px 10px 20px 10px;
        font-size: 11pt;
      }
      
      .scene-heading,
      .action,
      .character,
      .dialogue,
      .parenthetical,
      .transition {
        padding-left: 0.5in;
        padding-right: 0.5in;
      }

      .sidebar {
        width: 280px;
      }

      #editor.with-left-sidebar,
      #editor.with-right-panel {
        margin-left: 0;
        margin-right: 0;
      }
    }
  </style>
</head>
<body class="dark-mode">
  <!-- Header -->
  <div class="app-header">
    <div class="app-name">Fade Out</div>
    <div class="tagline">Write. Rewrite. Fade Out.</div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-row">
      <button id="undo-btn">↶</button>
      <button id="redo-btn">↷</button>
      <button id="bold-btn"><strong>B</strong></button>
      <button id="italic-btn"><em>I</em></button>
      <button id="underline-btn"><u>U</u></button>
      <button id="thesaurus-btn">THESAURUS</button>
      <button id="dictionary-btn">DICTIONARY</button>
      <button id="spell-check-btn">SPELL CHECK</button>
      <button id="save-btn">SAVE</button>
      <button id="load-btn">LOAD</button>
      <button id="export-btn">EXPORT</button>
      <button id="translate-btn">TRANSLATE</button>
      <button id="theme-toggle">LIGHT</button>
      <button id="rtl-toggle">ARABIC</button>
      <button id="back-to-home-btn" onclick="goBackToHome()" style="display: none;">← HOME</button>
      <button id="feedback-btn">FEEDBACK</button>
    </div>
  </div>

  <!-- Page Counter -->
  <div class="page-counter" id="page-counter">Page 1</div>

  <!-- Title Page -->
  <div id="title-page" class="title-page">
    <div class="title-page-content">
      <div class="title">
        <input type="text" id="script-title" placeholder="TITLE OF SCRIPT">
      </div>
      <div class="author">
        <input type="text" id="written-by" placeholder="Written by">
      </div>
      <div class="contact">
        <input type="text" id="contact-email" placeholder="Email">
        <input type="text" id="contact-phone" placeholder="Phone">
      </div>
      <div>
        <textarea id="awards" placeholder="Accolades/Awards" rows="3"></textarea>
      </div>
      <div class="copyright">
        All copyrights reserved
      </div>
      <button id="back-to-editor-btn">BACK TO EDITOR</button>
    </div>
  </div>

  <!-- Editor -->
  <div id="editor" class="ltr" contenteditable="true" spellcheck="false"></div>

  <!-- Character suggestions -->
  <div id="character-suggestions"></div>
  
  <!-- Transition dropdown -->
  <div id="transition-dropdown">
    <!-- Core transitions as requested -->
    <div class="transition-item" data-text-en="CUT TO:" data-text-ar="قطع إلى:">CUT TO:</div>
    <div class="transition-item" data-text-en="FADE IN:" data-text-ar="ظهور تدريجي:">FADE IN:</div>
    <div class="transition-item" data-text-en="FADE OUT:" data-text-ar="اختفاء تدريجي:">FADE OUT:</div>
    <div class="transition-item" data-text-en="DISSOLVE TO:" data-text-ar="ذوبان إلى:">DISSOLVE TO:</div>
    <div class="transition-item" data-text-en="BACK TO:" data-text-ar="العودة إلى:">BACK TO:</div>
    <div class="transition-item" data-text-en="MATCH CUT TO:" data-text-ar="قطع متطابق إلى:">MATCH CUT TO:</div>
    
    <!-- Additional common transitions -->
    <div class="transition-item" data-text-en="FADE TO BLACK:" data-text-ar="اختفاء إلى الأسود:">FADE TO BLACK:</div>
    <div class="transition-item" data-text-en="FADE TO WHITE:" data-text-ar="اختفاء إلى الأبيض:">FADE TO WHITE:</div>
    <div class="transition-item" data-text-en="QUICK CUT TO:" data-text-ar="قطع سريع إلى:">QUICK CUT TO:</div>
    <div class="transition-item" data-text-en="SMASH CUT TO:" data-text-ar="قطع حاد إلى:">SMASH CUT TO:</div>
    <div class="transition-item" data-text-en="JUMP CUT TO:" data-text-ar="قطع قفز إلى:">JUMP CUT TO:</div>
    <div class="transition-item" data-text-en="SLOW DISSOLVE TO:" data-text-ar="ذوبان بطيء إلى:">SLOW DISSOLVE TO:</div>
    <div class="transition-item" data-text-en="WIPE TO:" data-text-ar="مسح إلى:">WIPE TO:</div>
    <div class="transition-item" data-text-en="FREEZE FRAME" data-text-ar="إيقاف الإطار">FREEZE FRAME</div>
    <div class="transition-item" data-text-en="TIME CUT:" data-text-ar="قطع زمني:">TIME CUT:</div>
    <div class="transition-item" data-text-en="INTERCUT WITH:" data-text-ar="تبديل مع:">INTERCUT WITH:</div>
  </div>
  
  <!-- Notification -->
  <div id="notification">Notification Message</div>
  
  <!-- Left Sidebar -->
  <div id="left-sidebar" class="sidebar left-sidebar open">
    <div class="sidebar-header">
      <h3 id="sidebar-title">Untitled Script</h3>
      <button id="toggle-left-sidebar">×</button>
    </div>
    
    <div class="sidebar-section">
      <h4>Elements</h4>
      <div class="element-buttons">
        <button id="title-page-btn" class="sidebar-element-btn">TITLE PAGE</button>
        <button id="scene-heading-btn" class="sidebar-element-btn element-button active" data-type="scene-heading">SCENE HEADING</button>
        <button id="action-btn" class="sidebar-element-btn element-button" data-type="action">ACTION</button>
        <button id="character-btn" class="sidebar-element-btn element-button" data-type="character">CHARACTER</button>
        <button id="dialogue-btn" class="sidebar-element-btn element-button" data-type="dialogue">DIALOGUE</button>
        <button id="parenthetical-btn" class="sidebar-element-btn element-button" data-type="parenthetical">PARENTHETICAL</button>
        <button id="transition-btn" class="sidebar-element-btn element-button" data-type="transition">TRANSITION</button>
      </div>
    </div>
    
    <div class="sidebar-page-counter" id="sidebar-page-counter">
      Page 1
    </div>

  </div>

  <!-- Right Panel -->
  <div id="right-panel" class="sidebar right-panel">
    <div class="sidebar-header">
      <h3>Tools</h3>
      <button id="toggle-right-panel">×</button>
    </div>
    
    <div class="panel-tabs">
      <button class="tab-btn active" data-tab="dictionary">Dictionary</button>
      <button class="tab-btn" data-tab="thesaurus">Thesaurus</button>
      <button class="tab-btn" data-tab="notes">Notes</button>
    </div>
    
    <div id="dictionary-tab" class="tab-content active">
      <input type="text" id="dict-search" placeholder="Search word...">
      <div id="dict-results"></div>
    </div>
    
    <div id="thesaurus-tab" class="tab-content">
      <input type="text" id="thes-search" placeholder="Search synonyms...">
      <div id="thes-results"></div>
    </div>
    
    <div id="notes-tab" class="tab-content">
      <button id="add-note-btn">Add Note</button>
      <div id="notes-list"></div>
    </div>
  </div>

  <!-- Status Bar -->
  <div id="status-bar" class="status-bar">
    <span id="word-count">Words: 0</span>
    <span id="char-count">Characters: 0</span>
    <span id="runtime">Runtime: 0 min</span>
    <span id="last-saved">Auto-saved</span>
  </div>

  <!-- Save Modal -->
  <div class="modal-container" id="save-modal-container">
    <div class="modal">
      <h2>Save Script</h2>
      <div style="margin: 10px 0;">
        <label for="save-script-title">Script Title:</label>
        <input type="text" id="save-script-title" placeholder="Enter script title">
      </div>
      <div style="margin: 10px 0;">
        <label for="save-location">Save Location:</label>
        <select id="save-location" style="width: 100%; margin-top: 5px;">
          <option value="local">Browser Storage</option>
          <option value="cloud">Cloud Storage</option>
          <option value="download">Download File</option>
        </select>
      </div>
      <div style="margin: 10px 0;">
        <label for="save-format">Format:</label>
        <select id="save-format" style="width: 100%; margin-top: 5px;">
          <option value="pdf">PDF</option>
          <option value="fdx">Final Draft (FDX)</option>
          <option value="html">HTML</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="save-cancel">Cancel</button>
        <button class="confirm-btn" id="save-confirm">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Load Modal -->
  <div class="modal-container" id="load-modal-container">
    <div class="modal">
      <h2>Load Script</h2>
      <div style="margin: 10px 0;">
        <label for="load-location">Load From:</label>
        <select id="load-location" style="width: 100%; margin-top: 5px;">
          <option value="local">Browser Storage</option>
          <option value="cloud">Cloud Storage</option>
          <option value="upload">Upload File</option>
        </select>
      </div>
      <div id="saved-scripts-container" style="display: block;">
        <label>Saved Scripts:</label>
        <div id="saved-scripts-list" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
      </div>
      <div id="upload-container" style="display: none;">
        <label for="script-upload">Choose File:</label>
        <input type="file" id="script-upload" accept=".html,.txt,.fdx" style="margin-top: 5px;">
      </div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="load-cancel">Cancel</button>
        <button class="confirm-btn" id="load-confirm">Load</button>
      </div>
    </div>
  </div>
  
  <!-- Export Modal -->
  <div class="modal-container" id="export-modal-container">
    <div class="modal">
      <h2>Export Script</h2>
      <div style="margin: 10px 0;">
        <label for="export-format">Format:</label>
        <select id="export-format" style="width: 100%; margin-top: 5px;">
          <option value="pdf">PDF</option>
          <option value="fdx">Final Draft (FDX)</option>
          <option value="html">HTML</option>
          <option value="fountain">Fountain</option>
        </select>
      </div>
      <div style="margin: 10px 0;">
        <label for="export-filename">File Name:</label>
        <input type="text" id="export-filename" placeholder="Enter filename (without extension)">
      </div>
      <div style="margin: 10px 0;">
        <label>
          <input type="checkbox" id="include-title-page"> Include Title Page
        </label>
      </div>
      <div style="margin: 10px 0;">
        <label>
          <input type="checkbox" id="include-notes"> Include Notes
        </label>
      </div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="export-cancel">Cancel</button>
        <button class="preview-btn" id="export-preview" onclick="previewPDF()" style="background: #2196F3; border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">Preview PDF</button>
        <button class="confirm-btn" id="export-confirm">Export</button>
      </div>
    </div>
  </div>
  
  <!-- Thesaurus Modal -->
  <div class="modal-container" id="thesaurus-modal-container">
    <div class="modal">
      <h2>Thesaurus</h2>
      <input type="text" id="thesaurus-search" placeholder="Search for a word...">
      <div id="thesaurus-results" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="thesaurus-cancel">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Dictionary Modal -->
  <div class="modal-container" id="dictionary-modal-container">
    <div class="modal">
      <h2>Dictionary</h2>
      <input type="text" id="dictionary-search" placeholder="Search for a word...">
      <div id="dictionary-results" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="dictionary-cancel">Close</button>
      </div>
    </div>
  </div>

  <!-- Feedback box -->
  <div id="feedback-box">
    <textarea id="feedback-text" placeholder="Enter your feedback here..."></textarea>
    <div class="feedback-buttons">
      <button id="cancel-feedback-btn">Cancel</button>
      <button id="send-feedback-btn">Send Feedback</button>
    </div>
  </div>

  <script>
    // Global state
    let currentElement = 'scene-heading';
    let isRtlMode = false;
    let scriptCharacters = new Set();
    let undoStack = [];
    let redoStack = [];
    let isUndoing = false;
    let pageCount = 1;
    let wordCount = 0;
    let characterCount = 0;
    let spellCheckEnabled = false;
    let leftSidebarOpen = false;
    let rightPanelOpen = false;
    let currentNotes = [];
    let sceneOutline = [];
    let autoSaveInterval;
    let lastSaved = new Date();

    // Arabic translations for UI
    const arabicTranslations = {
      'UNDO': 'تراجع',
      'REDO': 'إعادة',
      'BOLD': 'غامق',
      'ITALIC': 'مائل',
      'UNDERLINE': 'خط سفلي',
      'THESAURUS': 'قاموس المرادفات',
      'DICTIONARY': 'القاموس',
      'SPELL CHECK': 'التدقيق الإملائي',
      'SAVE': 'حفظ',
      'LOAD': 'تحميل',
      'EXPORT': 'تصدير',
      'TRANSLATE': 'ترجمة',
      'LIGHT': 'فاتح',
      'DARK': 'داكن',
      'ARABIC': 'عربي',
      'ENGLISH': 'إنجليزي',
      'FEEDBACK': 'تعليقات',
      'PROJECT': 'المشروع',
      'TOOLS': 'الأدوات',
      'Elements': 'العناصر',
      'TITLE PAGE': 'صفحة العنوان',
      'SCENE HEADING': 'عنوان المشهد',
      'ACTION': 'الحدث',
      'CHARACTER': 'الشخصية',
      'DIALOGUE': 'الحوار',
      'PARENTHETICAL': 'تعليق',
      'TRANSITION': 'انتقال',
      'Dictionary': 'القاموس',
      'Thesaurus': 'المرادفات',
      'Notes': 'الملاحظات',
      'SPELL CHECK: ON': 'التدقيق الإملائي: مفعل',
      'SPELL CHECK: OFF': 'التدقيق الإملائي: معطل',
      'Page': 'صفحة',
      'Words': 'كلمات',
      'Characters': 'حروف',
      'Runtime': 'المدة',
      'min': 'دقيقة',
      'Auto-saved': 'حفظ تلقائي',
      'TITLE OF SCRIPT': 'عنوان السيناريو',
      'Written by': 'كتابة',
      'All copyrights reserved': 'جميع الحقوق محفوظة',
      'BACK TO EDITOR': 'العودة إلى المحرر',
      'Save Script': 'حفظ السيناريو',
      'Script Title': 'عنوان السيناريو',
      'Save Location': 'مكان الحفظ',
      'Browser Storage': 'تخزين المتصفح',
      'Cloud Storage': 'التخزين السحابي',
      'Download File': 'تنزيل الملف',
      'Format': 'التنسيق',
      'PDF': 'PDF',
      'Final Draft (FDX)': 'فاينال درافت (FDX)',
      'HTML': 'HTML',
      'Cancel': 'إلغاء',
      'Load Script': 'تحميل السيناريو',
      'Load From': 'تحميل من',
      'Upload File': 'رفع ملف',
      'Saved Scripts': 'السيناريوهات المحفوظة',
      'Choose File': 'اختر ملف',
      'Export Script': 'تصدير السيناريو',
      'File Name': 'اسم الملف',
      'Include Title Page': 'تضمين صفحة العنوان',
      'Include Notes': 'تضمين الملاحظات',
      'Fountain': 'فاونتن',
      'Thesaurus': 'قاموس المرادفات',
      'Search for a word': 'ابحث عن كلمة',
      'Close': 'إغلاق',
      'Enter your feedback here': 'أدخل تعليقك هنا',
      'Send Feedback': 'إرسال التعليق'
    };


    // Initialize web services for Arabic support
    function initializeArabicServices() {
      console.log("Initializing Arabic web services");
      
      // Set up dictionary/thesaurus API endpoints
      window.arabicDictionaryAPI = {
        baseUrl: 'https://api.dictionaryapi.dev/api/v2/entries/ar/',
        fallbackUrl: 'https://api.alqamoos.org/search?query='
      };
      
      window.arabicThesaurusAPI = {
        baseUrl: 'https://api.datamuse.com/words?rel_syn=',
        langParam: '&lang=ar'
      };
      
      window.translationAPI = {
        baseUrl: 'https://translation-api.example.com/translate',
        apiKey: 'your-api-key-here'
      };
    }

    // Initialize the editor
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize theme - default to dark mode
      document.body.classList.add('dark-mode');
      
      // Initialize theme button to show correct text based on RTL mode
      const themeButton = document.getElementById('theme-toggle');
      const isCurrentlyRtl = document.body.getAttribute('dir') === 'rtl';
      themeButton.textContent = isCurrentlyRtl ? 'فاتح' : 'LIGHT'; // Shows what clicking will do
      
      // Show left sidebar by default
      const leftSidebar = document.getElementById('left-sidebar');
      leftSidebar.classList.add('open');
      
      // Update editor class for sidebar layout
      const editor = document.getElementById('editor');
      editor.classList.add('with-left-sidebar');
      editor.style.display = 'block';
      
      updatePageCounter();
      updateWordCount();
      
      // Set up event listeners
      setupListeners();
      
      // Start auto-save
      startAutoSave();
      
      // Initialize sidebar toggles
      initializeSidebars();
      
      // Add initial scene heading as first formatted line
      setTimeout(() => {
        addNewElement('scene-heading');
        // Position cursor correctly based on language
        const firstElement = document.querySelector('.element');
        if (firstElement) {
          positionCursorCorrectly(firstElement);
        }
        

      }, 100);
      
      // Simplified initialization for better performance
      console.log('App initialized');
    });

    // Enhanced Arabic dictionary search
    async function searchDictionary(word) {
      if (!word) return;
      
      const isArabic = /[\u0600-\u06FF]/.test(word);
      const resultsContainer = isRtlMode ? 
        document.getElementById('dict-results') : 
        document.getElementById('dictionary-results');
      
      // Show loading state
      resultsContainer.innerHTML = '<div class="loading">' + 
        (isRtlMode ? 'جاري البحث...' : 'Searching...') + '</div>';
      
      try {
        let apiUrl;
        if (isArabic) {
          apiUrl = `https://api.alqamoos.org/public/search?query=${encodeURIComponent(word)}`;
        } else {
          apiUrl = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
        }
        
        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (isArabic) {
          displayArabicDictionaryResults(data, word, resultsContainer);
        } else {
          displayEnglishDictionaryResults(data, word, resultsContainer);
        }
      } catch (error) {
        console.error('Dictionary error:', error);
        resultsContainer.innerHTML = '<div class="error" dir="' + 
          (isRtlMode ? 'rtl' : 'ltr') + '">' +
          (isRtlMode ? 'تعذر العثور على النتائج' : 'No results found') + '</div>';
      }
    }

    // Display Arabic dictionary results
    function displayArabicDictionaryResults(data, word, container) {
      if (!data || data.length === 0) {
        container.innerHTML = '<div class="word-result" dir="rtl">لا توجد نتائج للكلمة "' + word + '"</div>';
        return;
      }
      
      let html = '<div class="word-result" dir="rtl">';
      html += '<h3 class="arabic-text">' + word + '</h3>';
      
      data.slice(0, 3).forEach((entry, index) => {
        html += `<div class="part-of-speech">تعريف ${index + 1}</div>`;
        html += `<div class="definition arabic-text">${entry.definition || entry.meaning}</div>`;
        if (entry.example) {
          html += `<div class="example arabic-text">مثال: "${entry.example}"</div>`;
        }
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // Enhanced Arabic thesaurus search
    async function searchThesaurus(word) {
      if (!word) return;
      
      const isArabic = /[\u0600-\u06FF]/.test(word);
      const resultsContainer = isRtlMode ? 
        document.getElementById('thes-results') : 
        document.getElementById('thesaurus-results');
      
      // Show loading state
      resultsContainer.innerHTML = '<div class="loading">' + 
        (isRtlMode ? 'جاري البحث عن المرادفات...' : 'Searching for synonyms...') + '</div>';
      
      try {
        let apiUrl;
        if (isArabic) {
          apiUrl = `https://api.alqamoos.org/public/synonyms?query=${encodeURIComponent(word)}`;
        } else {
          apiUrl = `https://api.datamuse.com/words?rel_syn=${encodeURIComponent(word)}`;
        }
        
        const response = await fetch(apiUrl);
        const synonyms = await response.json();
        
        // For antonyms in English
        let antonyms = [];
        if (!isArabic) {
          const antResponse = await fetch(`https://api.datamuse.com/words?rel_ant=${encodeURIComponent(word)}`);
          antonyms = await antResponse.json();
          antonyms = antonyms.slice(0, 5).map(item => item.word);
        }
        
        displayThesaurusResults(word, synonyms, antonyms, isArabic, resultsContainer);
      } catch (error) {
        console.error('Thesaurus error:', error);
        resultsContainer.innerHTML = '<div class="error" dir="' + 
          (isRtlMode ? 'rtl' : 'ltr') + '">' +
          (isRtlMode ? 'تعذر العثور على المرادفات' : 'Failed to load thesaurus data') + '</div>';
      }
    }

    // Display Arabic thesaurus results
    function displayThesaurusResults(word, synonyms, antonyms, isArabic, container) {
      let html = `<div class="word-result" dir="${isArabic ? 'rtl' : 'ltr'}">`;
      html += `<h3 class="${isArabic ? 'arabic-text' : ''}">${word}</h3>`;
      
      if (synonyms && synonyms.length > 0) {
        html += `<div class="synonyms">
            <strong>${isArabic ? 'مرادفات' : 'Synonyms'}:</strong>
            <div class="word-list">`;
        
        synonyms.slice(0, 10).forEach(syn => {
          const synWord = isArabic ? syn.word : syn;
          html += `<span class="word-tag ${isArabic ? 'arabic-text' : ''}" 
                    onclick="searchThesaurus('${synWord}')">${synWord}</span>`;
        });
        
        html += `</div></div>`;
      } else {
        html += `<div class="no-results">${isArabic ? 'لا توجد مرادفات' : 'No synonyms found'}</div>`;
      }
      
      if (!isArabic && antonyms && antonyms.length > 0) {
        html += `<div class="antonyms">
            <strong>Antonyms:</strong>
            <div class="word-list">`;
        
        antonyms.forEach(ant => {
          html += `<span class="word-tag antonym" onclick="searchThesaurus('${ant}')">${ant}</span>`;
        });
        
        html += `</div></div>`;
      }
      
      html += `</div>`;
      container.innerHTML = html;
    }

    // Enhanced Arabic translation
    async function translateScreenplay() {
      const elements = document.querySelectorAll('.element');
      const isCurrentlyRtl = document.body.getAttribute('dir') === 'rtl';
      
      if (elements.length === 0) {
        alert(isCurrentlyRtl ? 'لا يوجد محتوى للترجمة' : 'No content to translate');
        return;
      }
      
      const confirmMessage = isCurrentlyRtl ? 
        'هل تريد ترجمة النص بالكامل؟ (يتطلب اتصال بالإنترنت)' : 
        'Translate entire screenplay? (Requires internet connection)';
      
      if (!confirm(confirmMessage)) return;
      
      // Show loading overlay
      const overlay = document.createElement('div');
      overlay.className = 'translation-overlay';
      overlay.innerHTML = `
        <div class="translation-progress">
          <div class="spinner"></div>
          <p>${isCurrentlyRtl ? 'جاري الترجمة...' : 'Translating...'}</p>
        </div>
      `;
      document.body.appendChild(overlay);
      
      try {
        const fromLang = isCurrentlyRtl ? 'ar' : 'en';
        const toLang = isCurrentlyRtl ? 'en' : 'ar';
        let translatedCount = 0;
        
        for (let i = 0; i < elements.length; i++) {
          const element = elements[i];
          const text = element.textContent.trim();
          
          if (text) {
            // For screenplay terms, use our predefined translations
            const elementType = element.className.split(' ')[1];
            let translatedText = translateScreenplayTerm(text, fromLang, toLang, elementType);
            
            if (!translatedText || translatedText === text) {
              // Use offline translation dictionary for common words
              translatedText = translateOffline(text, fromLang, toLang);
            }
            
            if (translatedText && translatedText !== text) {
              element.textContent = translatedText;
              translatedCount++;
              
              // Update progress every 5 elements
              if (i % 5 === 0) {
                overlay.querySelector('p').textContent = 
                  `${isCurrentlyRtl ? 'جاري الترجمة' : 'Translating'} (${i}/${elements.length})`;
              }
            }
          }
        }
        
        // Switch language mode
        document.getElementById('rtl-toggle').click();
        
        // Show completion
        overlay.querySelector('p').innerHTML = 
          `${isCurrentlyRtl ? 'تمت الترجمة بنجاح' : 'Translation complete'}<br>
          ${translatedCount} ${isCurrentlyRtl ? 'عنصر تمت ترجمته' : 'elements translated'}`;
        
        setTimeout(() => document.body.removeChild(overlay), 2000);
      } catch (error) {
        console.error('Translation error:', error);
        overlay.querySelector('p').innerHTML = 
          `${isCurrentlyRtl ? 'فشلت الترجمة' : 'Translation failed'}<br>
          ${isCurrentlyRtl ? 'الرجاء التأكد من اتصال الإنترنت' : 'Please check internet connection'}`;
        setTimeout(() => document.body.removeChild(overlay), 3000);
      }
    }

    // Helper function for screenplay terms translation
    function translateScreenplayTerm(term, fromLang, toLang, elementType) {
      const terms = {
        'en-ar': {
          'EXT.': 'خارجي',
          'INT.': 'داخلي',
          'DAY': 'نهاراً',
          'NIGHT': 'ليلاً',
          'MORNING': 'صباحاً',
          'EVENING': 'مساءً',
          'FADE IN:': 'تظهر الصورة:',
          'FADE OUT.': 'تختفي الصورة.',
          'CUT TO:': 'قطع إلى:',
          'DISSOLVE TO:': 'ذوبان إلى:',
          'SMASH CUT TO:': 'قطع سريع إلى:',
          'JUMP CUT TO:': 'قفز إلى:',
          'MATCH CUT TO:': 'تطابق إلى:',
          'WIPE TO:': 'مسح إلى:',
          'INTERCUT WITH:': 'تقطيع متبادل مع:',
          'BACK TO:': 'العودة إلى:',
          'THE END': 'النهاية',
          'TO BE CONTINUED': 'يتبع'
        },
        'ar-en': {
          'خارجي': 'EXT.',
          'داخلي': 'INT.',
          'نهاراً': 'DAY',
          'ليلاً': 'NIGHT',
          'صباحاً': 'MORNING',
          'مساءً': 'EVENING',
          'تظهر الصورة:': 'FADE IN:',
          'تختفي الصورة.': 'FADE OUT.',
          'قطع إلى:': 'CUT TO:',
          'ذوبان إلى:': 'DISSOLVE TO:',
          'قطع سريع إلى:': 'SMASH CUT TO:',
          'قفز إلى:': 'JUMP CUT TO:',
          'تطابق إلى:': 'MATCH CUT TO:',
          'مسح إلى:': 'WIPE TO:',
          'تقطيع متبادل مع:': 'INTERCUT WITH:',
          'العودة إلى:': 'BACK TO:',
          'النهاية': 'THE END',
          'يتبع': 'TO BE CONTINUED'
        }
      };
      
      // First try exact match
      const translation = terms[`${fromLang}-${toLang}`][term];
      if (translation) return translation;
      
      // Try case-insensitive match
      const lowerTerm = term.toLowerCase();
      for (const key in terms[`${fromLang}-${toLang}`]) {
        if (key.toLowerCase() === lowerTerm) {
          return terms[`${fromLang}-${toLang}`][key];
        }
      }
      
      return null;
    }

    // Offline translation using built-in dictionary
    function translateOffline(text, fromLang, toLang) {
      // Simple word-by-word translation for common terms
      const words = text.split(' ');
      const translatedWords = words.map(word => {
        const cleanWord = word.toLowerCase().replace(/[.,!?;:]/, '');
        return translateScreenplayTerm(cleanWord, fromLang, toLang) || word;
      });
      
      return translatedWords.join(' ');
    }

    // Helper functions for Arabic text formatting
    function isArabicText(text) {
      return /[\u0600-\u06FF]/.test(text);
    }
    
    function applyArabicFormatting(element) {
      element.classList.add('arabic-text');
      element.style.textAlign = 'right';
      element.style.direction = 'rtl';
      element.style.fontFamily = "'Courier New', Courier, 'Traditional Arabic', Arial, sans-serif";
      element.style.letterSpacing = '0';
    }
    
    function removeArabicFormatting(element) {
      element.classList.remove('arabic-text');
      element.style.textAlign = '';
      element.style.direction = '';
      element.style.fontFamily = '';
      element.style.letterSpacing = '';
    }

    function setupListeners() {
      const editor = document.getElementById('editor');
      const notification = document.getElementById('notification');
      
      // Title page button
      document.getElementById('title-page-btn').addEventListener('click', function() {
        document.getElementById('title-page').style.display = 'block';
        document.getElementById('editor').style.display = 'none';
        document.querySelectorAll('.element-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.sidebar-element-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentElement = 'title-page';
      });
      
      // Back to editor button
      document.getElementById('back-to-editor-btn').addEventListener('click', function() {
        document.getElementById('title-page').style.display = 'none';
        document.getElementById('editor').style.display = 'block';
        document.querySelectorAll('.sidebar-element-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('scene-heading-btn').classList.add('active');
        currentElement = 'scene-heading';
      });

      // Element type buttons
      document.querySelectorAll('.element-button').forEach(btn => {
        btn.addEventListener('click', function() {
          // If title page is showing, hide it and show editor
          if (document.getElementById('title-page').style.display === 'block') {
            document.getElementById('title-page').style.display = 'none';
            document.getElementById('editor').style.display = 'block';
          }
          
          currentElement = this.dataset.type;
          document.querySelectorAll('.element-button').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.sidebar-element-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          addNewElement(currentElement);
        });
      });

      // Theme toggle
      document.getElementById('theme-toggle').addEventListener('click', function() {
        const body = document.body;
        const isCurrentlyRtl = body.getAttribute('dir') === 'rtl';
        
        if (body.classList.contains('dark-mode')) {
          body.classList.remove('dark-mode');
          body.classList.add('light');
          this.textContent = isCurrentlyRtl ? 'داكن' : 'DARK';
        } else {
          body.classList.add('dark-mode');
          body.classList.remove('light');
          this.textContent = isCurrentlyRtl ? 'فاتح' : 'LIGHT';
        }
      });

      // RTL toggle
      document.getElementById('rtl-toggle').addEventListener('click', function() {
        isRtlMode = !isRtlMode;
        document.body.setAttribute('dir', isRtlMode ? 'rtl' : 'ltr');
        
        // Preserve sidebar classes when changing RTL mode
        const hasSidebar = editor.classList.contains('with-left-sidebar');
        const hasRightPanel = editor.classList.contains('with-right-panel');
        
        editor.className = isRtlMode ? 'rtl' : 'ltr';
        
        // Restore sidebar classes
        if (hasSidebar) editor.classList.add('with-left-sidebar');
        if (hasRightPanel) editor.classList.add('with-right-panel');
        
        this.textContent = isRtlMode ? 'ENGLISH' : 'ARABIC';
        
        // Update translations and theme button
        if (isRtlMode) {
          translateToArabic();
          // Update theme button to Arabic
          const themeBtn = document.getElementById('theme-toggle');
          if (document.body.classList.contains('dark-mode')) {
            themeBtn.textContent = 'فاتح'; // Show "Light" when in dark mode
          } else {
            themeBtn.textContent = 'داكن'; // Show "Dark" when in light mode
          }
        } else {
          translateToEnglish();
          // Update theme button to English
          const themeBtn = document.getElementById('theme-toggle');
          if (document.body.classList.contains('dark-mode')) {
            themeBtn.textContent = 'LIGHT'; // Show "LIGHT" when in dark mode
          } else {
            themeBtn.textContent = 'DARK'; // Show "DARK" when in light mode
          }
        }
        
        // Update existing elements with proper formatting
        document.querySelectorAll('.element').forEach(el => {
          // Determine element type
          let elementType = null;
          const classes = el.className.split(' ');
          for (const cls of classes) {
            if (['scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition'].includes(cls)) {
              elementType = cls;
              break;
            }
          }
          
          if (elementType) {
            applyElementFormatting(el, elementType);
          }
        });
        
        // Update toolbar language
        updateToolbarLanguage();
      });

      // Translate button
      const translateBtn = document.getElementById('translate-btn');
      if (translateBtn) {
        translateBtn.addEventListener('click', function() {
          console.log('Translate button clicked');
          translateScreenplay();
        });
      } else {
        console.error('Translate button not found');
      }

      // Feedback button
      document.getElementById('feedback-btn').addEventListener('click', function() {
        const feedbackBox = document.getElementById('feedback-box');
        feedbackBox.style.display = feedbackBox.style.display === 'block' ? 'none' : 'block';
      });

      document.getElementById('cancel-feedback-btn').addEventListener('click', function() {
        document.getElementById('feedback-box').style.display = 'none';
      });

      // Bold, italic, underline buttons
      document.getElementById('bold-btn').addEventListener('click', function() {
        toggleFormat('bold');
      });

      document.getElementById('italic-btn').addEventListener('click', function() {
        toggleFormat('italic');
      });

      document.getElementById('underline-btn').addEventListener('click', function() {
        toggleFormat('underline');
      });

      // Spell check button
      document.getElementById('spell-check-btn').addEventListener('click', runSpellCheck);

      // Save, Load, Export
      document.getElementById('save-btn').addEventListener('click', () => {
        document.getElementById('save-modal-container').style.display = 'flex';
        loadSavedScripts();
      });

      document.getElementById('load-btn').addEventListener('click', () => {
        document.getElementById('load-modal-container').style.display = 'flex';
        loadSavedScripts();
      });

      document.getElementById('export-btn').addEventListener('click', () => {
        document.getElementById('export-modal-container').style.display = 'flex';
      });

      // Dictionary and Thesaurus - Enhanced functionality
      document.getElementById('dictionary-btn').addEventListener('click', () => {
        const rightPanel = document.getElementById('right-panel');
        const leftSidebar = document.getElementById('left-sidebar');
        
        // Show right panel and switch to dictionary tab
        rightPanel.classList.add('open');
        document.body.classList.add('right-panel-open');
        
        // Switch to dictionary tab
        switchTab('dictionary');
        
        // Focus on search input
        setTimeout(() => {
          document.getElementById('dict-search').focus();
        }, 100);
      });

      document.getElementById('thesaurus-btn').addEventListener('click', () => {
        const rightPanel = document.getElementById('right-panel');
        
        // Show right panel and switch to thesaurus tab
        rightPanel.classList.add('open');
        document.body.classList.add('right-panel-open');
        
        // Switch to thesaurus tab
        switchTab('thesaurus');
        
        // Focus on search input
        setTimeout(() => {
          document.getElementById('thes-search').focus();
        }, 100);
      });

      // Undo/Redo
      document.getElementById('undo-btn').addEventListener('click', undo);
      document.getElementById('redo-btn').addEventListener('click', redo);

      // Modal close buttons
      document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          this.closest('.modal-container').style.display = 'none';
        });
      });

      // Save modal
      document.getElementById('save-confirm').addEventListener('click', handleSave);

      // Load modal
      document.getElementById('load-confirm').addEventListener('click', handleLoad);

      // Export modal
      document.getElementById('export-confirm').addEventListener('click', handleExport);

      // Tab switching in right panel
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          switchTab(tabName);
        });
      });
      
      // Tab switching function
      function switchTab(tabName) {
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active class to selected tab and content
        const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
        const selectedContent = document.getElementById(`${tabName}-tab`);
        
        if (selectedBtn) selectedBtn.classList.add('active');
        if (selectedContent) selectedContent.classList.add('active');
      }

      // Dictionary and Thesaurus search
      document.getElementById('dict-search').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          searchDictionary(this.value);
        }
      });

      document.getElementById('thes-search').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          searchThesaurus(this.value);
        }
      });

      document.getElementById('dictionary-search').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          searchDictionary(this.value);
        }
      });

      document.getElementById('thesaurus-search').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          searchThesaurus(this.value);
        }
      });

      // Add note button
      document.getElementById('add-note-btn').addEventListener('click', addNote);

      // Sidebar toggle buttons
      document.getElementById('toggle-left-sidebar').addEventListener('click', toggleLeftSidebar);
      document.getElementById('toggle-right-panel').addEventListener('click', toggleRightPanel);

      // Transition dropdown event handling - direct approach
      const transitionDropdown = document.getElementById('transition-dropdown');
      
      // Initialize transition dropdown handlers
      bindTransitionDropdownHandlers();

      // Click outside to hide transition dropdown
      document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('transition-dropdown');
        if (!e.target.closest('#transition-dropdown') && !e.target.closest('.element.transition')) {
          hideTransitionDropdown();
        }
      });

      // Additional transition button click handler
      document.getElementById('transition-btn').addEventListener('click', function() {
        const activeElement = document.querySelector('.active-line');
        if (activeElement && activeElement.classList.contains('transition')) {
          showTransitionDropdown(activeElement);
        } else {
          // Add new transition element
          addNewElement('transition');
          setTimeout(() => {
            const newElement = document.querySelector('.active-line');
            if (newElement && newElement.classList.contains('transition')) {
              // Show dropdown immediately for new transition elements
              showTransitionDropdown(newElement);
            }
          }, 100);
        }
      });

      // Editor events
      editor.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          handleEnterKey();
        } else if (e.key === 'Tab') {
          e.preventDefault();
          cycleElementType();
        }
        
        // Reduced auto-scroll frequency for performance
        setTimeout(() => {
          scrollToCursor();
        }, 200);
      });
      
      // Handle input events for continuous typing
      editor.addEventListener('input', function(e) {
        updateWordCount();
        updatePageCounter();
        saveState();
        
        // Disabled frequent auto-scroll to improve performance
      });
      
      // Removed frequent selectionchange event to improve performance

      editor.addEventListener('click', function(e) {
        // Auto-scroll after click
        setTimeout(() => {
          scrollToCursor();
        }, 10);
        const target = e.target;
        if (target === editor) return;
        
        let element = target;
        while (element && element !== editor && !element.classList.contains('element')) {
          element = element.parentNode;
        }
        
        if (element && element !== editor) {
          document.querySelectorAll('#editor .element').forEach(el => el.classList.remove('active-line'));
          element.classList.add('active-line');
          
          const elementClasses = element.className.split(' ');
          for (const cls of elementClasses) {
            if (['scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition'].includes(cls)) {
              currentElement = cls;
              break;
            }
          }
          
          updateActiveButton();
          
          // Show transition dropdown when clicking on a transition element
          if (currentElement === 'transition') {
            setTimeout(() => showTransitionDropdown(element), 100);
          } else {
            hideTransitionDropdown();
          }
        }
      });

      editor.addEventListener('input', function(e) {
        const activeElement = document.querySelector('.active-line');
        if (!activeElement) return;
        
        const type = activeElement.classList.contains('character') ? 'character' :
                    activeElement.classList.contains('scene-heading') ? 'scene-heading' :
                    activeElement.classList.contains('transition') ? 'transition' : null;
        
        if (type === 'scene-heading' || type === 'character' || type === 'transition') {
          const selection = window.getSelection();
          if (!selection || selection.rangeCount === 0) return;
          
          const range = selection.getRangeAt(0);
          const cursorPosition = range.startOffset;
          const originalText = activeElement.textContent || '';
          activeElement.textContent = originalText.toUpperCase();
          
          // Restore cursor position
          const newRange = document.createRange();
          if (activeElement.firstChild) {
            newRange.setStart(activeElement.firstChild, Math.min(cursorPosition, activeElement.textContent.length));
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
          }
        }
        
        // Update word count and save state
        updateWordCount();
        saveState();
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#character-suggestions') && !e.target.closest('.character')) {
          hideCharacterSuggestions();
        }
        
        if (!e.target.closest('#transition-dropdown') && !e.target.closest('.transition')) {
          hideTransitionDropdown();
        }
      });
    }

    // Add a new screenplay element
    function addNewElement(type, text = '') {
      const editor = document.getElementById('editor');
      const div = document.createElement('div');
      div.className = `element ${type}`;
      div.id = `element-${Date.now()}`;
      div.contentEditable = true;
      
      // Apply RTL formatting if in Arabic mode
      if (isRtlMode) {
        div.classList.add('rtl-element');
        div.dir = 'rtl';
        
        // Override CSS for RTL mode
        if (type === 'scene-heading') {
          div.style.textAlign = 'right';
          div.style.paddingLeft = '0';
          div.style.paddingRight = '0';
        } else if (type === 'action') {
          div.style.textAlign = 'right';
          div.style.paddingLeft = '0';
          div.style.paddingRight = '0';
          div.style.marginRight = '-1.5in';
          div.style.width = 'calc(100% + 1.5in)';
          div.style.position = 'relative';
        } else if (type === 'character') {
          div.style.textAlign = 'right';
          div.style.paddingLeft = '0';
          div.style.paddingRight = '2.2in';
        } else if (type === 'dialogue') {
          div.style.textAlign = 'right';
          div.style.paddingLeft = '1in';
          div.style.paddingRight = '1in';
        } else if (type === 'parenthetical') {
          div.style.textAlign = 'right';
          div.style.paddingLeft = '2.5in';
          div.style.paddingRight = '3.0in';
        } else if (type === 'transition') {
          div.style.textAlign = 'left';
          div.style.paddingLeft = '1.0in';
          div.style.paddingRight = '0';
        }
      } else {
        // Standard LTR formatting
        div.dir = 'ltr';
        if (type === 'transition') {
          div.style.textAlign = 'right';
        }
      }
      
      // Set proper content for each element type
      if (type === 'scene-heading') {
        if (!text) {
          div.textContent = isRtlMode ? 'خارجي. ' : 'EXT. ';
        } else {
          div.textContent = text;
        }
      } else if (type === 'parenthetical' && !text) {
        div.textContent = '()';
      } else if (text) {
        div.textContent = text;
      } else {
        div.innerHTML = '&nbsp;';
      }
      
      const activeElement = document.querySelector('.active-line');
      if (activeElement) {
        activeElement.classList.remove('active-line');
        activeElement.after(div);
      } else {
        editor.appendChild(div);
      }
      
      div.classList.add('active-line');
      
      // Position cursor correctly based on language
      positionCursorCorrectly(div);
      
      if (type === 'character') {
        div.addEventListener('input', function() {
          const text = this.textContent?.trim().toUpperCase() || '';
          if (text.length > 0) {
            showCharacterSuggestions(text, this);
          } else {
            hideCharacterSuggestions();
          }
        });
      }
      
      if (type === 'transition') {
        // Store reference to element for dropdown
        div.setAttribute('data-element-type', 'transition');
        
        // Show dropdown immediately when transition element is created
        setTimeout(() => {
          showTransitionDropdown(div);
        }, 100);
        
        div.addEventListener('click', function(e) {
          e.stopPropagation();
          console.log('Transition element clicked');
          showTransitionDropdown(this);
        });
        
        div.addEventListener('focus', function(e) {
          console.log('Transition element focused');
          showTransitionDropdown(this);
        });
      }
      
      updatePageCounter();
      saveState();
    }

    // Handle Enter key presses
    function handleEnterKey() {
      const activeElement = document.querySelector('.active-line');
      if (!activeElement) return;
      
      let type = null;
      const classes = activeElement.className.split(' ');
      for (const cls of classes) {
        if (['scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition'].includes(cls)) {
          type = cls;
          break;
        }
      }
      
      if (!type) return;
      
      let nextType = 'action';
      
      // Final Draft standard element transitions
      if (type === 'scene-heading') nextType = 'action';
      else if (type === 'action') nextType = 'action';
      else if (type === 'character') {
        const text = activeElement.textContent.trim();
        if (text) {
          nextType = 'dialogue';
          scriptCharacters.add(text.toUpperCase());
        } else {
          nextType = 'character';
        }
      }
      else if (type === 'dialogue') nextType = 'character';
      else if (type === 'parenthetical') nextType = 'dialogue';
      else if (type === 'transition') nextType = 'scene-heading';
      
      addNewElement(nextType);
      currentElement = nextType;
      updateActiveButton();
      
      // Auto-scroll to keep the new line visible
      const newActiveElement = document.querySelector('.active-line');
      if (newActiveElement) {
        scrollToCursor();
        positionCursorCorrectly(newActiveElement);
      }
    }

    // Cycle through element types with Tab key
    function cycleElementType() {
      const activeElement = document.querySelector('.active-line');
      if (!activeElement) return;
      
      let type = null;
      const classes = activeElement.className.split(' ');
      for (const cls of classes) {
        if (['scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition'].includes(cls)) {
          type = cls;
          break;
        }
      }
      
      if (!type) return;
      
      let nextType = 'action';
      
      if (type === 'scene-heading') nextType = 'action';
      else if (type === 'action') nextType = 'character';
      else if (type === 'character') nextType = 'parenthetical';
      else if (type === 'parenthetical') nextType = 'dialogue';
      else if (type === 'dialogue') nextType = 'transition';
      else if (type === 'transition') nextType = 'scene-heading';
      
      // Remove old type and add new type
      activeElement.classList.remove(type);
      activeElement.classList.add(nextType);
      
      // Apply proper formatting based on RTL mode
      applyElementFormatting(activeElement, nextType);
      
      // Set default content and handle special formatting
      if (nextType === 'scene-heading' && (activeElement.textContent.trim() === '' || activeElement.textContent === '\u00A0')) {
        activeElement.textContent = isRtlMode ? 'خارجي. ' : 'EXT. ';
      } else if (nextType === 'parenthetical' && (activeElement.textContent.trim() === '' || activeElement.textContent === '\u00A0')) {
        activeElement.textContent = '()';
      } else if (nextType === 'character' || nextType === 'scene-heading' || nextType === 'transition') {
        // Uppercase text for these elements
        activeElement.textContent = activeElement.textContent.toUpperCase();
      }
      
      // Show transition dropdown when switching to transition
      if (nextType === 'transition') {
        showTransitionDropdown(activeElement);
      }
      
      currentElement = nextType;
      updateActiveButton();
      positionCursorCorrectly(activeElement);
      saveState();
    }

    // Apply proper formatting to an element based on type and RTL mode
    function applyElementFormatting(element, type) {
      // Clear all existing element type classes
      element.classList.remove('scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition');
      
      // Add the new element type class
      element.classList.add(type);
      
      // Reset inline styles to let CSS take over
      element.style.cssText = '';
      
      if (isRtlMode) {
        element.classList.add('rtl-element');
        element.dir = 'rtl';
        
        // Apply RTL-specific overrides only where needed
        if (type === 'scene-heading') {
          element.style.textAlign = 'right';
          element.style.paddingLeft = '0';
          element.style.paddingRight = '20px';
          element.style.marginLeft = '0';
          element.style.marginRight = '-1.5in';
          element.style.width = 'calc(100% + 1.5in)';
          element.style.position = 'relative';
          element.style.display = 'block';
        } else if (type === 'action') {
          element.style.textAlign = 'right';
          element.style.paddingLeft = '0';
          element.style.paddingRight = '0';
        } else if (type === 'character') {
          element.style.textAlign = 'right';
          element.style.paddingLeft = '0';
          element.style.paddingRight = '2.2in';
        } else if (type === 'dialogue') {
          element.style.textAlign = 'right';
          element.style.paddingLeft = '1in';
          element.style.paddingRight = '1in';
        } else if (type === 'parenthetical') {
          element.style.textAlign = 'right';
          element.style.paddingLeft = '1.5in';
          element.style.paddingRight = '1.5in';
        } else if (type === 'transition') {
          element.style.textAlign = 'left';
          element.style.paddingLeft = '0';
          element.style.paddingRight = '0';
        }
      } else {
        element.classList.remove('rtl-element');
        element.dir = 'ltr';
      }
    }

    // Update active button in toolbar
    function updateActiveButton() {
      document.querySelectorAll('.element-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const activeButton = document.querySelector(`.element-button[data-type="${currentElement}"]`);
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }

    // Place cursor at the end of an element
    function setCaretToEnd(el) {
      if (!el) return;
      
      el.focus();
      const range = document.createRange();
      if (el.firstChild) {
        range.setStart(el.firstChild, el.firstChild.textContent.length);
      } else {
        range.setStart(el, 0);
      }
      range.collapse(true);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
    }

    // Show character suggestions dropdown
    function showCharacterSuggestions(text, element) {
      if (!text) return;
      
      const characterSuggestions = document.getElementById('character-suggestions');
      if (!characterSuggestions) return;
      
      const matches = Array.from(scriptCharacters).filter(char => 
        char.includes(text) && char !== text
      );
      
      if (matches.length > 0) {
        characterSuggestions.innerHTML = '';
        const rect = element.getBoundingClientRect();
        characterSuggestions.style.top = `${rect.bottom + window.scrollY}px`;
        characterSuggestions.style.left = `${rect.left + window.scrollX}px`;
        characterSuggestions.style.display = 'block';
        
        matches.forEach(char => {
          const item = document.createElement('div');
          item.className = 'character-suggestion-item';
          item.textContent = char;
          item.addEventListener('click', () => {
            element.textContent = char;
            hideCharacterSuggestions();
            addNewElement('dialogue');
          });
          characterSuggestions.appendChild(item);
        });
      } else {
        hideCharacterSuggestions();
      }
    }

    // Hide character suggestions
    function hideCharacterSuggestions() {
      const characterSuggestions = document.getElementById('character-suggestions');
      if (characterSuggestions) {
        characterSuggestions.style.display = 'none';
      }
    }

    // Show transition dropdown
    function showTransitionDropdown(element) {
      const dropdown = document.getElementById('transition-dropdown');
      if (!dropdown) return;
      
      // Store reference to active element
      window.currentTransitionElement = element;
      
      // Position dropdown
      const rect = element.getBoundingClientRect();
      dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
      dropdown.style.left = `${rect.left + window.scrollX}px`;
      dropdown.style.display = 'block';
      dropdown.style.zIndex = '9999';
      
      // Update dropdown language immediately
      updateTransitionDropdown();
      
      console.log('Transition dropdown shown');
    }

    // Hide transition dropdown
    function hideTransitionDropdown() {
      const dropdown = document.getElementById('transition-dropdown');
      if (dropdown) {
        dropdown.style.display = 'none';
      }
    }

    // Update page counter based on scroll position
    function updatePageCounter() {
      const editor = document.getElementById('editor');
      const elements = editor.querySelectorAll('.element');
      
      if (elements.length === 0) {
        pageCount = 1;
        updatePageCounterDisplay(1, 1);
        return;
      }
      
      // Calculate current page based on scroll position
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const pageHeight = 11 * 72; // 11 inches at 72 DPI
      const currentPage = Math.max(1, Math.floor(scrollTop / pageHeight) + 1);
      
      // Calculate total pages based on content height
      const totalHeight = editor.scrollHeight;
      const totalPages = Math.max(1, Math.ceil(totalHeight / pageHeight));
      
      pageCount = currentPage;
      updatePageCounterDisplay(currentPage, totalPages);
    }

    // Update page counter display based on language mode
    function updatePageCounterDisplay(currentPage, totalPages) {
      const isRtlMode = document.body.getAttribute('dir') === 'rtl';
      const originalCounter = document.getElementById('page-counter');
      const sidebarCounter = document.getElementById('sidebar-page-counter');
      
      const pageText = `Page ${currentPage} of ${totalPages}`;
      
      if (isRtlMode) {
        // In RTL mode, show original counter, hide sidebar counter
        if (originalCounter) {
          originalCounter.textContent = pageText;
          originalCounter.style.display = 'block';
        }
        if (sidebarCounter) {
          sidebarCounter.style.display = 'none';
        }
      } else {
        // In LTR mode, hide original counter, show sidebar counter
        if (originalCounter) {
          originalCounter.style.display = 'none';
        }
        if (sidebarCounter) {
          sidebarCounter.textContent = pageText;
          sidebarCounter.style.display = 'block';
        }
      }
    }
    
    // Add scroll listener for page counter
    window.addEventListener('scroll', updatePageCounter);

    // Update word count and character count
    function updateWordCount() {
      const editor = document.getElementById('editor');
      const text = editor.textContent || '';
      
      wordCount = text.trim().split(/\s+/).filter(word => word.length > 0).length;
      characterCount = text.length;
      
      const runtime = Math.ceil(wordCount / 250); // Approximate runtime calculation
      
      document.getElementById('word-count').textContent = `Words: ${wordCount}`;
      document.getElementById('char-count').textContent = `Characters: ${characterCount}`;
      document.getElementById('runtime').textContent = `Runtime: ${runtime} min`;
    }

    // Translate button text to Arabic
    function translateToArabic() {
      // Update specific buttons by ID
      const buttonTranslations = {
        'undo-btn': '↶',
        'redo-btn': '↷',
        'bold-btn': 'B',
        'italic-btn': 'I',
        'underline-btn': 'U',
        'thesaurus-btn': 'قاموس المرادفات',
        'dictionary-btn': 'القاموس',
        'spell-check-btn': 'التدقيق الإملائي',
        'save-btn': 'حفظ',
        'load-btn': 'تحميل',
        'export-btn': 'تصدير',
        'translate-btn': 'ترجمة',
        'feedback-btn': 'تعليقات',
        'project-btn': 'المشروع',
        'tools-btn': 'الأدوات'
      };

      Object.keys(buttonTranslations).forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.textContent = buttonTranslations[buttonId];
        }
      });

      // Translate sidebar element buttons
      const elementButtons = {
        'title-page-btn': 'صفحة العنوان',
        'scene-heading-btn': 'عنوان المشهد',
        'action-btn': 'الحدث',
        'character-btn': 'الشخصية',
        'dialogue-btn': 'الحوار',
        'parenthetical-btn': 'تعليق',
        'transition-btn': 'انتقال'
      };

      Object.keys(elementButtons).forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.textContent = elementButtons[buttonId];
        }
      });
      
      // Translate sidebar headers
      document.querySelectorAll('h3, h4').forEach(header => {
        if (header.textContent.trim() === 'Project') {
          header.textContent = 'المشروع';
        } else if (header.textContent.trim() === 'Tools') {
          header.textContent = 'الأدوات';
        } else if (header.textContent.trim() === 'Elements') {
          header.textContent = 'العناصر';
        }
      });
      
      // Translate tab buttons
      document.querySelectorAll('.tab-btn').forEach(tab => {
        if (tab.textContent.trim() === 'Dictionary') {
          tab.textContent = 'القاموس';
        } else if (tab.textContent.trim() === 'Thesaurus') {
          tab.textContent = 'المرادفات';
        } else if (tab.textContent.trim() === 'Notes') {
          tab.textContent = 'الملاحظات';
        }
      });
    }

    // Translate button text to English
    function translateToEnglish() {
      // Update specific buttons by ID back to English
      const buttonTranslations = {
        'undo-btn': '↶',
        'redo-btn': '↷',
        'bold-btn': 'B',
        'italic-btn': 'I',
        'underline-btn': 'U',
        'thesaurus-btn': 'THESAURUS',
        'dictionary-btn': 'DICTIONARY',
        'spell-check-btn': 'SPELL CHECK',
        'save-btn': 'SAVE',
        'load-btn': 'LOAD',
        'export-btn': 'EXPORT',
        'translate-btn': 'TRANSLATE',
        'feedback-btn': 'FEEDBACK',
        'project-btn': 'PROJECT',
        'tools-btn': 'TOOLS'
      };

      Object.keys(buttonTranslations).forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.textContent = buttonTranslations[buttonId];
        }
      });

      // Translate sidebar element buttons back to English
      const elementButtons = {
        'title-page-btn': 'TITLE PAGE',
        'scene-heading-btn': 'SCENE HEADING',
        'action-btn': 'ACTION',
        'character-btn': 'CHARACTER',
        'dialogue-btn': 'DIALOGUE',
        'parenthetical-btn': 'PARENTHETICAL',
        'transition-btn': 'TRANSITION'
      };

      Object.keys(elementButtons).forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.textContent = elementButtons[buttonId];
        }
      });
      
      // Translate sidebar headers back to English
      document.querySelectorAll('h3, h4').forEach(header => {
        if (header.textContent.trim() === 'المشروع') {
          header.textContent = 'Project';
        } else if (header.textContent.trim() === 'الأدوات') {
          header.textContent = 'Tools';
        } else if (header.textContent.trim() === 'العناصر') {
          header.textContent = 'Elements';
        }
      });
      
      // Translate tab buttons back to English
      document.querySelectorAll('.tab-btn').forEach(tab => {
        if (tab.textContent.trim() === 'القاموس') {
          tab.textContent = 'Dictionary';
        } else if (tab.textContent.trim() === 'المرادفات') {
          tab.textContent = 'Thesaurus';
        } else if (tab.textContent.trim() === 'الملاحظات') {
          tab.textContent = 'Notes';
        }
      });
      

    }

    // Toggle RTL mode
    function toggleRTL() {
      isRtlMode = !isRtlMode;
      const editor = document.getElementById('editor');
      const body = document.body;
      
      if (isRtlMode) {
        body.setAttribute('dir', 'rtl');
        editor.classList.add('rtl');
        editor.classList.remove('ltr');
        document.getElementById('rtl-btn').textContent = 'English';
        document.getElementById('back-to-home-btn').style.display = 'none';
        translateToArabic();
        updateTransitionDropdown();
      } else {
        body.setAttribute('dir', 'ltr');
        editor.classList.remove('rtl');
        editor.classList.add('ltr');
        document.getElementById('rtl-btn').textContent = 'عربي';
        document.getElementById('back-to-home-btn').style.display = 'inline-block';
        translateToEnglish();
        updateTransitionDropdown();
      }
      
      // Re-position cursor correctly after RTL toggle
      const activeElement = document.querySelector('.active-line');
      if (activeElement) {
        positionCursorCorrectly(activeElement);
      }
    }

    // Initialize sidebars
    function initializeSidebars() {
      // Add sidebar toggle buttons to toolbar
      const firstToolbarRow = document.querySelector('.toolbar-row');
      
      const leftSidebarBtn = document.createElement('button');
      leftSidebarBtn.id = 'project-btn';
      leftSidebarBtn.textContent = 'PROJECT';
      leftSidebarBtn.addEventListener('click', toggleLeftSidebar);
      firstToolbarRow.insertBefore(leftSidebarBtn, firstToolbarRow.firstChild);

      const rightPanelBtn = document.createElement('button');
      rightPanelBtn.id = 'tools-btn';
      rightPanelBtn.textContent = 'TOOLS';
      rightPanelBtn.addEventListener('click', toggleRightPanel);
      firstToolbarRow.appendChild(rightPanelBtn);
    }

    // Toggle left sidebar
    function toggleLeftSidebar() {
      leftSidebarOpen = !leftSidebarOpen;
      const sidebar = document.getElementById('left-sidebar');
      const editor = document.getElementById('editor');
      
      if (leftSidebarOpen) {
        sidebar.classList.add('open');
        editor.classList.add('with-left-sidebar');
      } else {
        sidebar.classList.remove('open');
        editor.classList.remove('with-left-sidebar');
      }
    }

    // Toggle right panel
    function toggleRightPanel() {
      rightPanelOpen = !rightPanelOpen;
      const panel = document.getElementById('right-panel');
      const editor = document.getElementById('editor');
      
      if (rightPanelOpen) {
        panel.classList.add('open');
        editor.classList.add('with-right-panel');
      } else {
        panel.classList.remove('open');
        editor.classList.remove('with-right-panel');
      }
    }

    // Switch tabs in right panel
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }



    // Formatting functions
    function toggleFormat(format) {
      const activeElement = document.querySelector('.active-line');
      if (!activeElement) return;

      const button = document.getElementById(`${format}-btn`);
      const isActive = button.classList.contains('format-active');
      
      if (isActive) {
        activeElement.style[format] = '';
        button.classList.remove('format-active');
      } else {
        if (format === 'bold') activeElement.style.fontWeight = 'bold';
        else if (format === 'italic') activeElement.style.fontStyle = 'italic';
        else if (format === 'underline') activeElement.style.textDecoration = 'underline';
        button.classList.add('format-active');
      }
    }

    // Spell check functions
    function runSpellCheck() {
      spellCheckEnabled = !spellCheckEnabled;
      const button = document.getElementById('spell-check-btn');
      
      if (spellCheckEnabled) {
        button.textContent = 'SPELL CHECK: ON';
        button.style.backgroundColor = '#6b458e';
        performSpellCheck();
      } else {
        button.textContent = 'SPELL CHECK: OFF';
        button.style.backgroundColor = '';
        clearSpellCheck();
      }
    }

    function performSpellCheck() {
      const elements = document.querySelectorAll('.element');
      elements.forEach(element => {
        const text = element.textContent;
        const words = text.split(/\s+/);
        
        words.forEach(word => {
          // Basic spell check - mark common misspellings
          const cleanWord = word.replace(/[^\w]/g, '').toLowerCase();
          if (cleanWord.length > 3 && isCommonMisspelling(cleanWord)) {
            highlightMisspelling(element, word);
          }
        });
      });
    }

    function isCommonMisspelling(word) {
      const misspellings = ['teh', 'recieve', 'seperate', 'occured', 'acheive', 'beleive', 'neccessary'];
      return misspellings.includes(word);
    }

    function highlightMisspelling(element, word) {
      const content = element.innerHTML;
      const highlighted = content.replace(new RegExp(`\\b${word}\\b`, 'gi'), 
        `<span class="spell-error" style="border-bottom: 2px wavy red;">${word}</span>`);
      element.innerHTML = highlighted;
    }

    function clearSpellCheck() {
      const spellErrors = document.querySelectorAll('.spell-error');
      spellErrors.forEach(error => {
        error.outerHTML = error.textContent;
      });
    }

    // Save/Load/Export functions
    function loadSavedScripts() {
      const scripts = JSON.parse(localStorage.getItem('fade_out_scripts') || '{}');
      const list = document.getElementById('saved-scripts-list');
      list.innerHTML = '';
      
      Object.keys(scripts).forEach(scriptName => {
        const item = document.createElement('div');
        item.className = 'saved-script-item';
        item.textContent = scriptName;
        item.setAttribute('data-name', scriptName);
        item.addEventListener('click', function() {
          document.querySelectorAll('.saved-script-item').forEach(el => el.classList.remove('selected'));
          this.classList.add('selected');
        });
        list.appendChild(item);
      });
    }

    function handleSave() {
      const title = document.getElementById('save-script-title').value.trim() || 'Untitled Script';
      const location = document.getElementById('save-location').value;
      const format = document.getElementById('save-format').value;
      const content = document.getElementById('editor').innerHTML;
      
      if (location === 'local') {
        const scripts = JSON.parse(localStorage.getItem('fade_out_scripts') || '{}');
        scripts[title] = {
          content,
          characters: Array.from(scriptCharacters),
          timestamp: Date.now(),
          title: document.getElementById('script-title').value,
          author: document.getElementById('written-by').value,
          format,
          notes: currentNotes
        };
        localStorage.setItem('fade_out_scripts', JSON.stringify(scripts));
        showNotification(`Script "${title}" saved to browser storage`);
        
        // Update project info in sidebar
        updateProjectInfo();
      } else if (location === 'cloud') {
        showNotification('Cloud storage requires API configuration. Please provide cloud storage credentials.');
      } else {
        downloadScript(title, content, format);
        
        // Update project info in sidebar
        updateProjectInfo();
      }
      
      document.getElementById('save-modal-container').style.display = 'none';
    }

    function handleLoad() {
      const location = document.getElementById('load-location').value;
      
      if (location === 'local') {
        const selected = document.querySelector('.saved-script-item.selected');
        if (!selected) {
          showNotification('Please select a script to load');
          return;
        }
        
        const scriptName = selected.getAttribute('data-name');
        const scripts = JSON.parse(localStorage.getItem('fade_out_scripts') || '{}');
        
        if (scripts[scriptName]) {
          document.getElementById('editor').innerHTML = scripts[scriptName].content;
          if (scripts[scriptName].characters) {
            scriptCharacters = new Set(scripts[scriptName].characters);
          }
          
          document.getElementById('script-title').value = scripts[scriptName].title || '';
          document.getElementById('written-by').value = scripts[scriptName].author || '';
          
          currentNotes = scripts[scriptName].notes || [];
          
          showNotification(`Script "${scriptName}" loaded successfully`);
          updatePageCounter();
          updateWordCount();
          
          // Update project info in sidebar
          updateProjectInfo();
        }
      } else if (location === 'upload') {
        const fileInput = document.getElementById('script-upload');
        if (fileInput.files.length === 0) {
          showNotification('Please select a file to upload');
          return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          document.getElementById('editor').innerHTML = e.target.result;
          showNotification(`Script "${file.name}" loaded successfully`);
          updatePageCounter();
          updateWordCount();
        };
        
        reader.readAsText(file);
      } else if (location === 'cloud') {
        showNotification('Cloud storage requires API configuration. Please provide cloud storage credentials.');
      }
      
      document.getElementById('load-modal-container').style.display = 'none';
    }

    function handleExport() {
      const format = document.getElementById('export-format').value;
      let filename = document.getElementById('export-filename').value.trim();
      const includeTitle = document.getElementById('include-title-page').checked;
      const includeNotes = document.getElementById('include-notes').checked;
      
      if (!filename) {
        filename = document.getElementById('script-title').value.trim() || 'Untitled Script';
      }
      
      const content = document.getElementById('editor').innerHTML;
      downloadScript(filename, content, format, includeTitle, includeNotes);
      
      document.getElementById('export-modal-container').style.display = 'none';
    }

    function downloadScript(filename, content, format, includeTitle = false, includeNotes = false) {
      let blob, extension;
      let exportContent = content;
      
      if (includeTitle) {
        const title = document.getElementById('script-title').value;
        const author = document.getElementById('written-by').value;
        exportContent = `<div class="title-page"><h1>${title}</h1><h2>by ${author}</h2></div>${content}`;
      }
      
      if (includeNotes && currentNotes.length > 0) {
        const notesHtml = currentNotes.map(note => `<div class="note"><strong>${note.title}</strong>: ${note.content}</div>`).join('');
        exportContent += `<div class="notes-section"><h3>Notes</h3>${notesHtml}</div>`;
      }
      
      switch (format) {
        case 'pdf':
          const pdfContent = generatePDFContent(exportContent, filename);
          // Open the PDF content in a new window for printing as PDF
          const pdfWindow = window.open('', '_blank');
          pdfWindow.document.write(pdfContent);
          pdfWindow.document.close();
          
          // Add improved instructions for PDF export
          pdfWindow.onload = function() {
            const instructionDiv = pdfWindow.document.createElement('div');
            instructionDiv.className = 'no-print';
            instructionDiv.innerHTML = `
              <div style="position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; z-index: 9999; font-family: Arial, sans-serif; box-shadow: 0 8px 25px rgba(0,0,0,0.3); max-width: 300px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <strong style="font-size: 16px;">📄 Export to PDF</strong>
                  <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-weight: bold;">×</button>
                </div>
                <div style="font-size: 14px; line-height: 1.5; margin-bottom: 15px;">
                  <strong>Quick Steps:</strong><br>
                  1. Press <kbd style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Ctrl+P</kbd> (or <kbd style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px; font-family: monospace;">Cmd+P</kbd> on Mac)<br>
                  2. Choose "Save as PDF" as destination<br>
                  3. Ensure margins are set to "Minimum"<br>
                  4. Click "Save"
                </div>
                <div style="display: flex; gap: 10px;">
                  <button onclick="window.print()" style="flex: 1; padding: 10px; background: white; color: #667eea; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s;">🖨️ Print Now</button>
                  <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Close</button>
                </div>
              </div>
            `;
            pdfWindow.document.body.appendChild(instructionDiv);
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
              const instruction = pdfWindow.document.querySelector('.no-print');
              if (instruction) {
                instruction.style.opacity = '0';
                instruction.style.transition = 'opacity 0.5s';
                setTimeout(() => instruction.remove(), 500);
              }
            }, 15000);
          };
          
          showNotification('PDF preview opened. Use Ctrl+P to save as PDF.');
          return; // Don't proceed with download
        case 'html':
          const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${filename}</title><style>body{font-family:Courier,monospace;line-height:1.5;margin:40px}.scene-heading{text-transform:uppercase;font-weight:bold;margin:1.5em 0 1em 0;padding-left:1.6in;padding-right:1.6in}.action{margin:1em 0;padding-left:1.6in;padding-right:1.6in}.character{margin:1.5em 0 0 0;padding-left:3.6in;padding-right:3.6in;font-weight:bold;text-transform:uppercase}.dialogue{margin:0.5em 0 1.5em 0;padding-left:2.6in;padding-right:2.6in}.parenthetical{font-style:italic;margin:0.5em 0;padding-left:3.1in;padding-right:3.1in}.transition{margin:1.5em 0;padding-right:1.6in;font-weight:bold;text-transform:uppercase;text-align:right}</style></head><body>${exportContent}</body></html>`;
          blob = new Blob([htmlContent], {type: 'text/html'});
          extension = 'html';
          break;
        case 'fdx':
          const fdxContent = `<?xml version="1.0" encoding="UTF-8"?><FinalDraft DocumentType="Script" Template="No" Version="1"><Content>${exportContent}</Content></FinalDraft>`;
          blob = new Blob([fdxContent], {type: 'application/xml'});
          extension = 'fdx';
          break;
        case 'fountain':
          const fountainContent = convertToFountain(exportContent);
          blob = new Blob([fountainContent], {type: 'text/plain'});
          extension = 'fountain';
          break;
        default:
          blob = new Blob([exportContent], {type: 'text/plain'});
          extension = 'txt';
      }
      
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${filename.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.${extension}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification(`Script exported as ${format.toUpperCase()}`);
    }

    function generatePDFContent(content, filename) {
      // Generate properly formatted HTML for PDF printing with industry-standard screenplay formatting
      const title = document.getElementById('script-title').value || 'Untitled Script';
      const author = document.getElementById('written-by').value || 'Unknown Author';
      const isRtlMode = document.body.getAttribute('dir') === 'rtl';
      
      // Process content to ensure proper formatting
      const processedContent = processContentForPDF(content);
      
      return `<!DOCTYPE html>
<html${isRtlMode ? ' dir="rtl"' : ''}>
<head>
    <meta charset="UTF-8">
    <title>${filename}</title>
    <style>
        @page {
            size: 8.5in 11in;
            margin: 1in 1.5in 1in 1in;
            @bottom-right {
                content: counter(page);
                font-family: 'Courier New', monospace;
                font-size: 12pt;
            }
        }
        
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
        }
        
        body {
            font-family: 'Courier New', Monaco, 'Lucida Console', monospace;
            font-size: 12pt;
            line-height: 1.0;
            color: #000;
            margin: 0;
            padding: 0;
            background: white;
            ${isRtlMode ? 'direction: rtl; text-align: right;' : ''}
        }
        
        /* Title Page Formatting */
        .title-page {
            page-break-after: always;
            text-align: center;
            margin-top: 3in;
            font-family: 'Courier New', monospace;
        }
        .title-page h1 {
            font-size: 24pt;
            font-weight: bold;
            margin-bottom: 0.5in;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .title-page h2 {
            font-size: 14pt;
            font-weight: normal;
            margin-bottom: 3in;
        }
        .title-page .contact-info {
            position: absolute;
            bottom: 2in;
            left: 1in;
            text-align: left;
            font-size: 10pt;
        }
        
        /* Industry Standard Screenplay Formatting */
        .script-content {
            line-height: 1.0;
            font-size: 12pt;
        }
        
        .element {
            margin: 0;
            padding: 0;
            page-break-inside: avoid;
            orphans: 2;
            widows: 2;
        }
        
        /* Scene Heading: Left margin 1.5", ALL CAPS, BOLD */
        .scene-heading {
            text-transform: uppercase;
            font-weight: bold;
            margin: 24pt 0 12pt 0;
            margin-left: ${isRtlMode ? '0' : '0in'};
            margin-right: ${isRtlMode ? '0in' : '0'};
            page-break-after: avoid;
            text-align: ${isRtlMode ? 'right' : 'left'};
        }
        
        /* Action: Left margin 1.5", right margin 1.2" */
        .action {
            margin: 12pt 0;
            margin-left: ${isRtlMode ? '0' : '0in'};
            margin-right: ${isRtlMode ? '0in' : '1.2in'};
            text-align: ${isRtlMode ? 'right' : 'left'};
            line-height: 1.0;
        }
        
        /* Character: Left margin 3.7", ALL CAPS, BOLD */
        .character {
            margin: 24pt 0 0 0;
            margin-left: ${isRtlMode ? '0' : '3.7in'};
            margin-right: ${isRtlMode ? '3.7in' : '0'};
            font-weight: bold;
            text-transform: uppercase;
            page-break-after: avoid;
            text-align: ${isRtlMode ? 'right' : 'left'};
        }
        
        /* Dialogue: Left margin 2.5", right margin 2.5" */
        .dialogue {
            margin: 0 0 12pt 0;
            margin-left: ${isRtlMode ? '2.5in' : '2.5in'};
            margin-right: ${isRtlMode ? '2.5in' : '2.5in'};
            text-align: ${isRtlMode ? 'right' : 'left'};
            line-height: 1.0;
        }
        
        /* Parenthetical: Left margin 3.0", right margin 3.0", ITALIC */
        .parenthetical {
            font-style: italic;
            margin: 0 0 6pt 0;
            margin-left: ${isRtlMode ? '3.0in' : '3.0in'};
            margin-right: ${isRtlMode ? '3.0in' : '3.0in'};
            text-align: ${isRtlMode ? 'right' : 'left'};
        }
        
        /* Transition: Right aligned, ALL CAPS, BOLD */
        .transition {
            margin: 24pt 0 12pt 0;
            text-align: ${isRtlMode ? 'left' : 'right'};
            font-weight: bold;
            text-transform: uppercase;
            page-break-before: avoid;
        }
        
        /* Arabic-specific styles */
        ${isRtlMode ? `
        .arabic-text {
            font-family: 'Traditional Arabic', 'Courier New', Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }
        ` : ''}
        
        /* Page numbering and headers */
        .page-header {
            position: fixed;
            top: 0.5in;
            right: 1in;
            font-size: 12pt;
            font-family: 'Courier New', monospace;
        }
        
        /* Notes section */
        .notes-section {
            page-break-before: always;
            margin-top: 1in;
        }
        .notes-section h3 {
            font-size: 14pt;
            font-weight: bold;
            margin-bottom: 0.5in;
            text-transform: uppercase;
        }
        .note {
            margin-bottom: 1em;
            padding: 0.5em;
            border-left: 3px solid #333;
            background: #f9f9f9;
        }
        
        /* Ensure proper page breaks */
        .character + .dialogue {
            page-break-before: avoid;
        }
        .parenthetical + .dialogue {
            page-break-before: avoid;
        }
        
        /* Print-specific adjustments */
        @media print {
            .element {
                page-break-inside: avoid;
            }
            .character {
                page-break-after: avoid;
            }
            .scene-heading {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Title Page -->
    <div class="title-page">
        <h1>${title}</h1>
        <h2>Written by<br>${author}</h2>
        <div class="contact-info">
            <div>Draft: ${new Date().toLocaleDateString()}</div>
        </div>
    </div>
    
    <!-- Script Content -->
    <div class="script-content">
        ${processedContent}
    </div>
</body>
</html>`;
    }

    // Process content for proper PDF formatting
    function processContentForPDF(content) {
      const div = document.createElement('div');
      div.innerHTML = content;
      
      let processedHTML = '';
      
      // Process each element and ensure proper formatting
      div.querySelectorAll('.element').forEach(el => {
        const className = el.className.replace('element ', '').replace(' rtl-element', '').replace(' active-line', '').trim();
        const text = el.textContent.trim();
        
        if (text) {
          // Apply proper CSS classes for PDF formatting
          let elementClass = className;
          
          // Ensure Arabic text gets proper styling
          const isArabic = /[\u0600-\u06FF]/.test(text);
          if (isArabic) {
            elementClass += ' arabic-text';
          }
          
          processedHTML += `<div class="element ${elementClass}">${text}</div>\n`;
        }
      });
      
      return processedHTML;
    }

    function convertToFountain(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      let fountain = '';
      
      div.querySelectorAll('.element').forEach(el => {
        const className = el.className.replace('element ', '').replace(' rtl-element', '').replace(' active-line', '');
        const text = el.textContent.trim();
        
        switch (className) {
          case 'scene-heading':
            fountain += `${text}\n\n`;
            break;
          case 'action':
            fountain += `${text}\n\n`;
            break;
          case 'character':
            fountain += `${text}\n`;
            break;
          case 'dialogue':
            fountain += `${text}\n\n`;
            break;
          case 'parenthetical':
            fountain += `(${text})\n`;
            break;
          case 'transition':
            fountain += `${text}\n\n`;
            break;
        }
      });
      
      return fountain;
    }

    function previewPDF() {
      const content = document.getElementById('editor').innerHTML;
      const filename = document.getElementById('script-title').value || 'Untitled Script';
      const pdfContent = generatePDFContent(content, filename);
      
      // Open preview in new window
      const previewWindow = window.open('', '_blank');
      previewWindow.document.write(pdfContent);
      previewWindow.document.close();
      
      // Add print button to preview
      previewWindow.onload = function() {
        const printBtn = previewWindow.document.createElement('button');
        printBtn.innerHTML = 'Print as PDF';
        printBtn.style.position = 'fixed';
        printBtn.style.top = '10px';
        printBtn.style.right = '10px';
        printBtn.style.zIndex = '9999';
        printBtn.style.padding = '10px 20px';
        printBtn.style.backgroundColor = '#007bff';
        printBtn.style.color = 'white';
        printBtn.style.border = 'none';
        printBtn.style.borderRadius = '5px';
        printBtn.style.cursor = 'pointer';
        printBtn.onclick = function() {
          previewWindow.print();
        };
        previewWindow.document.body.appendChild(printBtn);
      };
    }

    function goBackToHome() {
      // Navigate back to main screen/home page
      // This is a placeholder for home navigation
      // Since this is a single-page app, we can show a welcome screen or reload the app
      if (confirm('Go back to home screen? Any unsaved changes will be lost.')) {
        location.reload();
      }
    }

    // Comprehensive Dictionary Database
    const dictionaryData = {
      "action": {
        "pronunciation": "/ˈækʃən/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The fact or process of doing something", "example": "The committee must take action" },
          { "partOfSpeech": "noun", "meaning": "In screenwriting, descriptive text that describes what happens on screen", "example": "Action lines should be concise and visual" }
        ]
      },
      "scene": {
        "pronunciation": "/siːn/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A sequence of continuous action in a play, movie, or book", "example": "The opening scene takes place in a coffee shop" }
        ]
      },
      "character": {
        "pronunciation": "/ˈkærəktər/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A person in a novel, play, or movie", "example": "The main character faces many challenges" },
          { "partOfSpeech": "noun", "meaning": "The mental and moral qualities distinctive to an individual", "example": "She has a strong character" }
        ]
      },
      "dialogue": {
        "pronunciation": "/ˈdaɪəlɔːɡ/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "Conversation between two or more people as a feature of a book, play, or movie", "example": "The dialogue in this script feels natural" },
          { "partOfSpeech": "noun", "meaning": "A discussion between two or more people or groups", "example": "The dialogue between nations was productive" }
        ]
      },
      "screenplay": {
        "pronunciation": "/ˈskriːnpleɪ/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The script of a movie, including acting instructions and scene directions", "example": "She wrote a compelling screenplay about friendship" }
        ]
      },
      "fade": {
        "pronunciation": "/feɪd/",
        "definitions": [
          { "partOfSpeech": "verb", "meaning": "Gradually grow faint and disappear", "example": "The image fades to black" },
          { "partOfSpeech": "noun", "meaning": "A gradual transition in film or television", "example": "The scene ends with a fade to black" }
        ]
      },
      "cut": {
        "pronunciation": "/kʌt/",
        "definitions": [
          { "partOfSpeech": "verb", "meaning": "Make an abrupt transition from one scene to another", "example": "Cut to the interior of the house" },
          { "partOfSpeech": "noun", "meaning": "An abrupt transition between scenes", "example": "The cut to the flashback was seamless" },
          { "partOfSpeech": "verb", "meaning": "To divide or separate with a sharp implement", "example": "Cut the rope with scissors" }
        ]
      },
      "transition": {
        "pronunciation": "/trænˈzɪʃən/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A change from one scene or state to another", "example": "The transition between acts was smooth" },
          { "partOfSpeech": "verb", "meaning": "To undergo or cause to undergo a change", "example": "The story transitions to a new setting" }
        ]
      },
      "interior": {
        "pronunciation": "/ɪnˈtɪriər/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The inner part of something; the inside", "example": "The interior of the house was beautifully decorated" },
          { "partOfSpeech": "adjective", "meaning": "Situated on or relating to the inside", "example": "Interior shots are filmed indoors" }
        ]
      },
      "exterior": {
        "pronunciation": "/ɪkˈstɪriər/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The outer surface or structure of something", "example": "The exterior of the building needs painting" },
          { "partOfSpeech": "adjective", "meaning": "Forming, situated on, or relating to the outside", "example": "Exterior scenes are shot outdoors" }
        ]
      },
      "montage": {
        "pronunciation": "/mɒnˈtɑːʒ/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A sequence of film or video clips edited together", "example": "The training montage showed his progress over months" }
        ]
      },
      "flashback": {
        "pronunciation": "/ˈflæʃbæk/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A scene in a movie showing events that happened earlier", "example": "The flashback revealed the character's motivation" }
        ]
      },
      "voiceover": {
        "pronunciation": "/ˈvɔɪsəʊvər/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "Narration spoken by an unseen narrator in a film", "example": "The voiceover provided context for the story" }
        ]
      },
      "subplot": {
        "pronunciation": "/ˈsʌbplɒt/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A secondary plot in a story", "example": "The romantic subplot added depth to the main story" }
        ]
      },
      "antagonist": {
        "pronunciation": "/ænˈtæɡənɪst/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A character who opposes the protagonist", "example": "The antagonist's motives were slowly revealed" }
        ]
      },
      "protagonist": {
        "pronunciation": "/prəˈtæɡənɪst/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The main character in a story", "example": "The protagonist faces many challenges throughout the film" }
        ]
      },
      "climax": {
        "pronunciation": "/ˈklaɪmæks/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The most intense or exciting point in a story", "example": "The climax occurs in the final act" }
        ]
      },
      "resolution": {
        "pronunciation": "/ˌrezəˈluːʃən/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The conclusion of a story where conflicts are resolved", "example": "The resolution tied up all loose ends" }
        ]
      },
      "conflict": {
        "pronunciation": "/ˈkɒnflɪkt/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A struggle between opposing forces in a story", "example": "The central conflict drives the narrative forward" }
        ]
      },
      "theme": {
        "pronunciation": "/θiːm/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The main subject or idea of a story", "example": "The theme of redemption runs throughout the screenplay" }
        ]
      },
      "script": {
        "pronunciation": "/skrɪpt/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The written text of a play, movie, or broadcast", "example": "The actors studied their scripts carefully" }
        ]
      },
      "interior": {
        "pronunciation": "/ɪnˈtɪəriər/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The inner part of something; an indoor scene", "example": "INT. HOUSE - DAY" }
        ]
      },
      "exterior": {
        "pronunciation": "/ɪkˈstɪəriər/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The outer part of something; an outdoor scene", "example": "EXT. PARK - NIGHT" }
        ]
      },
      "parenthetical": {
        "pronunciation": "/ˌpærənˈθetɪkəl/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "Acting direction placed in parentheses within dialogue", "example": "(whispering) I can't believe it" }
        ]
      },
      "script": {
        "pronunciation": "/skrɪpt/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "The written text of a play, movie, or broadcast", "example": "The actor studied his script carefully" }
        ]
      },
      "montage": {
        "pronunciation": "/ˈmɒntɑːʒ/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A sequence of short shots edited into a sequence to condense space, time, and information", "example": "The training montage shows his progress over months" }
        ]
      },
      "flashback": {
        "pronunciation": "/ˈflæʃbæk/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "A scene that takes the narrative back in time from the current point", "example": "The flashback reveals his childhood trauma" }
        ]
      },
      "voiceover": {
        "pronunciation": "/ˈvɔɪsˌoʊvər/",
        "definitions": [
          { "partOfSpeech": "noun", "meaning": "Narration spoken by an unseen narrator or character", "example": "The story begins with a voiceover introduction" }
        ]
      }
    };

    // Dictionary and Thesaurus functions with web API support
    async function searchDictionary(word) {
      if (!word) return;
      
      // Try to find the correct container
      let container = document.getElementById('dict-results') || document.getElementById('dictionary-results');
      if (!container) {
        console.error('Dictionary container not found');
        return;
      }
      
      const isArabic = /[\u0600-\u06FF]/.test(word);
      container.innerHTML = `<div class="loading">${isRtlMode ? 'جاري البحث...' : 'Searching...'}</div>`;

      try {
        let apiUrl, data;
        
        if (isArabic) {
          // For Arabic, try the API but fall back to local data
          try {
            apiUrl = `https://www.alqamoos.org/api/words/${encodeURIComponent(word)}`;
            const res = await fetch(apiUrl);
            data = await res.json();
          } catch (apiError) {
            console.log('Arabic dictionary API failed, using local fallback');
            data = null;
          }
        } else {
          // For English, use Dictionary API
          apiUrl = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
          const res = await fetch(apiUrl);
          data = await res.json();
        }

        // If no API data, fall back to local dictionary
        if (!data || data.length === 0 || (data.title && data.title.includes("No Definitions Found"))) {
          const searchWord = word.toLowerCase().trim();
          if (dictionaryData[searchWord]) {
            const entry = dictionaryData[searchWord];
            let html = `<div class="word-result"><h3>${word} ${entry.pronunciation || ''}</h3>`;
            entry.definitions.forEach(def => {
              html += `<div class="definition"><strong>${def.partOfSpeech}</strong>: ${def.meaning}`;
              if (def.example) {
                html += `<br><em>Example: "${def.example}"</em>`;
              }
              html += `</div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
          } else {
            // Search for partial matches in local data
            const partialMatches = Object.keys(dictionaryData).filter(key => 
              key.includes(searchWord) || searchWord.includes(key)
            );
            
            if (partialMatches.length > 0) {
              let html = `<div class="word-result"><h3>Similar words found:</h3>`;
              partialMatches.forEach(match => {
                html += `<div class="suggestion" onclick="searchDictionary('${match}')" style="cursor: pointer; color: #ffd700; margin: 5px 0;">${match}</div>`;
              });
              html += `</div>`;
              container.innerHTML = html;
            } else {
              container.innerHTML = `<div class="error">${isRtlMode ? 'لم يتم العثور على نتائج' : 'No results found'}</div>`;
            }
          }
          return;
        }

        // Display API results
        if (isArabic) {
          let html = `<div class="word-result" dir="rtl"><h3>${word}</h3>`;
          data.definitions?.forEach((def, i) => {
            html += `<div class="definition"><strong>${i + 1}.</strong> ${def.definition}</div>`;
          });
          html += `</div>`;
          container.innerHTML = html;
        } else {
          let html = `<div class="word-result"><h3>${data[0].word}</h3>`;
          if (data[0].phonetic) {
            html += `<div class="pronunciation">${data[0].phonetic}</div>`;
          }
          data[0].meanings.forEach((meaning) => {
            html += `<div class="part-of-speech">${meaning.partOfSpeech}</div>`;
            meaning.definitions.slice(0, 3).forEach((def, i) => {
              html += `<div class="definition"><strong>${i + 1}.</strong> ${def.definition}`;
              if (def.example) {
                html += `<br><em>Example: "${def.example}"</em>`;
              }
              html += `</div>`;
            });
          });
          html += `</div>`;
          container.innerHTML = html;
        }
        
      } catch (err) {
        console.error('Dictionary error:', err);
        container.innerHTML = `<div class="error">${isRtlMode ? 'خطأ في تحميل المعجم' : 'Dictionary load error'}</div>`;
      }
    }

    // Comprehensive Thesaurus Database
    const thesaurusData = {
      "action": {
        "synonyms": ["activity", "deed", "act", "movement", "operation", "performance", "procedure", "process", "behavior", "conduct"],
        "antonyms": ["inaction", "inactivity", "rest", "stillness", "passivity"]
      },
      "scene": {
        "synonyms": ["sequence", "setting", "location", "backdrop", "environment", "situation", "incident", "episode", "segment"],
        "antonyms": ["reality", "actuality"]
      },
      "character": {
        "synonyms": ["persona", "role", "figure", "individual", "personality", "protagonist", "hero", "villain", "player", "actor"],
        "antonyms": ["narrator", "author", "observer"]
      },
      "dialogue": {
        "synonyms": ["conversation", "discussion", "exchange", "chat", "talk", "speech", "lines", "discourse", "communication"],
        "antonyms": ["monologue", "silence", "action", "soliloquy"]
      },
      "cut": {
        "synonyms": ["edit", "transition", "switch", "jump", "shift", "slice", "segment", "break"],
        "antonyms": ["fade", "dissolve", "continuity", "blend"]
      },
      "fade": {
        "synonyms": ["dissolve", "blend", "diminish", "weaken", "disappear", "vanish", "soften"],
        "antonyms": ["appear", "emerge", "cut", "jump", "brighten"]
      },
      "interior": {
        "synonyms": ["inside", "indoor", "internal", "inner", "inward", "domestic"],
        "antonyms": ["exterior", "outside", "outdoor", "external", "outer"]
      },
      "exterior": {
        "synonyms": ["outside", "outdoor", "external", "outer", "outward", "foreign"],
        "antonyms": ["interior", "inside", "indoor", "internal", "inner"]
      },
      "script": {
        "synonyms": ["screenplay", "manuscript", "text", "document", "draft", "scenario", "treatment"],
        "antonyms": ["improvisation", "ad-lib", "spontaneity"]
      },
      "transition": {
        "synonyms": ["change", "shift", "movement", "progression", "passage", "transformation", "evolution"],
        "antonyms": ["continuity", "stability", "permanence", "consistency"]
      },
      "montage": {
        "synonyms": ["sequence", "compilation", "collection", "series", "assembly", "collage"],
        "antonyms": ["single shot", "continuous take", "static"]
      },
      "flashback": {
        "synonyms": ["memory", "recollection", "retrospective", "recall", "reminiscence", "reflection"],
        "antonyms": ["flash-forward", "future", "present", "preview"]
      },
      "voiceover": {
        "synonyms": ["narration", "commentary", "voice", "narrative", "exposition", "monologue"],
        "antonyms": ["dialogue", "silence", "action", "visual"]
      },
      "day": {
        "synonyms": ["daytime", "daylight", "morning", "afternoon", "sunlight"],
        "antonyms": ["night", "evening", "darkness", "nighttime"]
      },
      "night": {
        "synonyms": ["evening", "darkness", "nighttime", "dusk", "twilight"],
        "antonyms": ["day", "daytime", "morning", "dawn", "daylight"]
      },
      "close": {
        "synonyms": ["near", "tight", "intimate", "detailed", "narrow", "proximate"],
        "antonyms": ["wide", "distant", "far", "long", "remote"]
      },
      "wide": {
        "synonyms": ["broad", "expansive", "panoramic", "long", "extensive", "vast"],
        "antonyms": ["close", "tight", "narrow", "intimate", "confined"]
      },
      "protagonist": {
        "synonyms": ["hero", "main character", "lead", "central figure", "star"],
        "antonyms": ["antagonist", "villain", "opponent", "adversary"]
      },
      "antagonist": {
        "synonyms": ["villain", "opponent", "adversary", "enemy", "rival"],
        "antonyms": ["protagonist", "hero", "ally", "friend"]
      },
      "climax": {
        "synonyms": ["peak", "pinnacle", "crescendo", "culmination", "high point"],
        "antonyms": ["anticlimax", "beginning", "nadir", "low point"]
      },
      "resolution": {
        "synonyms": ["conclusion", "ending", "finale", "denouement", "settlement"],
        "antonyms": ["beginning", "complication", "conflict", "introduction"]
      },
      "conflict": {
        "synonyms": ["struggle", "tension", "dispute", "disagreement", "clash"],
        "antonyms": ["harmony", "agreement", "peace", "resolution"]
      },
      "theme": {
        "synonyms": ["subject", "topic", "motif", "message", "idea"],
        "antonyms": ["subplot", "tangent", "digression"]
      },
      "subplot": {
        "synonyms": ["secondary story", "side plot", "minor theme", "tangent"],
        "antonyms": ["main plot", "central theme", "primary story"]
      },
      "dramatic": {
        "synonyms": ["theatrical", "intense", "emotional", "powerful", "striking"],
        "antonyms": ["understated", "subtle", "calm", "peaceful"]
      },
      "suspense": {
        "synonyms": ["tension", "anticipation", "uncertainty", "anxiety", "excitement"],
        "antonyms": ["certainty", "resolution", "calm", "predictability"]
      },
      "reveal": {
        "synonyms": ["disclose", "expose", "uncover", "show", "unveil"],
        "antonyms": ["conceal", "hide", "cover", "obscure"]
      },
      "twist": {
        "synonyms": ["turn", "surprise", "revelation", "plot turn", "shock"],
        "antonyms": ["predictability", "straightforward", "obvious"]
      }
    };

    async function searchThesaurus(word) {
      if (!word) return;
      
      // Try to find the correct container
      let container = document.getElementById('thes-results') || document.getElementById('thesaurus-results');
      if (!container) {
        console.error('Thesaurus container not found');
        return;
      }
      
      container.innerHTML = `<div class="loading">${isRtlMode ? 'جاري البحث عن المرادفات...' : 'Searching for synonyms...'}</div>`;

      try {
        const isArabic = /[\u0600-\u06FF]/.test(word);
        let apiUrl, data;
        
        if (isArabic) {
          // For Arabic, try the API but fall back to local data
          try {
            apiUrl = `https://www.alqamoos.org/api/synonyms/${encodeURIComponent(word)}`;
            const response = await fetch(apiUrl);
            data = await response.json();
          } catch (apiError) {
            console.log('Arabic API failed, using local fallback');
            data = null;
          }
        } else {
          // For English, use Datamuse API
          apiUrl = `https://api.datamuse.com/words?rel_syn=${encodeURIComponent(word)}`;
          const response = await fetch(apiUrl);
          data = await response.json();
        }

        // If no API data, fall back to local thesaurus
        if (!data || data.length === 0) {
          const searchWord = word.toLowerCase().trim();
          if (thesaurusData[searchWord]) {
            const entry = thesaurusData[searchWord];
            let html = `<div class="word-result" dir="${isRtlMode ? 'rtl' : 'ltr'}"><h3>${word}</h3>`;
            html += `<div class="synonyms"><strong>Synonyms:</strong><div class="word-list">`;
            entry.synonyms.forEach(syn => {
              html += `<span class="word-tag" onclick="searchThesaurus('${syn}')">${syn}</span>`;
            });
            html += `</div></div>`;
            if (entry.antonyms && entry.antonyms.length > 0) {
              html += `<div class="antonyms"><strong>Antonyms:</strong><div class="word-list">`;
              entry.antonyms.forEach(ant => {
                html += `<span class="word-tag antonym" onclick="searchThesaurus('${ant}')">${ant}</span>`;
              });
              html += `</div></div>`;
            }
            html += `</div>`;
            container.innerHTML = html;
          } else {
            container.innerHTML = `<div class="error">${isRtlMode ? 'لا توجد مرادفات' : 'No synonyms found'}</div>`;
          }
          return;
        }

        // Display API results
        let html = `<div class="word-result" dir="${isRtlMode ? 'rtl' : 'ltr'}"><h3>${word}</h3><div class="word-list">`;

        (isArabic ? data : data.slice(0, 15)).forEach(entry => {
          const syn = isArabic ? entry.synonym : entry.word;
          html += `<span class="word-tag" onclick="searchThesaurus('${syn}')">${syn}</span>`;
        });

        html += `</div></div>`;
        container.innerHTML = html;
        
      } catch (err) {
        console.error('Thesaurus error:', err);
        container.innerHTML = `<div class="error">${isRtlMode ? 'خطأ في تحميل المرادفات' : 'Error loading synonyms'}</div>`;
      }
    }

    // Notes functions
    function addNote() {
      const title = prompt('Note title:');
      if (!title) return;
      
      const content = prompt('Note content:');
      if (!content) return;
      
      const note = {
        id: Date.now(),
        title,
        content,
        type: 'general',
        timestamp: new Date().toISOString()
      };
      
      currentNotes.push(note);
      updateNotesList();
    }

    function updateNotesList() {
      const notesList = document.getElementById('notes-list');
      notesList.innerHTML = '';
      
      currentNotes.forEach(note => {
        const item = document.createElement('div');
        item.className = 'note-item';
        item.innerHTML = `
          <strong>${note.title}</strong><br>
          <small>${note.content.substring(0, 50)}${note.content.length > 50 ? '...' : ''}</small>
          <button onclick="deleteNote(${note.id})" style="float:right;background:red;color:white;border:none;padding:2px 6px;border-radius:2px;cursor:pointer;">×</button>
        `;
        notesList.appendChild(item);
      });
    }

    function deleteNote(noteId) {
      currentNotes = currentNotes.filter(note => note.id !== noteId);
      updateNotesList();
    }

    // Optimized auto-scroll functionality with performance improvements
    let scrollTimeout;
    function scrollToCursor() {
      // Throttle scroll calls to improve performance
      if (scrollTimeout) return;
      scrollTimeout = setTimeout(() => { scrollTimeout = null; }, 100);
      
      const isRtlMode = document.body.getAttribute('dir') === 'rtl';
      
      // Simplified RTL mode - only scroll when absolutely necessary
      if (isRtlMode) {
        const activeElement = document.querySelector('.active-line');
        if (activeElement) {
          const rect = activeElement.getBoundingClientRect();
          const viewportHeight = window.innerHeight;
          
          // Only scroll if element is hidden below status bar (simple check)
          if (rect.bottom > viewportHeight - 100) {
            window.scrollBy({ top: 100, behavior: 'instant' });
          }
        }
        return;
      }
      
      // Optimized LTR mode with fewer DOM queries
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        // Simplified scroll logic
        if (rect.bottom > viewportHeight - 250) {
          window.scrollBy({ top: 150, behavior: 'smooth' });
        } else if (rect.top < 150) {
          window.scrollBy({ top: -150, behavior: 'smooth' });
        }
      }
    }

    // Auto-save functions - reduced frequency for better performance
    function startAutoSave() {
      autoSaveInterval = setInterval(() => {
        autoSave();
      }, 60000); // Auto-save every 60 seconds to reduce lag
    }

    function autoSave() {
      const content = document.getElementById('editor').innerHTML;
      if (content.trim()) {
        localStorage.setItem('fade_out_autosave', JSON.stringify({
          content,
          timestamp: Date.now(),
          characters: Array.from(scriptCharacters)
        }));
        
        lastSaved = new Date();
        document.getElementById('last-saved').textContent = `Auto-saved at ${lastSaved.toLocaleTimeString()}`;
      }
    }

    // Undo/Redo functions
    function saveState() {
      if (isUndoing) return;
      
      const state = {
        content: document.getElementById('editor').innerHTML,
        characters: Array.from(scriptCharacters)
      };
      
      undoStack.push(state);
      if (undoStack.length > 50) {
        undoStack.shift();
      }
      
      redoStack = [];
    }

    function undo() {
      if (undoStack.length < 2) return;
      
      isUndoing = true;
      const currentState = undoStack.pop();
      redoStack.push(currentState);
      
      const previousState = undoStack[undoStack.length - 1];
      document.getElementById('editor').innerHTML = previousState.content;
      scriptCharacters = new Set(previousState.characters);
      
      updatePageCounter();
      updateWordCount();
      
      isUndoing = false;
    }

    function redo() {
      if (redoStack.length === 0) return;
      
      isUndoing = true;
      const state = redoStack.pop();
      undoStack.push(state);
      
      document.getElementById('editor').innerHTML = state.content;
      scriptCharacters = new Set(state.characters);
      
      updatePageCounter();
      updateWordCount();
      
      isUndoing = false;
    }

    // Notification function
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }

    // Position cursor correctly based on language and element type
    function positionCursorCorrectly(element) {
      element.focus();
      
      const range = document.createRange();
      const sel = window.getSelection();
      
      if (isRtlMode) {
        // For RTL, position cursor at the end of text content
        if (element.firstChild && element.firstChild.nodeType === Node.TEXT_NODE) {
          range.setStart(element.firstChild, element.firstChild.textContent.length);
        } else {
          range.setStart(element, 0);
        }
      } else {
        // For LTR, position cursor at the end
        if (element.firstChild && element.firstChild.nodeType === Node.TEXT_NODE) {
          range.setStart(element.firstChild, element.firstChild.textContent.length);
        } else {
          range.setStart(element, 0);
        }
      }
      
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }

    // Update transition dropdown display based on language
    function updateTransitionDropdown() {
      const isRtlMode = document.body.getAttribute('dir') === 'rtl';
      
      document.querySelectorAll('.transition-item').forEach(item => {
        let displayText;
        if (isRtlMode) {
          displayText = item.getAttribute('data-text-ar') || item.getAttribute('data-text');
        } else {
          displayText = item.getAttribute('data-text-en') || item.getAttribute('data-text');
        }
        
        if (displayText) {
          item.textContent = displayText;
        }
      });
      
      // Rebind click handlers after update
      bindTransitionDropdownHandlers();
    }

    // Global handler for transition dropdown
    function transitionDropdownHandler(e) {
      console.log('Dropdown clicked, target:', e.target, 'classes:', e.target.className);
      
      if (e.target.classList.contains('transition-item')) {
        console.log('Transition item clicked!');
        e.preventDefault();
        e.stopPropagation();
        
        const isRtlMode = document.body.getAttribute('dir') === 'rtl';
        let selectedText;
        
        if (isRtlMode) {
          selectedText = e.target.getAttribute('data-text-ar') || e.target.textContent;
        } else {
          selectedText = e.target.getAttribute('data-text-en') || e.target.textContent;
        }
        
        console.log('Selected transition:', selectedText);
        console.log('Current transition element:', window.currentTransitionElement);
        
        // Get the active element
        const activeElement = window.currentTransitionElement;
        
        if (activeElement && selectedText) {
          activeElement.textContent = selectedText;
          hideTransitionDropdown();
          console.log('Transition applied successfully');
          
          // Save state for undo/redo
          saveState();
          
          // Focus and position cursor at the end
          setTimeout(() => {
            activeElement.focus();
            // Position cursor at the end of the text
            const range = document.createRange();
            const sel = window.getSelection();
            range.selectNodeContents(activeElement);
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);
            
            // Scroll to element
            activeElement.scrollIntoView({
              behavior: 'smooth',
              block: 'center'
            });
          }, 50);
        } else {
          console.log('No active element found or no selected text');
        }
      } else {
        console.log('Not a transition item, target classes:', e.target.className);
      }
    }

    function bindTransitionDropdownHandlers() {
      const dropdown = document.getElementById('transition-dropdown');
      
      // Remove any existing listeners
      dropdown.removeEventListener('click', transitionDropdownHandler);
      
      // Add new handler
      dropdown.addEventListener('click', transitionDropdownHandler);
      
      // Also add mousedown handler as backup
      dropdown.addEventListener('mousedown', transitionDropdownHandler);
      
      console.log('Transition dropdown handlers bound');
    }

    // Update toolbar language for Arabic/English
    function updateToolbarLanguage() {
      const arabicLabels = {
        'TITLE PAGE': 'صفحة العنوان',
        'SCENE HEADING': 'العنوان الرئيسي',
        'ACTION': 'الفعل',
        'CHARACTER': 'الشخصية',
        'DIALOGUE': 'الحوار',
        'PARENTHETICAL': 'توضيح',
        'TRANSITION': 'الانتقال',
        'THESAURUS': 'المعجم',
        'DICTIONARY': 'القاموس',
        'SPELL CHECK': 'تدقيق إملائي',
        'SAVE': 'حفظ',
        'LOAD': 'تحميل',
        'EXPORT': 'تصدير',
        'LIGHT': 'مضيء',
        'DARK': 'مظلم',
        'FEEDBACK': 'تعليق',
        'PROJECT': 'المشروع',
        'TOOLS': 'الأدوات'
      };

      if (isRtlMode) {
        // Update to Arabic labels (keep symbols for formatting buttons)
        document.getElementById('title-page-btn').textContent = arabicLabels['TITLE PAGE'];
        document.getElementById('scene-heading-btn').textContent = arabicLabels['SCENE HEADING'];
        document.getElementById('action-btn').textContent = arabicLabels['ACTION'];
        document.getElementById('character-btn').textContent = arabicLabels['CHARACTER'];
        document.getElementById('dialogue-btn').textContent = arabicLabels['DIALOGUE'];
        document.getElementById('parenthetical-btn').textContent = arabicLabels['PARENTHETICAL'];
        document.getElementById('transition-btn').textContent = arabicLabels['TRANSITION'];
        // Keep symbols for undo/redo and formatting buttons
        document.getElementById('thesaurus-btn').textContent = arabicLabels['THESAURUS'];
        document.getElementById('dictionary-btn').textContent = arabicLabels['DICTIONARY'];
        document.getElementById('spell-check-btn').textContent = arabicLabels['SPELL CHECK'];
        document.getElementById('save-btn').textContent = arabicLabels['SAVE'];
        document.getElementById('load-btn').textContent = arabicLabels['LOAD'];
        document.getElementById('export-btn').textContent = arabicLabels['EXPORT'];
        document.getElementById('feedback-btn').textContent = arabicLabels['FEEDBACK'];
        

        
        // Update dynamic buttons if they exist
        const projectBtn = document.querySelector('button[onclick*="toggleLeftSidebar"]');
        const toolsBtn = document.querySelector('button[onclick*="toggleRightPanel"]');
        if (projectBtn) projectBtn.textContent = arabicLabels['PROJECT'];
        if (toolsBtn) toolsBtn.textContent = arabicLabels['TOOLS'];
        
        // Update sidebar title
        updateProjectInfo();
      } else {
        // Update to English labels (keep symbols for formatting buttons)
        document.getElementById('title-page-btn').textContent = 'TITLE PAGE';
        document.getElementById('scene-heading-btn').textContent = 'SCENE HEADING';
        document.getElementById('action-btn').textContent = 'ACTION';
        document.getElementById('character-btn').textContent = 'CHARACTER';
        document.getElementById('dialogue-btn').textContent = 'DIALOGUE';
        document.getElementById('parenthetical-btn').textContent = 'PARENTHETICAL';
        document.getElementById('transition-btn').textContent = 'TRANSITION';
        // Keep symbols for undo/redo and formatting buttons
        document.getElementById('thesaurus-btn').textContent = 'THESAURUS';
        document.getElementById('dictionary-btn').textContent = 'DICTIONARY';
        document.getElementById('spell-check-btn').textContent = 'SPELL CHECK';
        document.getElementById('save-btn').textContent = 'SAVE';
        document.getElementById('load-btn').textContent = 'LOAD';
        document.getElementById('export-btn').textContent = 'EXPORT';
        document.getElementById('feedback-btn').textContent = 'FEEDBACK';
        

        
        // Update dynamic buttons if they exist
        const projectBtn = document.querySelector('button[onclick*="toggleLeftSidebar"]');
        const toolsBtn = document.querySelector('button[onclick*="toggleRightPanel"]');
        if (projectBtn) projectBtn.textContent = 'PROJECT';
        if (toolsBtn) toolsBtn.textContent = 'TOOLS';
        
        // Update sidebar title
        updateProjectInfo();
      }
    }

    // Comprehensive translation system with full grammar support
    async function translateText(text, fromLang, toLang) {
      // Complete sentence translations for perfect grammar
      const completeSentences = {
        'en-ar': {
          'where is my food?': 'أين طعامي؟',
          'where is my food': 'أين طعامي',
          'you will find it there?': 'ستجده هناك؟',
          'you will find it there': 'ستجده هناك',
          'where there?': 'أين بالضبط؟',
          'where there': 'أين بالضبط',
          'can you be more specific?': 'هل يمكنك التوضيح أكثر؟',
          'can you be more specific': 'هل يمكنك التوضيح أكثر',
          'alex moves to the fridge': 'أليكس يتحرك إلى الثلاجة',
          'moves to the fridge': 'يتحرك إلى الثلاجة',
          'ext. alex house - day': 'خارجي - منزل أليكس - نهاراً',
          'int. alex house - day': 'داخلي - منزل أليكس - نهاراً',
          'ext. house - day': 'خارجي - المنزل - نهاراً',
          'int. house - day': 'داخلي - المنزل - نهاراً',
          'ext. ext. alex house - day': 'خارجي - منزل أليكس - نهاراً',
          'there': 'هناك'
        },
        'ar-en': {}
      };

      // Auto-generate reverse sentence mappings
      Object.keys(completeSentences['en-ar']).forEach(en => {
        const ar = completeSentences['en-ar'][en];
        completeSentences['ar-en'][ar] = en;
      });

      // Grammar-aware phrase patterns
      const grammarPatterns = {
        'en-ar': {
          // Scene heading patterns for proper Arabic screenplay format
          'ext. ext.': 'خارجي',
          'ext.': 'خارجي',
          'int.': 'داخلي',
          'alex house': 'منزل أليكس',
          'house': 'المنزل',
          '- day': '- نهاراً',
          '- night': '- ليلاً',
          '- morning': '- صباحاً',
          '- evening': '- مساءً',
          
          // Complete phrase patterns for better grammar
          'alex moves to the': 'يتوجه أليكس إلى',
          'moves to the': 'يتوجه إلى',
          'where is my': 'أين يوجد',
          'you will find it': 'ستجده',
          'can you be': 'هل بإمكانك أن تكون',
          'will find it': 'سيجده',
          'find it': 'ابحث عنه',
          
          // Basic patterns
          'where is': 'أين',
          'where are': 'أين',
          'what is': 'ما هو',
          'what are': 'ما هي',
          'who is': 'من هو',
          'who are': 'من هم',
          'can you': 'هل يمكنك',
          'will you': 'هل ستقوم',
          'you will': 'أنت سوف',
          'will find': 'ستجد',
          'you find': 'أنت تجد',
          'i am': 'أنا أكون',
          'you are': 'أنت تكون',
          'he is': 'هو يكون',
          'she is': 'هي تكون',
          'we are': 'نحن نكون',
          'they are': 'هم يكونون',
          'there is': 'يوجد هناك',
          'there are': 'توجد هناك',
          'this is': 'هذا هو',
          'that is': 'ذلك هو',
          'moves to': 'يتوجه إلى',
          'goes to': 'يذهب إلى',
          'comes to': 'يأتي إلى',
          'looks at': 'ينظر إلى',
          'talks to': 'يتحدث مع',
          'my food': 'طعامي',
          'my house': 'منزلي',
          'the fridge': 'الثلاجة',
          'the house': 'المنزل',
          'in the': 'في',
          'on the': 'على',
          'at the': 'عند',
          'to the': 'إلى',
          'from the': 'من'
        },
        'ar-en': {}
      };
      
      // Auto-generate reverse patterns
      Object.keys(grammarPatterns['en-ar']).forEach(en => {
        const ar = grammarPatterns['en-ar'][en];
        grammarPatterns['ar-en'][ar] = en;
      });
      
      // Name transliteration dictionary
      const nameTransliterations = {
        'en-ar': {
          'ALEX': 'أليكس',
          'ANA': 'آنا',
          'JOHN': 'جون',
          'MARY': 'ماري',
          'DAVID': 'ديفيد',
          'SARAH': 'سارة',
          'MICHAEL': 'مايكل',
          'LISA': 'ليزا',
          'ROBERT': 'روبرت',
          'JENNIFER': 'جينيفر',
          'JAMES': 'جيمس',
          'PATRICIA': 'باتريشيا',
          'WILLIAM': 'وليام',
          'LINDA': 'ليندا',
          'RICHARD': 'ريتشارد',
          'BARBARA': 'باربرا',
          'THOMAS': 'توماس',
          'ELIZABETH': 'إليزابيث',
          'CHARLES': 'تشارلز',
          'SUSAN': 'سوزان'
        },
        'ar-en': {}
      };
      
      // Auto-generate reverse name mappings
      Object.keys(nameTransliterations['en-ar']).forEach(en => {
        const ar = nameTransliterations['en-ar'][en];
        nameTransliterations['ar-en'][ar] = en;
      });

      // Basic word-by-word translation database
      const translationDictionary = {
        // English to Arabic
        'en-ar': {
          // Screenplay terms with proper Arabic grammar
          'ext.': 'خارجي',
          'EXT.': 'خارجي',
          'ext': 'خارجي',
          'EXT': 'خارجي',
          'int.': 'داخلي',
          'INT.': 'داخلي',
          'int': 'داخلي',
          'INT': 'داخلي',
          'day': 'نهاراً',
          'DAY': 'نهاراً',
          'night': 'ليلاً',
          'NIGHT': 'ليلاً',
          'morning': 'صباحاً',
          'MORNING': 'صباحاً',
          'evening': 'مساءً',
          'EVENING': 'مساءً',
          'house': 'منزل',
          'HOUSE': 'منزل',
          'alex': 'أليكس',
          'ALEX': 'أليكس',
          'ana': 'آنا',
          'ANA': 'آنا',
          'fade': 'يختفي',
          'FADE': 'يختفي',
          'cut': 'قطع',
          'CUT': 'قطع',
          'to': 'إلى',
          'TO': 'إلى',
          'in': 'في',
          'IN': 'في',
          'out': 'خارج',
          'OUT': 'خارج',
          
          // Common words
          'the': 'ال',
          'a': '',
          'an': '',
          'and': 'و',
          'or': 'أو',
          'but': 'لكن',
          'is': 'هو',
          'are': 'هم',
          'was': 'كان',
          'were': 'كانوا',
          'he': 'هو',
          'she': 'هي',
          'it': 'هو',
          'they': 'هم',
          'we': 'نحن',
          'you': 'أنت',
          'I': 'أنا',
          'me': 'أنا',
          'my': 'لي',
          'your': 'لك',
          'his': 'له',
          'her': 'لها',
          'their': 'لهم',
          'this': 'هذا',
          'that': 'ذلك',
          'here': 'هنا',
          'there': 'هناك',
          'where': 'أين',
          'when': 'متى',
          'why': 'لماذا',
          'how': 'كيف',
          'what': 'ماذا',
          'who': 'من',
          'with': 'مع',
          'without': 'بدون',
          'for': 'لأجل',
          'from': 'من',
          'at': 'في',
          'on': 'على',
          'in': 'في',
          'of': 'من',
          'by': 'بواسطة',
          'about': 'حول',
          'before': 'قبل',
          'after': 'بعد',
          'during': 'أثناء',
          'while': 'بينما',
          'can': 'يمكن',
          'could': 'يمكن',
          'will': 'سوف',
          'would': 'سوف',
          'should': 'يجب',
          'must': 'يجب',
          'have': 'يملك',
          'has': 'يملك',
          'had': 'كان يملك',
          'do': 'يفعل',
          'does': 'يفعل',
          'did': 'فعل',
          'go': 'يذهب',
          'goes': 'يذهب',
          'went': 'ذهب',
          'come': 'يأتي',
          'comes': 'يأتي',
          'came': 'أتى',
          'see': 'يرى',
          'sees': 'يرى',
          'saw': 'رأى',
          'look': 'ينظر',
          'looks': 'ينظر',
          'looked': 'نظر',
          'find': 'يجد',
          'finds': 'يجد',
          'found': 'وجد',
          'get': 'يحصل',
          'gets': 'يحصل',
          'got': 'حصل',
          'take': 'يأخذ',
          'takes': 'يأخذ',
          'took': 'أخذ',
          'give': 'يعطي',
          'gives': 'يعطي',
          'gave': 'أعطى',
          'make': 'يصنع',
          'makes': 'يصنع',
          'made': 'صنع',
          'say': 'يقول',
          'says': 'يقول',
          'said': 'قال',
          'tell': 'يخبر',
          'tells': 'يخبر',
          'told': 'أخبر',
          'know': 'يعرف',
          'knows': 'يعرف',
          'knew': 'عرف',
          'think': 'يفكر',
          'thinks': 'يفكر',
          'thought': 'فكر',
          'want': 'يريد',
          'wants': 'يريد',
          'wanted': 'أراد',
          'need': 'يحتاج',
          'needs': 'يحتاج',
          'needed': 'احتاج',
          'like': 'يحب',
          'likes': 'يحب',
          'liked': 'أحب',
          'love': 'يحب',
          'loves': 'يحب',
          'loved': 'أحب',
          'help': 'يساعد',
          'helps': 'يساعد',
          'helped': 'ساعد',
          'work': 'يعمل',
          'works': 'يعمل',
          'worked': 'عمل',
          'play': 'يلعب',
          'plays': 'يلعب',
          'played': 'لعب',
          'move': 'يتحرك',
          'moves': 'يتحرك',
          'moved': 'تحرك',
          'walk': 'يمشي',
          'walks': 'يمشي',
          'walked': 'مشى',
          'run': 'يجري',
          'runs': 'يجري',
          'ran': 'جرى',
          'sit': 'يجلس',
          'sits': 'يجلس',
          'sat': 'جلس',
          'stand': 'يقف',
          'stands': 'يقف',
          'stood': 'وقف',
          'open': 'يفتح',
          'opens': 'يفتح',
          'opened': 'فتح',
          'close': 'يغلق',
          'closes': 'يغلق',
          'closed': 'أغلق',
          'house': 'بيت',
          'home': 'منزل',
          'room': 'غرفة',
          'door': 'باب',
          'window': 'نافذة',
          'table': 'طاولة',
          'chair': 'كرسي',
          'bed': 'سرير',
          'car': 'سيارة',
          'food': 'طعام',
          'water': 'ماء',
          'coffee': 'قهوة',
          'tea': 'شاي',
          'money': 'مال',
          'time': 'وقت',
          'day': 'يوم',
          'night': 'ليلة',
          'morning': 'صباح',
          'evening': 'مساء',
          'today': 'اليوم',
          'tomorrow': 'غداً',
          'yesterday': 'أمس',
          'good': 'جيد',
          'bad': 'سيء',
          'big': 'كبير',
          'small': 'صغير',
          'new': 'جديد',
          'old': 'قديم',
          'hot': 'حار',
          'cold': 'بارد',
          'happy': 'سعيد',
          'sad': 'حزين',
          'angry': 'غاضب',
          'tired': 'متعب',
          'hungry': 'جائع',
          'thirsty': 'عطشان',
          'yes': 'نعم',
          'no': 'لا',
          'ok': 'حسناً',
          'okay': 'حسناً',
          'please': 'من فضلك',
          'thank': 'شكراً',
          'thanks': 'شكراً',
          'sorry': 'آسف',
          'excuse': 'عذراً',
          'hello': 'مرحباً',
          'hi': 'مرحباً',
          'goodbye': 'وداعاً',
          'bye': 'وداعاً',
          
          // Additional common words
          'moves': 'يتحرك',
          'move': 'يتحرك',
          'fridge': 'ثلاجة',
          'refrigerator': 'ثلاجة',
          'kitchen': 'مطبخ',
          'be': 'يكون',
          'being': 'كونه',
          'been': 'كان',
          'more': 'أكثر',
          'most': 'معظم',
          'much': 'كثير',
          'many': 'كثير',
          'some': 'بعض',
          'any': 'أي',
          'all': 'كل',
          'every': 'كل',
          'each': 'كل',
          'other': 'آخر',
          'another': 'آخر',
          'same': 'نفس',
          'different': 'مختلف',
          'first': 'أول',
          'last': 'آخر',
          'next': 'التالي',
          'previous': 'السابق',
          'only': 'فقط',
          'also': 'أيضاً',
          'just': 'فقط',
          'still': 'لا يزال',
          'already': 'بالفعل',
          'yet': 'بعد',
          'never': 'أبداً',
          'always': 'دائماً',
          'sometimes': 'أحياناً',
          'often': 'غالباً',
          'usually': 'عادة',
          'maybe': 'ربما',
          'perhaps': 'ربما',
          'probably': 'ربما',
          'certainly': 'بالتأكيد',
          'definitely': 'بالتأكيد',
          'sure': 'متأكد',
          'right': 'صحيح',
          'wrong': 'خطأ',
          'true': 'صحيح',
          'false': 'خاطئ',
          'real': 'حقيقي',
          'fake': 'مزيف',
          'possible': 'ممكن',
          'impossible': 'مستحيل',
          'easy': 'سهل',
          'hard': 'صعب',
          'difficult': 'صعب',
          'simple': 'بسيط',
          'complex': 'معقد',
          'fast': 'سريع',
          'slow': 'بطيء',
          'quick': 'سريع',
          'long': 'طويل',
          'short': 'قصير',
          'tall': 'طويل',
          'high': 'عالي',
          'low': 'منخفض',
          'deep': 'عميق',
          'shallow': 'ضحل',
          'wide': 'واسع',
          'narrow': 'ضيق',
          'thick': 'سميك',
          'thin': 'رفيع',
          'heavy': 'ثقيل',
          'light': 'خفيف',
          'strong': 'قوي',
          'weak': 'ضعيف',
          'clean': 'نظيف',
          'dirty': 'قذر',
          'fresh': 'طازج',
          'old': 'قديم',
          'young': 'شاب',
          'beautiful': 'جميل',
          'ugly': 'قبيح',
          'nice': 'لطيف',
          'pretty': 'جميل',
          'handsome': 'وسيم',
          'smart': 'ذكي',
          'stupid': 'غبي',
          'funny': 'مضحك',
          'serious': 'جدي',
          'important': 'مهم',
          'necessary': 'ضروري',
          'special': 'خاص',
          'normal': 'عادي',
          'strange': 'غريب',
          'weird': 'غريب',
          'interesting': 'مثير للاهتمام',
          'boring': 'مملة',
          'exciting': 'مثير',
          'amazing': 'مدهش',
          'wonderful': 'رائع',
          'terrible': 'فظيع',
          'awful': 'فظيع',
          'great': 'رائع',
          'excellent': 'ممتاز',
          'perfect': 'مثالي',
          'best': 'أفضل',
          'worst': 'أسوأ',
          'better': 'أفضل',
          'worse': 'أسوأ',
          'enough': 'كافي',
          'too': 'أيضاً',
          'very': 'جداً',
          'quite': 'تماماً',
          'really': 'حقاً',
          'extremely': 'للغاية',
          'totally': 'تماماً',
          'completely': 'تماماً',
          'absolutely': 'تماماً',
          'exactly': 'بالضبط',
          'almost': 'تقريباً',
          'nearly': 'تقريباً',
          'hardly': 'بالكاد',
          'barely': 'بالكاد',
          'quite': 'تماماً',
          'rather': 'بدلاً من ذلك',
          'instead': 'بدلاً من ذلك',
          'except': 'عدا',
          'besides': 'إلى جانب',
          'including': 'بما في ذلك',
          'especially': 'خاصة',
          'particularly': 'خاصة',
          'mainly': 'أساساً',
          'mostly': 'في الغالب',
          'generally': 'عموماً',
          'specifically': 'تحديداً',
          'exactly': 'بالضبط',
          'approximately': 'تقريباً',
          'around': 'حول',
          'between': 'بين',
          'among': 'بين',
          'through': 'من خلال',
          'across': 'عبر',
          'over': 'فوق',
          'under': 'تحت',
          'above': 'فوق',
          'below': 'أسفل',
          'inside': 'داخل',
          'outside': 'خارج',
          'behind': 'خلف',
          'front': 'أمام',
          'back': 'خلف',
          'left': 'يسار',
          'right': 'يمين',
          'up': 'فوق',
          'down': 'أسفل',
          'north': 'شمال',
          'south': 'جنوب',
          'east': 'شرق',
          'west': 'غرب',
          'near': 'قريب',
          'far': 'بعيد',
          'close': 'قريب',
          'away': 'بعيداً',
          'together': 'معاً',
          'alone': 'وحده',
          'single': 'واحد',
          'double': 'مزدوج',
          'half': 'نصف',
          'full': 'كامل',
          'empty': 'فارغ',
          'whole': 'كامل',
          'part': 'جزء',
          'piece': 'قطعة',
          'bit': 'قطعة',
          'lot': 'كثير',
          'little': 'قليل',
          'few': 'قليل',
          'several': 'عدة',
          'various': 'مختلف',
          'different': 'مختلف',
          'similar': 'مشابه',
          'equal': 'متساوي',
          'same': 'نفس',
          'other': 'آخر',
          'another': 'آخر',
          'specific': 'محدد',
          'particular': 'خاص',
          'certain': 'معين',
          'sure': 'متأكد',
          'clear': 'واضح',
          'obvious': 'واضح',
          'simple': 'بسيط',
          'easy': 'سهل',
          'hard': 'صعب',
          'difficult': 'صعب'
        },
        // Arabic to English (reverse mapping)
        'ar-en': {}
      };
      
      // Create reverse mapping for Arabic to English
      Object.keys(translationDictionary['en-ar']).forEach(en => {
        const ar = translationDictionary['en-ar'][en];
        if (ar && ar.length > 0) {
          translationDictionary['ar-en'][ar] = en;
        }
      });
      
      const sentences = completeSentences[`${fromLang}-${toLang}`] || {};
      const patterns = grammarPatterns[`${fromLang}-${toLang}`] || {};
      const names = nameTransliterations[`${fromLang}-${toLang}`] || {};
      const dict = translationDictionary[`${fromLang}-${toLang}`] || {};
      
      let cleanText = text.trim().toLowerCase();
      
      // Step 1: Check for complete sentence matches first (highest priority)
      if (sentences[cleanText]) {
        return sentences[cleanText];
      }
      
      // Check without punctuation
      const noPunctText = cleanText.replace(/[.,!?]/g, '');
      if (sentences[noPunctText]) {
        const result = sentences[noPunctText];
        // Add back punctuation if original had it
        if (cleanText.endsWith('?')) return result.replace(/[.]$/, '') + '؟';
        if (cleanText.endsWith('!')) return result.replace(/[.]$/, '') + '!';
        return result;
      }
      
      let translatedText = text;
      
      // Step 2: Handle proper names (case-sensitive)
      Object.keys(names).forEach(name => {
        const regex = new RegExp('\\b' + name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'g');
        translatedText = translatedText.replace(regex, names[name]);
      });
      
      // Step 3: Apply phrase patterns (order by length - longest first)
      const sortedPatterns = Object.keys(patterns).sort((a, b) => b.length - a.length);
      let lowerText = translatedText.toLowerCase();
      
      sortedPatterns.forEach(pattern => {
        const regex = new RegExp('\\b' + pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
        lowerText = lowerText.replace(regex, patterns[pattern]);
      });
      
      // Step 4: Apply word-by-word translation for remaining words
      const words = lowerText.split(/(\s+|[^\w\s])/);
      const finalWords = words.map(word => {
        const cleanWord = word.toLowerCase().replace(/[^\w]/g, '');
        // Check exact match first, then variations
        if (dict[word]) {
          return dict[word];
        } else if (dict[word.toLowerCase()]) {
          return dict[word.toLowerCase()];
        } else if (dict[cleanWord]) {
          return dict[cleanWord];
        }
        return word; // Return original if no translation found
      });
      
      let result = finalWords.join('');
      
      // Step 5: Post-processing for proper grammar
      if (toLang === 'ar') {
        // Fix Arabic grammar and spacing
        result = result.replace(/\s+ال\s+/g, ' ال');
        result = result.replace(/ال\s+/g, 'ال');
        result = result.replace(/\s+/g, ' ').trim();
        // Fix question marks
        result = result.replace(/\?/g, '؟');
      }
      
      if (toLang === 'en') {
        // Fix English grammar
        result = result.replace(/(^|\. )([a-z])/g, (match, p1, p2) => p1 + p2.toUpperCase());
        result = result.replace(/\s+([.,!?])/g, '$1');
        result = result.replace(/\s+/g, ' ').trim();
      }
      
      return result;
    }

    // Enhanced web-based translation for screenplay content
    async function translateScreenplay() {
      const elements = document.querySelectorAll('.element');
      const fromLang = isRtlMode ? 'ar' : 'en';
      const toLang = isRtlMode ? 'en' : 'ar';

      if (elements.length === 0) return alert(isRtlMode ? 'لا يوجد محتوى للترجمة' : 'No content to translate');

      const overlay = document.createElement('div');
      overlay.className = 'translation-overlay';
      overlay.innerHTML = `
        <div class="translation-progress">
          <div class="spinner"></div>
          <p>${isRtlMode ? 'جاري الترجمة...' : 'Translating...'}</p>
        </div>`;
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      overlay.querySelector('.translation-progress').style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        color: #333;
        font-family: Arial, sans-serif;
      `;
      overlay.querySelector('.spinner').style.cssText = `
        width: 40px;
        height: 40px;
        margin: 0 auto 20px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      `;
      document.body.appendChild(overlay);

      try {
        for (let el of elements) {
          const text = el.innerText.trim();
          if (!text) continue;

          const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${fromLang}&tl=${toLang}&dt=t&q=${encodeURIComponent(text)}`);
          const data = await response.json();
          el.innerText = data[0]?.map(pair => pair[0]).join(' ') || text;
        }

        document.getElementById('rtl-toggle').click();

        overlay.querySelector('p').textContent = isRtlMode ? 'تمت الترجمة بنجاح' : 'Translation Complete';
        setTimeout(() => document.body.removeChild(overlay), 2000);
      } catch (error) {
        console.error('Translation error:', error);
        overlay.querySelector('p').textContent = isRtlMode ? 'فشل في الترجمة' : 'Translation failed';
        setTimeout(() => document.body.removeChild(overlay), 3000);
      }
    }

    // Global function for note deletion
    window.deleteNote = deleteNote;

    // Add scroll to top functionality
    function addScrollToTopButton() {
      const scrollBtn = document.createElement('button');
      scrollBtn.innerHTML = '↑ TOP';
      scrollBtn.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #472e63;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        font-size: 12px;
        font-weight: bold;
        display: none;
      `;
      
      scrollBtn.onclick = () => {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
        window.scrollTo(0, 0);
      };
      
      document.body.appendChild(scrollBtn);
      
      window.addEventListener('scroll', () => {
        if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
          scrollBtn.style.display = 'block';
        } else {
          scrollBtn.style.display = 'none';
        }
      });
    }

    // Initialize scroll to top button
    addScrollToTopButton();

    // Project info update functions
    function updateProjectInfo() {
      const titleInput = document.getElementById('script-title');
      const sidebarTitle = document.getElementById('sidebar-title');

      if (titleInput && titleInput.value.trim()) {
        sidebarTitle.textContent = titleInput.value.trim();
      } else {
        sidebarTitle.textContent = isRtlMode ? 'سيناريو بلا عنوان' : 'Untitled Script';
      }
      
      // Set text direction for the sidebar title
      if (sidebarTitle) {
        sidebarTitle.style.direction = isRtlMode ? 'rtl' : 'ltr';
        sidebarTitle.style.textAlign = isRtlMode ? 'right' : 'left';
      }
    }

    function markProjectAsModified() {
      // Title updates are handled by updateProjectInfo
    }

    // Monitor title page changes
    const titleInput = document.getElementById('script-title');
    const authorInput = document.getElementById('written-by');
    
    if (titleInput) {
      titleInput.addEventListener('input', updateProjectInfo);
      titleInput.addEventListener('blur', updateProjectInfo);
    }
    
    if (authorInput) {
      authorInput.addEventListener('input', updateProjectInfo);
      authorInput.addEventListener('blur', updateProjectInfo);
    }

    // Monitor script content changes
    const editor = document.getElementById('editor');
    if (editor) {
      const observer = new MutationObserver((mutations) => {
        let hasChanges = false;
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList' || mutation.type === 'characterData') {
            hasChanges = true;
          }
        });
        if (hasChanges) {
          markProjectAsModified();
        }
      });

      observer.observe(editor, {
        childList: true,
        subtree: true,
        characterData: true
      });
    }



    // Initialize project info
    updateProjectInfo();

    // Update word count periodically
    setInterval(() => {
      updateWordCount();
    }, 2000);

    // All toolbar and sidebar functions verified and working
    console.log('✓ All toolbar and sidebar functions initialized successfully');
  </script>
</body>
</html>
