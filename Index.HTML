<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fade Out - Screenplay Editor</title>
  <style>
    /* Dark Theme & Typography */
    body {
      background-color: #1c0f2e;
      color: white;
      font-family: Courier, monospace;
      margin: 0;
      padding: 0;
    }
    
    body.light {
      background-color: #f8f8f8;
      color: #000000;
    }

    /* App Header */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #1c0f2e;
      color: white;
      text-align: center;
      padding: 10px 0;
      z-index: 1000;
      border-bottom: 1px solid #472e63;
      direction: ltr; /* Force LTR for header */
    }
    
    .app-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .tagline {
      font-size: 14px;
      opacity: 0.8;
    }

    /* Toolbar */
    .toolbar {
      position: fixed;
      top: 70px; /* Below header */
      left: 0;
      right: 0;
      background-color: #2a1240;
      border-bottom: 2px solid #472e63;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      z-index: 999;
      gap: 5px;
    }

    /* Toolbar Groups */
    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    /* Editor */
    #editor {
      padding: 130px 20px 20px 20px;
      outline: none;
      white-space: pre-wrap;
      min-height: 80vh;
    }

    /* RTL Fixes */
    body[dir="rtl"] .toolbar {
      direction: rtl;
    }
    
    body[dir="rtl"] .toolbar button {
      float: right;
    }
    
    .rtl {
      direction: rtl;
    }

    /* Element Styles */
    .element { margin: 0; padding: 2px 0; }
    .scene-heading { text-transform: uppercase; margin: 12px 0; text-align: left; font-weight: bold; }
    .action { text-align: left; margin: 12px 0; }
    .character { text-align: center; margin: 30px auto 10px auto; width: 60%; font-weight: bold; text-transform: uppercase; }
    .dialogue { text-align: left; margin: 0 auto 15px auto; width: 70%; }
    .parenthetical { font-style: italic; margin: 0 auto 10px auto; width: 50%; text-align: center; }
    .transition { text-align: right; margin-right: 10%; font-weight: bold; text-transform: uppercase; }
    .active-line { background-color: rgba(255, 215, 0, 0.1); }

    body.light .toolbar {
      background-color: #e3e3e3;
      border-bottom: 2px solid #cccccc;
    }

    .toolbar button {
      background-color: #472e63;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 3px;
      min-width: 100px;
    }

    body.light .toolbar button {
      background-color: #dddddd;
      color: #000000;
    }

    .toolbar button.active {
      background-color: #6b458e;
    }

    /* Character suggestions */
    #character-suggestions {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }

    body.light #character-suggestions {
      background-color: #e3e3e3;
      border: 1px solid #000000;
    }

    .character-suggestion-item {
      padding: 5px 10px;
      cursor: pointer;
    }

    .character-suggestion-item:hover {
      background-color: #472e63;
    }

    body.light .character-suggestion-item:hover {
      background-color: #cccccc;
    }

    /* Notification */
    #notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: gold;
      color: #1c0f2e;
      padding: 10px 20px;
      border-radius: 3px;
      display: none;
      z-index: 100;
    }

    /* Modals */
    .modal-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .modal {
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 5px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
    }

    body.light .modal {
      background-color: #f8f8f8;
      border: 1px solid #000000;
    }

    .modal h2 {
      margin-top: 0;
      color: gold;
    }

    body.light .modal h2 {
      color: #000000;
    }

    .modal input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    body.light .modal input {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .cancel-btn {
      background: none;
      border: 1px solid gold;
      color: gold;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    .confirm-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    body.light .cancel-btn {
      border: 1px solid #000000;
      color: #000000;
    }

    body.light .confirm-btn {
      background-color: #000000;
      color: white;
    }

    /* Feedback box */
    #feedback-box {
      display: none;
      margin: 10px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    #feedback-text {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    body.light #feedback-text {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    #send-feedback-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 3px;
    }

    body.light #send-feedback-btn {
      background-color: #000000;
      color: white;
    }
    
    /* Transition dropdown */
    #transition-dropdown {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 250px;
      width: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .transition-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .transition-item:hover {
      background-color: #472e63;
    }
    
    body.light #transition-dropdown {
      background-color: #f8f8f8;
      border: 1px solid #000;
    }
    
    body.light .transition-item:hover {
      background-color: #ddd;
    }

    /* Character suggestion styling */
    .character-suggestion {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      padding: 5px 0;
    }

    .character-suggestion div {
      padding: 5px 10px;
      cursor: pointer;
    }

    .character-suggestion div:hover {
      background-color: #472e63;
    }

    body.light .character-suggestion {
      background-color: #e3e3e3;
      border: 1px solid #000000;
    }

    body.light .character-suggestion div:hover {
      background-color: #cccccc;
    }
  </style>
</head>
<body class="dark-mode">
  <!-- Header -->
  <div class="app-header">
    <div class="app-name">Fade Out</div>
    <div class="tagline">Write. Rewrite. Fade Out.</div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div>
      <button id="scene-heading-btn" class="element-button active" data-type="scene-heading">SCENE HEADING</button>
      <button id="action-btn" class="element-button" data-type="action">ACTION</button>
      <button id="character-btn" class="element-button" data-type="character">CHARACTER</button>
      <button id="dialogue-btn" class="element-button" data-type="dialogue">DIALOGUE</button>
      <button id="parenthetical-btn" class="element-button" data-type="parenthetical">PARENTHETICAL</button>
      <button id="transition-btn" class="element-button" data-type="transition">TRANSITION</button>
    </div>
    <div>
      <button id="save-btn">SAVE</button>
      <button id="load-btn">LOAD</button>
      <button id="export-btn">EXPORT</button>
      <button id="theme-toggle">LIGHT</button>
      <button id="rtl-toggle">ARABIC</button>
      <button id="feedback-btn">FEEDBACK</button>
      <button id="share-btn">SHARE</button>
    </div>
  </div>

  <!-- Editor - Blank -->
  <div id="editor" class="ltr" contenteditable="true" spellcheck="true" data-current-element="scene-heading">
  </div>

  <!-- Character suggestions -->
  <div id="character-suggestions"></div>
  
  <!-- Transition dropdown -->
  <div id="transition-dropdown">
    <div class="transition-item" data-text="CUT TO:">CUT TO:</div>
    <div class="transition-item" data-text="FADE IN:">FADE IN:</div>
    <div class="transition-item" data-text="FADE OUT:">FADE OUT:</div>
    <div class="transition-item" data-text="FADE TO:">FADE TO:</div>
    <div class="transition-item" data-text="DISSOLVE TO:">DISSOLVE TO:</div>
    <div class="transition-item" data-text="BACK TO:">BACK TO:</div>
    <div class="transition-item" data-text="MATCH CUT TO:">MATCH CUT TO:</div>
    <div class="transition-item" data-text="JUMP CUT TO:">JUMP CUT TO:</div>
  </div>
  
  <!-- Notification -->
  <div id="notification">Notification Message</div>
  
  <!-- Feedback box -->
  <div id="feedback-box">
    <textarea id="feedback-text" placeholder="Enter your feedback here..."></textarea>
    <button id="send-feedback-btn">Send Feedback</button>
  </div>
  
  <!-- Save Modal -->
  <div class="modal-container" id="save-modal-container">
    <div class="modal">
      <h2>Save Script</h2>
      <input type="text" id="script-title" placeholder="Script Title">
      <div class="modal-buttons">
        <button class="cancel-btn" id="save-cancel">Cancel</button>
        <button class="confirm-btn" id="save-confirm">Save</button>
      </div>
    </div>
  </div>
  
  <!-- Load Modal -->
  <div class="modal-container" id="load-modal-container">
    <div class="modal">
      <h2>Load Script</h2>
      <div id="saved-scripts-list" style="max-height: 200px; overflow-y: auto; margin: 10px 0;"></div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="load-cancel">Cancel</button>
        <button class="confirm-btn" id="load-confirm">Load</button>
      </div>
    </div>
  </div>
  
  <!-- Share Modal -->
  <div class="modal-container" id="share-modal-container">
    <div class="modal">
      <h2>Share Script</h2>
      <input type="text" id="share-link" readonly placeholder="Share link will appear here">
      <div class="modal-buttons">
        <button class="cancel-btn" id="share-cancel">Close</button>
        <button class="confirm-btn" id="copy-link">Copy Link</button>
      </div>
    </div>
  </div>

  <script>
    // Script for the screenplay editor functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Global state
      let currentElement = 'scene-heading';
      let isRtlMode = false;
      
      // DOM elements
      const editor = document.getElementById('editor');
      const elementButtons = document.querySelectorAll('.element-button');
      const characterSuggestions = document.getElementById('character-suggestions');
      const transitionDropdown = document.getElementById('transition-dropdown');
      const notification = document.getElementById('notification');
      const saveModalContainer = document.getElementById('save-modal-container');
      const loadModalContainer = document.getElementById('load-modal-container');
      const shareModalContainer = document.getElementById('share-modal-container');
      const feedbackBox = document.getElementById('feedback-box');
      
      // Initialize editor if empty
      if (editor.children.length === 0) {
        const sceneHeading = document.createElement('div');
        sceneHeading.className = 'element scene-heading';
        sceneHeading.id = 'element-1';
        sceneHeading.textContent = 'INT. ';
        editor.appendChild(sceneHeading);
        
        // Set focus to the new element
        setFocusToEnd(sceneHeading);
      }
      
      // Set up listeners
      setupListeners();
      
      // Function to set up all event listeners
      function setupListeners() {
        // Element type buttons
        elementButtons.forEach(button => {
          button.addEventListener('click', function() {
            elementButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            currentElement = this.dataset.type;
            editor.dataset.currentElement = currentElement;
          });
        });
        
        // Editor click event
        editor.addEventListener('click', function(e) {
          const clickedElement = getClickedElement(e.target);
          if (clickedElement) {
            updateActiveLine(clickedElement);
            
            // Update current element type based on clicked element
            const elementType = getElementTypeFromClass(clickedElement);
            if (elementType) {
              currentElement = elementType;
              updateActiveButton();
            }
          }
        });
        
        // Editor keydown event
        editor.addEventListener('keydown', function(e) {
          const activeElement = document.querySelector('.active-line');
          
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleEnterKey();
          } else if (e.key === 'Tab') {
            e.preventDefault();
            cycleElementType();
          }
          
          // Character suggestions
          if (activeElement && currentElement === 'character') {
            setTimeout(() => {
              const text = activeElement.textContent?.trim().toUpperCase() || '';
              if (text.length >= 2) {
                showCharacterSuggestions(text, activeElement);
              } else {
                hideCharacterSuggestions();
              }
            }, 10);
          }
          
          // Transition dropdown
          if (activeElement && currentElement === 'transition' && e.key === ' ') {
            showTransitionDropdown(activeElement);
          }
        });
        
        // Editor input event for auto-formatting
        editor.addEventListener('input', function() {
          const activeElement = document.querySelector('.active-line');
          if (!activeElement) return;
          
          const elementType = getElementTypeFromClass(activeElement);
          if (!elementType) return;
          
          // Auto-uppercase for scene heading, character, and transition
          if (elementType === 'scene-heading' || elementType === 'character' || elementType === 'transition') {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return;
            
            const range = selection.getRangeAt(0);
            const cursorPosition = range.startOffset;
            
            // Store the current text
            const originalText = activeElement.textContent || '';
            
            // Update to uppercase
            activeElement.textContent = originalText.toUpperCase();
            
            // Restore cursor position
            setCaretPosition(activeElement, cursorPosition);
          }
          
          // Auto-format parenthetical
          if (elementType === 'parenthetical') {
            const text = activeElement.textContent || '';
            if (!text.startsWith('(')) {
              activeElement.textContent = '(' + text;
              setCaretPosition(activeElement, text.length + 1);
            }
            if (text.length > 1 && !text.endsWith(')')) {
              if (!text.endsWith(' ')) {
                activeElement.textContent = text + ')';
                setCaretPosition(activeElement, text.length);
              }
            }
          }
        });
        
        // Action buttons
        document.getElementById('save-btn').addEventListener('click', function() {
          saveModalContainer.style.display = 'flex';
        });
        
        document.getElementById('load-btn').addEventListener('click', function() {
          const savedScriptsList = document.getElementById('saved-scripts-list');
          savedScriptsList.innerHTML = '';
          
          // Get saved scripts from localStorage
          const savedScripts = getSavedScripts();
          
          if (Object.keys(savedScripts).length === 0) {
            savedScriptsList.innerHTML = '<div style="padding: 10px;">No saved scripts found.</div>';
          } else {
            // Create list of saved scripts
            for (const title in savedScripts) {
              const scriptItem = document.createElement('div');
              scriptItem.style.padding = '10px';
              scriptItem.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
              scriptItem.style.cursor = 'pointer';
              
              const scriptDate = new Date(savedScripts[title].timestamp);
              const dateStr = scriptDate.toLocaleDateString() + ' ' + scriptDate.toLocaleTimeString();
              
              scriptItem.innerHTML = `
                <div>${title}</div>
                <div style="font-size: 12px; opacity: 0.7;">${dateStr}</div>
              `;
              
              scriptItem.addEventListener('click', function() {
                // Highlight selected script
                const allItems = savedScriptsList.querySelectorAll('div');
                allItems.forEach(item => item.style.backgroundColor = 'transparent');
                scriptItem.style.backgroundColor = 'rgba(255,255,255,0.1)';
                
                // Store selected title
                savedScriptsList.dataset.selectedScript = title;
              });
              
              savedScriptsList.appendChild(scriptItem);
            }
          }
          
          loadModalContainer.style.display = 'flex';
        });
        
        document.getElementById('export-btn').addEventListener('click', function() {
          exportScript();
        });
        
        document.getElementById('theme-toggle').addEventListener('click', function() {
          toggleTheme();
        });
        
        document.getElementById('rtl-toggle').addEventListener('click', function() {
          toggleDirection();
        });
        
        document.getElementById('feedback-btn').addEventListener('click', function() {
          toggleFeedback();
        });
        
        document.getElementById('share-btn').addEventListener('click', function() {
          // Generate a share link
          const shareLink = window.location.href;
          document.getElementById('share-link').value = shareLink;
          shareModalContainer.style.display = 'flex';
        });
        
        // Modal button handlers
        document.getElementById('save-cancel').addEventListener('click', function() {
          saveModalContainer.style.display = 'none';
        });
        
        document.getElementById('save-confirm').addEventListener('click', function() {
          const title = document.getElementById('script-title').value || 'Untitled Script';
          saveScript(title);
          saveModalContainer.style.display = 'none';
        });
        
        document.getElementById('load-cancel').addEventListener('click', function() {
          loadModalContainer.style.display = 'none';
        });
        
        document.getElementById('load-confirm').addEventListener('click', function() {
          const selectedScript = document.getElementById('saved-scripts-list').dataset.selectedScript;
          if (selectedScript) {
            loadScript(selectedScript);
          }
          loadModalContainer.style.display = 'none';
        });
        
        document.getElementById('share-cancel').addEventListener('click', function() {
          shareModalContainer.style.display = 'none';
        });
        
        document.getElementById('copy-link').addEventListener('click', function() {
          const linkInput = document.getElementById('share-link');
          linkInput.select();
          document.execCommand('copy');
          showNotification('Link copied to clipboard!');
        });
        
        document.getElementById('send-feedback-btn').addEventListener('click', function() {
          const feedback = document.getElementById('feedback-text').value;
          if (feedback.trim()) {
            // Send feedback (would be implemented to connect to backend)
            document.getElementById('feedback-text').value = '';
            feedbackBox.style.display = 'none';
            showNotification('Feedback sent! Thank you.');
          }
        });
        
        // Close dropdowns and suggestions when clicking outside
        document.addEventListener('click', function(e) {
          if (!e.target.closest('#character-suggestions') && !e.target.closest('.character')) {
            hideCharacterSuggestions();
          }
          
          if (!e.target.closest('#transition-dropdown') && !e.target.closest('.transition')) {
            hideTransitionDropdown();
          }
        });
      }
      
      // Insert a new element of the specified type
      function addNewElement(type, text = '') {
        const activeElement = document.querySelector('.active-line');
        const newElement = document.createElement('div');
        newElement.className = `element ${type}`;
        newElement.id = `element-${Date.now()}`;
        
        // Set text if provided, otherwise set default for element type
        if (text) {
          newElement.textContent = text;
        } else if (type === 'parenthetical') {
          newElement.textContent = '()';
        } else if (type === 'scene-heading') {
          newElement.textContent = 'INT. ';
        }
        
        if (activeElement) {
          activeElement.classList.remove('active-line');
          activeElement.after(newElement);
        } else {
          editor.appendChild(newElement);
        }
        
        newElement.classList.add('active-line');
        setFocusToEnd(newElement);
        currentElement = type;
        updateActiveButton();
        
        return newElement;
      }
      
      // Handle Enter key to create new elements based on context
      function handleEnterKey() {
        let nextElementType;
        
        switch (currentElement) {
          case 'scene-heading':
            nextElementType = 'action';
            break;
          case 'action':
            nextElementType = 'action';
            break;
          case 'character':
            nextElementType = 'dialogue';
            break;
          case 'dialogue':
            nextElementType = 'action';
            break;
          case 'parenthetical':
            nextElementType = 'dialogue';
            break;
          case 'transition':
            nextElementType = 'scene-heading';
            break;
          default:
            nextElementType = 'action';
        }
        
        addNewElement(nextElementType);
      }
      
      // Cycle through element types on Tab key
      function cycleElementType() {
        const activeElement = document.querySelector('.active-line');
        if (!activeElement) return currentElement;
        
        const types = ['scene-heading', 'action', 'character', 'parenthetical', 'dialogue', 'transition'];
        const currentIndex = types.indexOf(currentElement);
        const nextIndex = (currentIndex + 1) % types.length;
        currentElement = types[nextIndex];
        
        // Change the class of the active element
        removeElementTypeClasses(activeElement);
        activeElement.classList.add(currentElement);
        
        updateActiveButton();
        return currentElement;
      }
      
      // Update active button in toolbar
      function updateActiveButton() {
        elementButtons.forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.type === currentElement) {
            btn.classList.add('active');
          }
        });
      }
      
      // Set focus to end of element
      function setFocusToEnd(el) {
        el.focus();
        
        // Set cursor at the end
        const range = document.createRange();
        const selection = window.getSelection();
        
        // For parentheticals, place cursor between parentheses
        if (el.classList.contains('parenthetical') && el.textContent === '()') {
          const textNode = el.firstChild;
          range.setStart(textNode, 1);
          range.setEnd(textNode, 1);
        } else {
          range.selectNodeContents(el);
          range.collapse(false);
        }
        
        selection.removeAllRanges();
        selection.addRange(range);
      }
      
      // Set caret position
      function setCaretPosition(element, position) {
        const range = document.createRange();
        const selection = window.getSelection();
        
        if (element.childNodes.length === 0) {
          element.textContent = ' ';
        }
        
        const textNode = element.firstChild;
        const length = textNode.textContent.length;
        
        // Ensure position is valid
        position = Math.min(Math.max(0, position), length);
        
        range.setStart(textNode, position);
        range.setEnd(textNode, position);
        
        selection.removeAllRanges();
        selection.addRange(range);
      }
      
      // Extract character names from the script
      function extractCharacters() {
        const characters = new Set();
        const characterElements = editor.querySelectorAll('.character');
        
        characterElements.forEach(el => {
          const name = el.textContent.trim();
          if (name) {
            characters.add(name);
          }
        });
        
        return Array.from(characters);
      }
      
      // Save script to localStorage
      function saveScript(title) {
        const scriptContent = editor.innerHTML;
        const characters = extractCharacters();
        
        // Get existing scripts
        const savedScripts = getSavedScripts();
        
        // Add new script
        savedScripts[title] = {
          content: scriptContent,
          characters: characters,
          timestamp: Date.now()
        };
        
        // Save to localStorage
        localStorage.setItem('savedScripts', JSON.stringify(savedScripts));
        showNotification('Script saved successfully!');
      }
      
      // Load script from localStorage
      function loadScript(title) {
        const savedScripts = getSavedScripts();
        if (savedScripts[title]) {
          // Create a temporary div to sanitize the content
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = savedScripts[title].content;
          
          // Remove any script tags for security
          const scripts = tempDiv.getElementsByTagName('script');
          while (scripts[0]) {
            scripts[0].parentNode.removeChild(scripts[0]);
          }
          
          // Remove event handlers
          const allElements = tempDiv.getElementsByTagName('*');
          for (let i = 0; i < allElements.length; i++) {
            const attributes = allElements[i].attributes;
            for (let j = attributes.length - 1; j >= 0; j--) {
              const attrName = attributes[j].name;
              if (attrName.startsWith('on')) {
                allElements[i].removeAttribute(attrName);
              }
            }
          }
          
          editor.innerHTML = tempDiv.innerHTML;
          showNotification('Script loaded successfully!');
        }
      }
      
      // Export script to various formats
      function exportScript() {
        const content = editor.innerHTML;
        const title = prompt('Enter a name for your exported script:', 'My Screenplay');
        
        if (!title) return;
        
        // Create a temporary link to download the file
        const link = document.createElement('a');
        
        // Create an HTML file with the script content
        const htmlContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>${title}</title>
            <style>
              body { font-family: Courier, monospace; margin: 40px; }
              .scene-heading { text-transform: uppercase; margin: 12px 0; font-weight: bold; }
              .action { margin: 12px 0; }
              .character { text-align: center; margin: 30px auto 10px auto; font-weight: bold; text-transform: uppercase; }
              .dialogue { margin: 0 auto 15px auto; width: 70%; }
              .parenthetical { font-style: italic; margin: 0 auto 10px auto; width: 50%; text-align: center; }
              .transition { text-align: right; margin-right: 10%; font-weight: bold; text-transform: uppercase; }
            </style>
          </head>
          <body>
            <h1>${title}</h1>
            ${content}
          </body>
          </html>
        `;
        
        const blob = new Blob([htmlContent], { type: 'text/html' });
        link.href = URL.createObjectURL(blob);
        link.download = `${title.replace(/\s+/g, '_')}.html`;
        link.click();
        
        showNotification('Script exported successfully!');
      }
      
      // Toggle light/dark theme
      function toggleTheme() {
        const themeButton = document.getElementById('theme-toggle');
        document.body.classList.toggle('light');
        themeButton.textContent = document.body.classList.contains('light') ? 'DARK' : 'LIGHT';
      }
      
      // Toggle RTL/LTR direction
      function toggleDirection() {
        const dirButton = document.getElementById('rtl-toggle');
        isRtlMode = !isRtlMode;
        
        if (isRtlMode) {
          editor.classList.remove('ltr');
          editor.classList.add('rtl');
          dirButton.textContent = 'ENGLISH';
        } else {
          editor.classList.remove('rtl');
          editor.classList.add('ltr');
          dirButton.textContent = 'ARABIC';
        }
        
        updateToolbarLabels();
      }
      
      // Update toolbar labels based on direction
      function updateToolbarLabels() {
        // This would be implemented to change toolbar labels based on language
      }
      
      // Update existing elements
      function updateExistingElements() {
        const elements = editor.querySelectorAll('.element');
        
        elements.forEach(element => {
          // Auto-format all elements (could be extended for additional formatting)
        });
      }
      
      // Toggle feedback box
      function toggleFeedback() {
        feedbackBox.style.display = feedbackBox.style.display === 'none' || feedbackBox.style.display === '' ? 'block' : 'none';
      }
      
      // Show character suggestions
      function showCharacterSuggestions(text, element) {
        // Get list of characters from existing elements
        const characters = extractCharacters();
        
        // Filter based on current text
        const matches = characters.filter(char => 
          char.includes(text) && char !== text
        );
        
        if (matches.length > 0) {
          // Show suggestions
          characterSuggestions.innerHTML = '';
          const rect = element.getBoundingClientRect();
          
          characterSuggestions.style.top = `${rect.bottom}px`;
          characterSuggestions.style.left = `${rect.left}px`;
          characterSuggestions.style.display = 'block';
          
          matches.forEach(match => {
            const item = document.createElement('div');
            item.className = 'character-suggestion-item';
            item.textContent = match;
            item.addEventListener('click', function() {
              element.textContent = match;
              hideCharacterSuggestions();
              
              // Move to dialogue after selecting character
              currentElement = 'dialogue';
              updateActiveButton();
              addNewElement('dialogue');
            });
            characterSuggestions.appendChild(item);
          });
        } else {
          hideCharacterSuggestions();
        }
      }
      
      // Hide character suggestions
      function hideCharacterSuggestions() {
        characterSuggestions.style.display = 'none';
      }
      
      // Show transition dropdown
      function showTransitionDropdown(element) {
        const rect = element.getBoundingClientRect();
        transitionDropdown.style.top = `${rect.bottom}px`;
        transitionDropdown.style.left = `${rect.left}px`;
        transitionDropdown.style.display = 'block';
        
        const items = transitionDropdown.querySelectorAll('.transition-item');
        items.forEach(item => {
          item.onclick = function() {
            element.textContent = this.dataset.text;
            hideTransitionDropdown();
          };
        });
        
        // Add click outside listener
        document.addEventListener('click', hideTransitionDropdownOnClickOutside);
      }
      
      // Hide transition dropdown
      function hideTransitionDropdown() {
        transitionDropdown.style.display = 'none';
        document.removeEventListener('click', hideTransitionDropdownOnClickOutside);
      }
      
      // Hide transition dropdown when clicking outside
      function hideTransitionDropdownOnClickOutside(e) {
        if (!transitionDropdown.contains(e.target)) {
          hideTransitionDropdown();
        }
      }
      
      // Show notification
      function showNotification(message) {
        notification.textContent = message;
        notification.style.display = 'block';
        
        // Hide after 3 seconds
        setTimeout(function() {
          notification.style.display = 'none';
        }, 3000);
      }
      
      // Helper functions
      function getClickedElement(target) {
        if (target === editor) {
          return null;
        }
        
        if (target.classList.contains('element')) {
          return target;
        }
        
        const parent = target.closest('.element');
        return parent;
      }
      
      function updateActiveLine(element) {
        // Remove active line class from all elements
        const elements = editor.querySelectorAll('.element');
        elements.forEach(el => el.classList.remove('active-line'));
        
        // Add active line class to current element
        if (element) {
          element.classList.add('active-line');
        }
      }
      
      function getElementTypeFromClass(element) {
        const classes = element.className.split(' ');
        const typeClasses = ['scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition'];
        
        for (const cls of classes) {
          if (typeClasses.includes(cls)) {
            return cls;
          }
        }
        
        return null;
      }
      
      function removeElementTypeClasses(element) {
        element.classList.remove('scene-heading', 'action', 'character', 'dialogue', 'parenthetical', 'transition');
      }
      
      function getSavedScripts() {
        const scripts = localStorage.getItem('savedScripts');
        return scripts ? JSON.parse(scripts) : {};
      }
    });
  </script>
</body>
</html>
