<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fade Out</title>
  <style>
    /* ALL ORIGINAL STYLES REMAIN UNCHANGED */
    body {
      background-color: #1c0f2e;
      color: white;
      font-family: Courier, monospace;
      margin: 0;
      padding: 0;
    }

    body.light {
      background-color: #f8f8f8;
      color: #000000;
    }

    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: #1c0f2e;
      color: white;
      text-align: center;
      padding: 10px 0;
      z-index: 1000;
      border-bottom: 1px solid #472e63;
      direction: ltr;
    }
    
    .app-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .tagline {
      font-size: 14px;
      opacity: 0.8;
    }

    .toolbar {
      position: fixed;
      top: 70px;
      left: 0;
      right: 0;
      background-color: #2a1240;
      border-bottom: 2px solid #472e63;
      padding: 10px;
      z-index: 999;
    }

    body.light .toolbar {
      background-color: #e3e3e3;
      border-bottom: 2px solid #cccccc;
    }

    .toolbar-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .toolbar-row:last-child {
      margin-bottom: 0;
    }

    .toolbar button {
      background-color: #472e63;
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 4px;
      cursor: pointer;
      border-radius: 3px;
      min-width: 100px;
    }

    body.light .toolbar button {
      background-color: #dddddd;
      color: #000000;
    }

    .toolbar button.active {
      background-color: #6b458e;
    }

    #editor {
      padding: 130px 20px 20px 20px;
      outline: none;
      white-space: pre-wrap;
      min-height: 80vh;
    }

    body[dir="rtl"] .toolbar {
      direction: rtl;
    }
    
    body[dir="rtl"] .toolbar button {
      float: right;
    }
    
    .rtl {
      direction: rtl;
    }

    .line { margin: 0; padding: 2px 0; }
    .scene-heading { text-transform: uppercase; margin: 12px 0; text-align: left; font-weight: bold; }
    .action { text-align: left; margin: 12px 0; }
    .character { text-align: center; margin: 30px auto 10px auto; width: 60%; font-weight: bold; text-transform: uppercase; }
    .dialogue { text-align: left; margin: 0 auto 15px auto; width: 70%; }
    .parenthetical { font-style: italic; margin: 0 auto 10px auto; width: 50%; text-align: center; }
    .transition { text-align: right; margin-right: 10%; font-weight: bold; text-transform: uppercase; }
    .active-line { background-color: rgba(255, 215, 0, 0.1); }

    #character-suggestions {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }

    body.light #character-suggestions {
      background-color: #e3e3e3;
      border: 1px solid #000000;
    }

    .character-suggestion-item {
      padding: 5px 10px;
      cursor: pointer;
    }

    .character-suggestion-item:hover {
      background-color: #472e63;
    }

    body.light .character-suggestion-item:hover {
      background-color: #cccccc;
    }

    #transition-dropdown {
      position: absolute;
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 3px;
      max-height: 200px;
      width: 150px;
      overflow-y: auto;
      z-index: 999;
      display: none;
    }

    .transition-item {
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    }

    .transition-item:hover {
      background-color: #472e63;
    }

    #notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: gold;
      color: #1c0f2e;
      padding: 10px 20px;
      border-radius: 3px;
      display: none;
      z-index: 100;
    }

    .modal-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .modal {
      background-color: #2a1240;
      border: 1px solid gold;
      border-radius: 5px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
    }

    body.light .modal {
      background-color: #f8f8f8;
      border: 1px solid #000000;
    }

    .modal h2 {
      margin-top: 0;
      color: gold;
    }

    body.light .modal h2 {
      color: #000000;
    }

    .modal input, .modal textarea {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    body.light .modal input, body.light .modal textarea {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .cancel-btn {
      background: none;
      border: 1px solid gold;
      color: gold;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    .confirm-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      border-radius: 3px;
      cursor: pointer;
    }

    body.light .cancel-btn {
      border: 1px solid #000000;
      color: #000000;
    }

    body.light .confirm-btn {
      background-color: #000000;
      color: white;
    }

    #feedback-box {
      display: none;
      margin: 10px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    #feedback-text {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 3px;
      border: 1px solid gold;
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }

    body.light #feedback-text {
      border: 1px solid #000000;
      background-color: white;
      color: #000000;
    }

    #send-feedback-btn {
      background-color: gold;
      color: #1c0f2e;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 3px;
    }

    body.light #send-feedback-btn {
      background-color: #000000;
      color: white;
    }

    /* NEW: Title Page Styles */
    .title-page {
      padding: 130px 20px 20px 20px;
      display: none;
    }
    
    .title-page h1 {
      text-align: center;
      margin-bottom: 100px;
      font-size: 24px;
      text-transform: uppercase;
    }
    
    .title-page .written-by {
      text-align: center;
      margin: 40px 0;
    }
    
    .title-page .contact-info {
      position: absolute;
      bottom: 40px;
      left: 20px;
      right: 20px;
      text-align: center;
      font-size: 14px;
    }
    
    .title-page .awards {
      margin: 30px auto;
      width: 80%;
      text-align: center;
    }
    
    .title-page .copyright {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      text-align: center;
      font-size: 12px;
    }
  </style>
</head>
<body class="dark-mode">
  <!-- HEADER -->
  <div class="app-header">
    <div class="app-name">Fade Out</div>
    <div class="tagline">Write. Rewrite. Fade Out.</div>
  </div>

  <!-- TOOLBAR - UNCHANGED -->
  <div class="toolbar">
    <div class="toolbar-row">
      <button id="scene-heading-btn" class="element-button active" data-type="scene-heading">SCENE HEADING</button>
      <button id="action-btn" class="element-button" data-type="action">ACTION</button>
      <button id="character-btn" class="element-button" data-type="character">CHARACTER</button>
      <button id="dialogue-btn" class="element-button" data-type="dialogue">DIALOGUE</button>
      <button id="parenthetical-btn" class="element-button" data-type="parenthetical">PARENTHETICAL</button>
      <button id="transition-btn" class="element-button" data-type="transition">TRANSITION</button>
    </div>
    <div class="toolbar-row">
      <button id="save-btn">SAVE</button>
      <button id="load-btn">LOAD</button>
      <button id="export-btn">EXPORT</button>
      <button id="theme-toggle">LIGHT</button>
      <button id="rtl-toggle">ARABIC</button>
      <button id="title-page-btn">TITLE PAGE</button>
      <button id="feedback-btn">FEEDBACK</button>
    </div>
  </div>

  <!-- EDITOR -->
  <div id="editor" class="editor" contenteditable="true">
    <div class="line scene-heading active-line" contenteditable="true" data-type="scene-heading">INT. </div>
  </div>

  <!-- NEW: TITLE PAGE -->
  <div id="title-page" class="title-page">
    <h1 contenteditable="true">SCREENPLAY TITLE</h1>
    <div class="written-by" contenteditable="true">Written by<br>Writer Name</div>
    <div class="awards" contenteditable="true">
      Winner, Best Screenplay - Sundance Film Festival<br>
      Finalist, Nicholl Fellowship
    </div>
    <div class="contact-info" contenteditable="true">
      writer@email.com | (555) 123-4567
    </div>
    <div class="copyright" contenteditable="true">
      Â© 2025 by Writer Name. All rights reserved.
    </div>
  </div>

  <!-- EXISTING ELEMENTS -->
  <div id="character-suggestions"></div>
  <div id="transition-dropdown">
    <div class="transition-item" data-text="CUT TO:">CUT TO:</div>
    <div class="transition-item" data-text="FADE IN:">FADE IN:</div>
    <div class="transition-item" data-text="FADE OUT:">FADE OUT:</div>
    <div class="transition-item" data-text="FADE TO:">FADE TO:</div>
    <div class="transition-item" data-text="DISSOLVE TO:">DISSOLVE TO:</div>
    <div class="transition-item" data-text="BACK TO:">BACK TO:</div>
    <div class="transition-item" data-text="MATCH CUT TO:">MATCH CUT TO:</div>
    <div class="transition-item" data-text="JUMP CUT TO:">JUMP CUT TO:</div>
  </div>
  <div id="notification">Notification Message</div>
  <div id="feedback-box">
    <textarea id="feedback-text" placeholder="Enter your feedback here..."></textarea>
    <button id="send-feedback-btn">Send Feedback</button>
  </div>
  
  <!-- MODALS -->
  <div class="modal-container" id="save-modal-container">
    <div class="modal">
      <h2>Save Script</h2>
      <input type="text" id="script-title" placeholder="Script Title">
      <div class="modal-buttons">
        <button class="cancel-btn" id="save-cancel">Cancel</button>
        <button class="confirm-btn" id="save-confirm">Save</button>
      </div>
    </div>
  </div>
  
  <div class="modal-container" id="load-modal-container">
    <div class="modal">
      <h2>Load Script</h2>
      <div id="saved-scripts-list" style="max-height: 200px; overflow-y: auto; margin: 10px 0;"></div>
      <div class="modal-buttons">
        <button class="cancel-btn" id="load-cancel">Cancel</button>
        <button class="confirm-btn" id="load-confirm">Load</button>
      </div>
    </div>
  </div>
  
  <div class="modal-container" id="share-modal-container">
    <div class="modal">
      <h2>Share Script</h2>
      <input type="text" id="share-link" readonly placeholder="Share link will appear here">
      <div class="modal-buttons">
        <button class="cancel-btn" id="share-cancel">Close</button>
        <button class="confirm-btn" id="copy-link">Copy Link</button>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let currentElement = 'scene-heading';
    let isRtlMode = false;
    let scriptCharacters = new Set(['ALEX', 'BARISTA']);
    let hasTitlePage = false;

    // DOM references
    let editor, notification, titlePage;

    // Initialize editor
    document.addEventListener('DOMContentLoaded', function() {
      // Get DOM elements
      editor = document.getElementById('editor');
      notification = document.getElementById('notification');
      titlePage = document.getElementById('title-page');
      
      // Set up event listeners
      setupEventListeners();
      
      // Set up transition dropdown
      setupTransitionDropdown();
    });

    // Main setup function
    function setupEventListeners() {
      // Element type buttons
      document.querySelectorAll('.element-button').forEach(btn => {
        btn.addEventListener('click', function() {
          // Skip transition button as it has special handling
          if (this.dataset.type === 'transition') return;
          
          // Set active element type
          currentElement = this.dataset.type;
          
          // Update active button styling
          document.querySelectorAll('.element-button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Insert new element
          addNewElement(currentElement);
        });
      });
      
      // Theme toggle button
      document.getElementById('theme-toggle').addEventListener('click', function() {
        document.body.classList.toggle('light');
        this.textContent = document.body.classList.contains('light') ? 'DARK' : 'LIGHT';
      });
      
      // RTL toggle button
      document.getElementById('rtl-toggle').addEventListener('click', function() {
        isRtlMode = !isRtlMode;
        document.body.setAttribute('dir', isRtlMode ? 'rtl' : 'ltr');
        this.textContent = isRtlMode ? 'ENGLISH' : 'ARABIC';
        
        // Update existing elements
        document.querySelectorAll('#editor .line').forEach(el => {
          el.setAttribute('dir', isRtlMode ? 'rtl' : 'ltr');
          
          // Adjust alignment for transitions
          if (el.dataset.type === 'transition') {
            el.style.textAlign = 'right';
          }
        });
      });
      
      // Title page button
      document.getElementById('title-page-btn').addEventListener('click', function() {
        hasTitlePage = !hasTitlePage;
        if (hasTitlePage) {
          editor.style.display = 'none';
          titlePage.style.display = 'block';
          this.textContent = 'BACK TO SCRIPT';
        } else {
          editor.style.display = 'block';
          titlePage.style.display = 'none';
          this.textContent = 'TITLE PAGE';
        }
      });
      
      // Editor keyboard events
      editor.addEventListener('keydown', function(e) {
        // Enter key handling
        if (e.key === 'Enter') {
          e.preventDefault();
          handleEnterKey();
        }
        // Tab key for cycling elements
        else if (e.key === 'Tab') {
          e.preventDefault();
          cycleElementType();
        }
      });
      
      // Editor click handling
      editor.addEventListener('click', function(e) {
        if (e.target === editor) return;
        
        // Find closest line element
        let element = e.target;
        while (element && element !== editor && !element.classList.contains('line')) {
          element = element.parentNode;
        }
        
        if (element && element !== editor) {
          // Set active line
          document.querySelectorAll('.line').forEach(el => {
            el.classList.remove('active-line');
          });
          element.classList.add('active-line');
          
          // Update current element type
          currentElement = element.dataset.type;
          
          // Update button highlighting
          updateActiveButton();
        }
      });
    }

    // Setup transition dropdown - IMPROVED
    function setupTransitionDropdown() {
      const transitionBtn = document.getElementById('transition-btn');
      const dropdown = document.getElementById('transition-dropdown');
      
      // When transition button is clicked
      transitionBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        
        // Get active element or create new one
        let activeElement = document.querySelector('.active-line');
        if (!activeElement) {
          activeElement = addNewElement('transition');
        } else {
          // Convert to transition type
          activeElement.className = 'line transition active-line';
          activeElement.dataset.type = 'transition';
          activeElement.style.textAlign = 'right';
        }
        
        // Update current element reference
        currentElement = 'transition';
        updateActiveButton();
        
        // Position dropdown near the button
        const rect = transitionBtn.getBoundingClientRect();
        dropdown.style.position = 'absolute';
        dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
        dropdown.style.left = `${rect.left + window.scrollX}px`;
        dropdown.style.display = 'block';
      });
      
      // Handle dropdown item clicks
      document.querySelectorAll('.transition-item').forEach(item => {
        item.addEventListener('click', function() {
          const activeElement = document.querySelector('.line.transition.active-line');
          if (!activeElement) return;
          
          // Set transition text
          activeElement.textContent = this.dataset.text;
          
          // Hide dropdown
          dropdown.style.display = 'none';
          
          // Move to next element
          setTimeout(() => {
            addNewElement('scene-heading');
          }, 50);
        });
      });
      
      // Close dropdown when clicking elsewhere
      document.addEventListener('click', function() {
        dropdown.style.display = 'none';
      });
    }

    // Add a new screenplay element - IMPROVED FOR FINAL DRAFT FORMATTING
    function addNewElement(type) {
      // Create new element
      const div = document.createElement('div');
      div.className = `line ${type}`;
      div.dataset.type = type;
      div.contentEditable = 'true';
      
      // Set RTL if needed
      if (isRtlMode) {
        div.setAttribute('dir', 'rtl');
      }
      
      // Default content for specific types
      if (type === 'scene-heading') {
        div.textContent = isRtlMode ? '.INT ' : 'INT. ';
      } else if (type === 'parenthetical') {
        div.textContent = '()';
      } else if (type === 'transition') {
        div.style.textAlign = 'right';
      } else {
        div.innerHTML = '&nbsp;';
      }
      
      // Get current active element
      const activeElement = document.querySelector('.active-line');
      
      // Remove active class from all elements
      document.querySelectorAll('.line').forEach(el => {
        el.classList.remove('active-line');
      });
      
      // Add active class to new element
      div.classList.add('active-line');
      
      // Insert element
      if (activeElement) {
        activeElement.insertAdjacentElement('afterend', div);
      } else {
        editor.appendChild(div);
      }
      
      // Focus on new element
      div.focus();
      placeCursorAtEnd(div);
      
      return div;
    }

    // Handle Enter key press - IMPROVED FOR FINAL DRAFT FORMATTING
    function handleEnterKey() {
      const activeElement = document.querySelector('.active-line');
      if (!activeElement) return;
      
      // Get current type
      const type = activeElement.dataset.type;
      
      // Determine next type based on Final Draft rules
      let nextType = 'action'; // Default
      
      if (type === 'scene-heading') nextType = 'action';
      else if (type === 'action') nextType = 'action'; // Continue action unless empty
      else if (type === 'character') {
        const text = activeElement.textContent.trim();
        if (text) {
          nextType = 'dialogue';
          scriptCharacters.add(text);
        } else {
          nextType = 'character';
        }
      }
      else if (type === 'dialogue') nextType = 'character';
      else if (type === 'parenthetical') nextType = 'dialogue';
      else if (type === 'transition') nextType = 'scene-heading';
      
      // Special case: empty action should become character
      if (type === 'action' && activeElement.textContent.trim() === '') {
        nextType = 'character';
      }
      
      // Create new element
      addNewElement(nextType);
      
      // Update current element type
      currentElement = nextType;
      
      // Update button styles
      updateActiveButton();
    }

    // Cycle through element types with Tab key - IMPROVED FOR FINAL DRAFT
    function cycleElementType() {
      const activeElement = document.querySelector('.active-line');
      if (!activeElement) return;
      
      // Determine next type
      const type = activeElement.dataset.type;
      let nextType = 'action';
      
      if (type === 'scene-heading') nextType = 'action';
      else if (type === 'action') nextType = 'character';
      else if (type === 'character') nextType = 'parenthetical';
      else if (type === 'parenthetical') nextType = 'dialogue';
      else if (type === 'dialogue') nextType = 'character';
      else if (type === 'transition') nextType = 'scene-heading';
      
      // Update element class
      activeElement.className = `line ${nextType} active-line`;
      activeElement.dataset.type = nextType;
      
      // Special formatting
      if (nextType === 'scene-heading' && (activeElement.textContent.trim() === '' || activeElement.textContent === '\u00A0')) {
        activeElement.textContent = isRtlMode ? '.INT ' : 'INT. ';
      } else if (nextType === 'parenthetical' && (activeElement.textContent.trim() === '' || activeElement.textContent === '\u00A0')) {
        activeElement.textContent = '()';
      } else if (nextType === 'transition') {
        activeElement.style.textAlign = 'right';
      }
      
      // Update current element type
      currentElement = nextType;
      
      // Update button styles
      updateActiveButton();
    }

    // Update active button in toolbar
    function updateActiveButton() {
      document.querySelectorAll('.element-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const activeButton = document.querySelector(`.element-button[data-type="${currentElement}"]`);
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }

    // Place cursor at the end of an element
    function placeCursorAtEnd(el) {
      if (!el) return;
      
      const range = document.createRange();
      const sel = window.getSelection();
      
      if (el.childNodes.length > 0) {
        range.setStartAfter(el.childNodes[el.childNodes.length - 1]);
      } else {
        range.setStart(el, 0);
      }
      
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
      
      el.focus();
    }
  </script>
</body>
</html>

